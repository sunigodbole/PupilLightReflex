---
title: "Pupil Trajectories in Response to Light Stimulus --  FDA Analysis"
author: "SG"
date: "`r Sys.Date()`"
output: 
  html_document:
    number_sections: true
    theme: lumen
---

# Background
Pupil size reflex to a light test is a potential test to determine if a person is under the influence of THC and can be used as a field sobriety measure. For this analysis we'll be using methods from a statistical area called functional data analysis (FDA) which allows us to model the entire trajectory of the pupil reflex for each subject and discern differences between groups in the trajectories and in specific areas of the trajectory. This is in contrast to more traditional techniques which require extracting single summary measures such as the point of minimal constriction.  

## What is Functional Data Analysis? 

Functional Data analysis (FDA) is a field of statistics that models curves or trajectories of information without extracting pre-defined specific features. It allows us examine the sources of variation of these curves (fPCA), how differences in the patterns of the curves relate to an outcome, and how the patterns of the curves differ based on individual characteristics.   

## Data summary
Full pupil trajectories of pupil size during light reflex test. Pupil size was extracted at the image level based on image analysis techniques (Ben Steinhart's video segmentation pipeline). Each test was performed simultaneously on right and left eye before and after THC use (smoking).

+ Outcome: percent change from baseline
+ Start at frame 0 
+ End of test is not strictly defined (with FoS we shouldn't need to define the end of the test)
+ **Analysis to focus on data from second assessment (after THC use for smokers) of right eye**


## Summary of Findings



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(openxlsx)
library(ggplot2)
library(table1)
library(refund)
library(refund.shiny)
library(pROC)
library(stringr)
library(PerformanceAnalytics)
library(mgcv)
library(grid)
library(gridExtra)

# ps_folder <- "C:/Repositories/Dissertation/PupilSize_img"
# data_folder <- "C:/Users/Suneeta/OneDrive - The University of Colorado Denver/FDA/Data" # Home laptop
data_folder <- "C:/Users/godbolsu/OneDrive - The University of Colorado Denver/FDA/Data" # Work laptop
# data_folder <- "C:/Users/godbolsu/OneDrive - The University of Colorado Denver/FDA/Data"
ps_folder <- "202208_PupilLightReflex"
```


```{r dataReadIn, echo=FALSE}
ps <- read.csv(file.path(data_folder, ps_folder, "pupil_data_with_demo_20220926.csv"))

ps$demo_gender <- factor(ps$demo_gender, 
                         levels = c(1,2), 
                         labels = c("Male", "Female"))

ps$user_cat <- NA
ps$user_cat[ps$user_type == "non-user"] <- 0
ps$user_cat[ps$user_type == "occasional"] <- 1
ps$user_cat[ps$user_type == "daily"] <- 2

ps$user_cat <- factor(ps$user_cat, 
                      levels = c(0,1,2), 
                      labels = c("non-user", 
                                 "occasional", 
                                 "daily"))

ps$tp <- NA
ps$tp[ps$time == "pre2"] <- 0
ps$tp[ps$time == "post"] <- 1

ps$tp <- factor(ps$tp, 
                levels = c(0,1), 
                labels = c("pre2", "post"))
```

```{r pt_summ, echo=FALSE}
# total number of subjects
# length(unique(ps$subject_id))

# subject level data 
pt.df <- unique(ps[, c("subject_id", "tp", "user_cat", "demo_age", 
                "demo_weight", "demo_height", "demo_gender", "thc")])

# # Demographics Table by User Category
# table1(~ demo_age + demo_weight + demo_height + demo_gender|user_cat, 
#        data = pt.df[pt.df$tp == "pre2", ])

# number of subjects by timepoint (pre/post)
# table(pt.df$tp)
```

```{r scalarFeat, echo=FALSE}
scalar.feat <- read.csv(file.path(data_folder, ps_folder, "scalars_trim.csv"), 
                        header = T, stringsAsFactors = F)

scalar.feat$subject_id <- substr(scalar.feat$timeid, 1, 7)
scalar.feat$tp <- substr(scalar.feat$timeid, 8, 11)

scalar.featR <- scalar.feat[scalar.feat$eye == "Right", ]

pt.df <- merge(pt.df, scalar.featR[, c("subject_id", "tp", "min_constriction", 
                                       "duration", "avg_end_percent", "slope", 
                                       "AUC", "eye")], 
               by = c("subject_id", "tp"))

```

```{r ptdf_reshape, echo=FALSE}
pt.df.w <- reshape(pt.df, 
                   timevar = "tp", 
                   idvar = c("subject_id", "user_cat", "demo_age", 
                             "demo_weight", "demo_height", "demo_gender", "eye"), 
                   direction = "wide")
pt.df.w$thc.post[pt.df.w$user_cat == "non-user" & is.na(pt.df.w$thc.post)] <- 0
pt.df.w$thc_chg <- pt.df.w$thc.post - pt.df.w$thc.pre2
pt.df.w$BMI <- pt.df.w$demo_weight*703/(pt.df.w$demo_height)^2
pt.df.w$min_constriction_chg <- pt.df.w$min_constriction.post - pt.df.w$min_constriction.pre2
pt.df.w$AUC_chg <- pt.df.w$AUC.post - pt.df.w$AUC.pre2
pt.df.w$duration_chg <- pt.df.w$duration.post - pt.df.w$duration.pre2
pt.df.w$avg_end_percent_chg <- pt.df.w$avg_end_percent.post - pt.df.w$avg_end_percent.pre2
pt.df.w$slope_chg <-  pt.df.w$slope.post - pt.df.w$slope.pre2
```


```{r readIn_testTimes, echo=FALSE}
## Need to work on; time formatted in Excel file.
testTimes <- read.xlsx(file.path(data_folder, ps_folder, "All SafetyScan Times_23Aug2022_revSG.xlsx"), 
                       sheet = "Raw")

testTimes$pre_safetyscan_date_convert <- as.Date(testTimes$pre_safetyscan_date, origin = "1899-12-30")

testTimes$pre_safetyscan_time_convert <- as.POSIXct(paste0(testTimes$pre_safetyscan_date_convert, " ", testTimes$pre_safetyscan_time_hr, ":", testTimes$pre_safetyscan_time_min, ":", "00"), format = "%Y-%m-%d %H:%M:%S")

testTimes$consump_start_time_convert <- as.POSIXct(paste0(testTimes$pre_safetyscan_date_convert, " ", testTimes$consump_start_time_hr, ":", testTimes$consump_start_time_min, ":", "00"), format = "%Y-%m-%d %H:%M:%S")

testTimes$consump_end_time_convert <- as.POSIXct(paste0(testTimes$pre_safetyscan_date_convert, " ", testTimes$consump_end_time_hr, ":", testTimes$consump_end_time_min, ":", "00"), format = "%Y-%m-%d %H:%M:%S")

testTimes$post_safetyscan_time_convert <- as.POSIXct(paste0(testTimes$pre_safetyscan_date_convert, " ", testTimes$post_safetyscan_time_hr, ":", testTimes$post_safetyscan_time_min, ":", "00"), format = "%Y-%m-%d %H:%M:%S")

testTimes$postConsumpTimeToTest <- as.numeric(difftime(testTimes$post_safetyscan_time_convert,
                                                       testTimes$consump_end_time_convert,
                                                       units = "mins"))
testTimes$remove <- ifelse(testTimes$subject_id == "001-056" & is.na(testTimes$postConsumpTimeToTest), 1, 0)
testTimes <- testTimes[testTimes$remove == 0, ]

pt.df <- merge(pt.df.w, testTimes[, c("subject_id", "postConsumpTimeToTest")], 
               by = "subject_id")
ps <- merge(ps, testTimes[, c("subject_id", "postConsumpTimeToTest")], 
               by = "subject_id")

non_user.id <- pt.df$subject_id[pt.df$user_cat == "non-user"]
# View(testTimes[testTimes$subject_id %in% non_user.id, ])
```


```{r outliers, echo=FALSE}
## Remove known outliers
ps$outliers <- 0
# ps$outliers[ps$subject_id == "001-109" & ps$tp == "pre2"] <- 1 # Ben revised
ps$outliers[ps$subject_id == "001-060" & ps$tp == "post"] <- 1

ps <- ps[ps$outliers == 0, ]
```

# Exploratory Analysis

Plot of PRE/POST for Right Eye

We'd examined the plot for the left and right eye and found them to be similar, so for this analysis we'll used data from the right eye.

```{r rightEye_plots, echo=FALSE}
right.df <- ps[ps$eye == "Right", ]

# ggplot(right.df, aes(x=frame, y = pupil_size, group = subject_id, color = subject_id))+
#   geom_line(show.legend = FALSE)+
#   facet_grid(rows = vars(user_cat), cols = vars(tp))+
#   labs(title ="Pupil Size by Pre/Post and THC use category")+
#   theme_bw()

ggplot(right.df, aes(x=frame, y = percent_change, group = subject_id))+
  geom_line(show.legend = FALSE, alpha = 0.5)+
  facet_grid(rows = vars(user_cat), cols = vars(tp))+
  labs(title = "Percent Change by Pre/Post and THC use category")+
  theme_bw()
```

There was some attenuation of the initial light reflex response between pre and post measures in most participants, but there is a lot of variability in the recovery trajectories (both duration and shape). We'll be exploring if these differences are significantly related to the participant's THC use category and if there might be differences by smoker vs non-smoker.

Most participant's are missing data after frame 400.

```{r mean_sd_functions, include=FALSE}
right_0.df <- right.df[right.df$frame >= 0, c("subject_id", "tp", "user_cat", 
                                              "frame", "percent_change")]

right_0.df <- right_0.df[order(right_0.df$subject_id, right_0.df$tp, right_0.df$frame), ]

right_0.w <- reshape(right_0.df, 
                     timevar = "frame", 
                     idvar = c("subject_id", "tp", "user_cat"), 
                     direction = "wide")

rownames(right_0.w) <- paste0(right_0.w$subject_id, "_", right_0.w$tp)
pct_chg <- names(right_0.w[, 4:602])

mean_fxn <- as.data.frame(aggregate(right_0.w[, 4:602], 
                                    list(right_0.w$tp, 
                                         right_0.w$user_cat),
                                    FUN = function(x) mean(x, na.rm = T)))

mean_fxn.l <- reshape(mean_fxn, 
                      varying = pct_chg, 
                      v.names = "percent_change", 
                      timevar = "frame", 
                      times = pct_chg, 
                      direction = "long")
mean_fxn.l$frame <- as.numeric(gsub("percent_change.", "", mean_fxn.l$frame))
rownames(mean_fxn.l) <- NULL
mean_fxn.l$id <- NULL

names(mean_fxn.l)[names(mean_fxn.l) == "Group.1"] <- "tp"
names(mean_fxn.l)[names(mean_fxn.l) == "Group.2"] <- "user_cat"


mean_fxn.l$grp <- paste0(mean_fxn.l$tp, "_", mean_fxn.l$user_cat)

ggplot(mean_fxn.l, aes(x=frame, y = percent_change, group = grp,  
                       color = user_cat))+
  geom_line()+
  facet_grid(rows = vars(tp))+
  labs(title = "Average Percent Change by Pre/Post and THC use category")+
  theme_bw()

sd_fxn <- as.data.frame(aggregate(right_0.w[, 4:602], 
                                    list(right_0.w$tp, 
                                         right_0.w$user_cat),
                                    FUN = function(x) sd(x, na.rm = T)))

```

## Analytic Sample

There were 84 participants with both pre and post data which constituted the analytic sample. 

```{r analyticN, echo = F}
right_0.post <- right_0.df[right_0.df$tp == "post", ]
right_0.post <- right_0.post[right_0.post$frame <= 400, ]
post.ids <- unique(right_0.post$subject_id)

right_0.post <- right_0.post[order(right_0.post$subject_id, right_0.post$frame), ]
right_0.post$frame_char <- str_pad(right_0.post$frame, width = 3, side = c("left"), pad = "0")

right_0.post.w <- reshape(right_0.post[, c("subject_id","tp", "user_cat", "frame_char", "percent_change")], 
                          timevar = "frame_char", 
                          idvar = c("subject_id", "tp", "user_cat"), 
                          direction = "wide")

var.order <- c(names(right_0.post.w)[1:3], sort(names(right_0.post.w)[4:length(names(right_0.post.w))]))

right_0.post.w <- right_0.post.w[, var.order]

var.names <- names(right_0.post.w[4:ncol(right_0.post.w)])

right_0.post <- reshape(right_0.post.w, 
                        varying = var.names, 
                        v.names = "percent_change", 
                        timevar = "frame", 
                        times = 0:400,
                        idvar = c("subject_id", "tp", "user_cat"), 
                        direction = "long")


right_0.pt <- reshape(right_0.df[right_0.df$frame <= 400,], 
                      timevar = "tp", 
                      idvar = c("subject_id", "user_cat", "frame"), 
                      direction = "wide")

right_0.pt$wiPctChg <- right_0.pt$percent_change.post - right_0.pt$percent_change.pre2

right_0.pt <- right_0.pt[, c("subject_id", "user_cat", "frame", "wiPctChg")]

right_0.pt <- right_0.pt[order(right_0.pt$subject_id, right_0.pt$frame), ]
right_0.pt$frame_char <- str_pad(right_0.pt$frame, width = 3, side = c("left"), pad = "0")

right_0.pt.w <- reshape(right_0.pt[, c("subject_id","user_cat", "frame_char", "wiPctChg")], 
                     timevar = "frame_char", 
                     idvar = c("subject_id", "user_cat"), 
                     direction = "wide")
var.order2 <- c(names(right_0.pt.w)[1:2], sort(names(right_0.pt.w)[3:length(names(right_0.pt.w))]))

right_0.pt.w <- right_0.pt.w[, var.order2]

# remove rows where all data is missing (e.g. pt didn't have both pre and post)
allMissing <- rowSums(is.na(right_0.pt.w[, 3:403]))
rowsAllMissing <- names(allMissing)[allMissing == 401]

right_0.pt.w <- right_0.pt.w[!(rownames(right_0.pt.w) %in% rowsAllMissing), ]

rownames(right_0.pt.w) <- paste0(right_0.pt.w$subject_id, "_", right_0.pt.w$user_cat)

analytic.N <- post.ids[post.ids %in% right_0.pt.w$subject_id]

## Filter all datasets to analytic sample

right_0.df <- right_0.df[right_0.df$subject_id %in% analytic.N,]
right_0.post <- right_0.post[right_0.post$subject_id %in% analytic.N, ]
right_0.post.w <- right_0.post.w[right_0.post.w$subject_id %in% analytic.N ,]
row.names(right_0.post.w) <- right_0.post.w$subject_id

right_0.pt <- right_0.pt[right_0.pt$subject_id %in% analytic.N, ]
right_0.pt.w <- right_0.pt.w[right_0.pt.w$subject_id %in% analytic.N, ]
row.names(right_0.pt.w) <- right_0.pt.w$subject_id
```

## Post Data and Within Person Difference (WPD) Trajectories 

Within person difference trajectories (WPD) were calculated at a frame by frame subtraction of the pre-trajectory from the post trajectory (e.g. post - pre). 

```{r postPlot, echo = F, warning=FALSE, fig.height = 6, fig.width = 10}
post_traj <- ggplot(right_0.post, aes(x=frame, y = percent_change, group = subject_id))+
             geom_line(show.legend = FALSE, alpha = 0.5)+
             facet_grid(rows = vars(user_cat))+
             labs(title ="POST Data Percent Change by THC", 
                  y = "Percent Change")+
             theme_bw()

wi_traj <- ggplot(right_0.pt, aes(x=frame, y = wiPctChg, group = subject_id))+
           geom_line(show.legend = FALSE, alpha = 0.5)+
           facet_grid(rows = vars(user_cat))+
           labs(title ="WPD Percent Change by THC", 
                y = "WPD in Percent Change")+
           theme_bw()

grid.arrange(post_traj, wi_traj, nrow = 1)
```

Post Data: 

+ Lots of heterogeneity in the post profiles
+ Seemly like there's more variability in the recovery period for daily user (long duration)

Within Person Difference (WPD) data:

+ Lots of heterogeneity across user-groups, but a mostly positive difference (indicating a less constriction at post).
+ Non-user plot seems "centered" around 0 but still showing heterogeneity. 

```{r getLegend, echo = F}
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}
```

# Analysis

## functional Principal Components Analysis (fPCA)
Similar to PCA, fPCA is a method to quantify the sources of variation in the data. With fPCA, we're finding functions or "shapes" that describe variation. 

### fPCA post data
Truncating to frame 400

```{r fPCA_post, echo = F, fig.height = 6, fig.width = 10}
right_0.fpca <- fpca.face(Y = as.matrix(right_0.post.w[, 4:404]), pve = 0.95, knots = 30, var = T)

right_0.fpca.pve <- round(right_0.fpca$evalues/sum(right_0.fpca$evalues)*100, 2)

mu <- right_0.fpca$mu
right_sd <- sqrt(right_0.fpca$evalues)
right_Phi <- right_0.fpca$efunctions

df_plot <- data.frame(frame = seq(0, 400, by = 1), 
                      mu = mu, 
                      errband1 = 2*right_Phi[, 1]*right_sd[1], 
                      errband2 = 2*right_Phi[, 2]*right_sd[2], 
                      errband3 = 2*right_Phi[, 3]*right_sd[3], 
                      errband4 = 2*right_Phi[, 4]*right_sd[4])

colors <- c("Pop.Mean" = "black", "+2SD" = "red", "-2SD" = "blue")

plot_pc1 <- ggplot(data = df_plot, aes(x = frame, y = mu))+
  geom_line(aes(color = "Pop.Mean"))+
  geom_line(aes(x = frame, y = mu+errband1, color = "+2SD"))+
  geom_line(aes(x = frame, y = mu-errband1, color = "-2SD"))+
  labs(x = "frame", 
       y = "Percent Change", 
       color = "Legend", 
       title = paste("PC1:", "% Var Explained:", right_0.fpca.pve[1]))+
  scale_color_manual(values = colors)+
  theme_bw()

plot_pc2 <- ggplot(data = df_plot, aes(x = frame, y = mu))+
  geom_line(aes(color = "Pop.Mean"))+
  geom_line(aes(x = frame, y = mu+errband2, color = "+2SD"))+
  geom_line(aes(x = frame, y = mu-errband2, color = "-2SD"))+
  labs(x = "frame", 
       y = "Percent Change", 
       color = "Legend", 
       title = paste("PC2:", "% Var Explained:", right_0.fpca.pve[2]))+
  scale_color_manual(values = colors)+
  theme_bw()

plot_pc3 <- ggplot(data = df_plot, aes(x = frame, y = mu))+
  geom_line(aes(color = "Pop.Mean"))+
  geom_line(aes(x = frame, y = mu+errband3, color = "+2SD"))+
  geom_line(aes(x = frame, y = mu-errband3, color = "-2SD"))+
  labs(x = "frame", 
       y = "Percent Change", 
       color = "Legend", 
       title = paste("PC3:", "% Var Explained:", right_0.fpca.pve[3]))+
  scale_color_manual(values = colors)+
  theme_bw()

plot_pc4 <- ggplot(data = df_plot, aes(x = frame, y = mu))+
  geom_line(aes(color = "Pop.Mean"))+
  geom_line(aes(x = frame, y = mu+errband4, color = "+2SD"))+
  geom_line(aes(x = frame, y = mu-errband4, color = "-2SD"))+
  labs(x = "frame", 
       y = "Percent Change", 
       color = "Legend", 
       title = paste("PC4:", "% Var Explained:", right_0.fpca.pve[4]))+
  scale_color_manual(values = colors)+
  theme_bw()

legend_postPC <- g_legend(plot_pc1)

grid.arrange(plot_pc1+theme(legend.position = "none"), 
             plot_pc2+theme(legend.position = "none"), 
             plot_pc3+theme(legend.position = "none"), 
             plot_pc4+theme(legend.position = "none"),
             legend_postPC,
             layout_matrix = rbind(c(1,2,5), c(3,4,5)),
             widths = c(10, 10, 3),
             nrow = 2, ncol = 3)
```

For the post data: 

+ PC1 seems to show variation in the minimal constriction value. Participants with high loading (+2SD) on PC1 would have a less constriction while participants with a low loading (-2SD) would have a more constriction than an average individual. 

+PC2 seems to show differences in the the overall shape of the trajectory and the pattern of recovery. High loading indicates a less than average constriction and slow recovery over time (and a double dip), while a low loading indicates more than average constriction and marked recovery over the test period.

### fPCA Within Person Differences
```{r fPCA_withinPersonChange, echo=F, fig.height = 6, fig.width = 10}
right_0_wi.fpca <- fpca.face(Y = as.matrix(right_0.pt.w[, 3:403]), pve = 0.95, knots = 30, var = T)
# str(right_0.fpca)

# plot_shiny(right_0.fpca)
right_0_wi.fpca.pve <- round(right_0_wi.fpca$evalues/sum(right_0_wi.fpca$evalues)*100, 2)

mu <- right_0_wi.fpca$mu
right_sd <- sqrt(right_0_wi.fpca$evalues)
right_Phi <- right_0_wi.fpca$efunctions 

wi.df_plot <- data.frame(frame = seq(0, 400, by = 1), 
                      mu = mu, 
                      errband1 = 2*right_Phi[, 1]*right_sd[1], 
                      errband2 = 2*right_Phi[, 2]*right_sd[2], 
                      errband3 = 2*right_Phi[, 3]*right_sd[3], 
                      errband4 = 2*right_Phi[, 4]*right_sd[4], 
                      errband5 = 2*right_Phi[, 5]*right_sd[5], 
                      errband6 = 2*right_Phi[, 6]*right_sd[6])

colors <- c("Pop.Mean" = "black", "+2SD" = "red", "-2SD" = "blue")

wi.plot_pc1 <- ggplot(data = wi.df_plot, aes(x = frame, y = mu))+
  geom_line(aes(color = "Pop.Mean"))+
  geom_line(aes(x = frame, y = mu+errband1, color = "+2SD"))+
  geom_line(aes(x = frame, y = mu-errband1, color = "-2SD"))+
  labs(x = "frame", 
       y = "Difference in Percent Change", 
       color = "Legend", 
       title = paste("PC1:", "% Var Explained:", right_0_wi.fpca.pve[1]))+
  scale_color_manual(values = colors)+
  theme_bw()

wi.plot_pc2 <- ggplot(data = wi.df_plot, aes(x = frame, y = mu))+
  geom_line(aes(color = "Pop.Mean"))+
  geom_line(aes(x = frame, y = mu+errband2, color = "+2SD"))+
  geom_line(aes(x = frame, y = mu-errband2, color = "-2SD"))+
  labs(x = "frame", 
       y = "Difference in Percent Change", 
       color = "Legend", 
       title = paste("PC2:", "% Var Explained:", right_0_wi.fpca.pve[2]))+
  scale_color_manual(values = colors)+
  theme_bw()

wi.plot_pc3 <- ggplot(data = wi.df_plot, aes(x = frame, y = mu))+
  geom_line(aes(color = "Pop.Mean"))+
  geom_line(aes(x = frame, y = mu+errband3, color = "+2SD"))+
  geom_line(aes(x = frame, y = mu-errband3, color = "-2SD"))+
  labs(x = "frame", 
       y = "Difference in Percent Change", 
       color = "Legend", 
       title = paste("PC3:", "% Var Explained:", right_0_wi.fpca.pve[3]))+
  scale_color_manual(values = colors)+
  theme_bw()

wi.plot_pc4 <- ggplot(data = wi.df_plot, aes(x = frame, y = mu))+
  geom_line(aes(color = "Pop.Mean"))+
  geom_line(aes(x = frame, y = mu+errband4, color = "+2SD"))+
  geom_line(aes(x = frame, y = mu-errband4, color = "-2SD"))+
  labs(x = "frame", 
       y = "Difference in Percent Change", 
       color = "Legend", 
       title = paste("PC4:", "% Var Explained:", right_0_wi.fpca.pve[4]))+
  scale_color_manual(values = colors)+
  theme_bw()

wi.plot_pc5 <- ggplot(data = wi.df_plot, aes(x = frame, y = mu))+
  geom_line(aes(color = "Pop.Mean"))+
  geom_line(aes(x = frame, y = mu+errband5, color = "+2SD"))+
  geom_line(aes(x = frame, y = mu-errband5, color = "-2SD"))+
  labs(x = "frame", 
       y = "Difference in Percent Change", 
       color = "Legend", 
       title = paste("PC5:", "% Var Explained:", right_0_wi.fpca.pve[5]))+
  scale_color_manual(values = colors)+
  theme_bw()

wi.plot_pc6 <- ggplot(data = wi.df_plot, aes(x = frame, y = mu))+
  geom_line(aes(color = "Pop.Mean"))+
  geom_line(aes(x = frame, y = mu+errband6, color = "+2SD"))+
  geom_line(aes(x = frame, y = mu-errband6, color = "-2SD"))+
  labs(x = "frame", 
       y = "Difference in Percent Change", 
       color = "Legend", 
       title = paste("PC6:", "% Var Explained:", right_0_wi.fpca.pve[6]))+
  scale_color_manual(values = colors)+
  theme_bw()

legend_wiPC <- g_legend(wi.plot_pc1)

grid.arrange(wi.plot_pc1+theme(legend.position = "none"), 
             wi.plot_pc2+theme(legend.position = "none"), 
             wi.plot_pc3+theme(legend.position = "none"), 
             wi.plot_pc4+theme(legend.position = "none"),
             legend_wiPC,
             layout_matrix = rbind(c(1,2,5), c(3,4,5)),
             widths = c(10, 10, 3),
             nrow = 2, ncol = 3)
```

For WPD (post - pre) data: 

+ PC1 show the overall shape of the difference trajectory. High loading (+2SD) on PC1 shows less constriction at post vs pre (shown by initial positive increase) and a consistently less negative trajectory at post but the difference reducing over time. Low loading (-2SD) on PC1 shows more constriction at post vs pre. 

+ PC2 shows differences in minimal constriction and recovery. High loading on PC2 shows less constriction at post vs pre (marked) and less recovery at post. Low loading on PC2 shows more constriction at post vs pre and less recovery at pre.  

```{r wi_scores, echo = F}
wi.scores <- as.data.frame(right_0_wi.fpca$scores)
names(wi.scores) <- c("PC1", "PC2", "PC3", "PC4", "PC5", "PC6")
wi.scores$subject_id <- rownames(wi.scores)

pt.wi.scores <- merge(wi.scores, pt.df, 
                      by = "subject_id", 
                      all.x = T)

pt.wi.scores$smoker <- ifelse(pt.wi.scores$user_cat %in% c("daily", "occasional"),1, 0)
```

## AUC: Predict Smoker vs Non-smoker

```{r fpca_post, echo = F}
post_right_0.fpca <- fpca.face(Y = as.matrix(right_0.post.w[, 4:404]), pve = 0.95, knots = 30, var = T)

post_right_0.fpca.pve <- round(post_right_0.fpca$evalues/sum(post_right_0.fpca$evalues)*100, 2)
# post_right_0.fpca.pve

post_right_scores <- as.data.frame(post_right_0.fpca$scores)
names(post_right_scores) <- c("PC1", "PC2", "PC3", "PC4")
post_right_scores$subject_id <- rownames(post_right_scores)

pt.scores <- merge(post_right_scores, pt.df, 
                   by = c("subject_id"), 
                   all.x = T)

pt.scores$smoker <- ifelse(pt.scores$user_cat %in% c("daily", "occasional"),1, 0)
```

```{r auc, echo = F, message = F}
m1 <- glm(smoker ~ PC1 + PC2 + PC3 +PC4, family = "binomial", data = pt.scores)
# summary(m1)
pt.scores$pred <- predict(m1, pt.scores)
pt.scores.roc <- roc(response = pt.scores$smoker, predictor = pt.scores$pred)
# pt.scores.roc
post.auc.pc4 <- pt.scores.roc$auc

plot.roc(pt.scores.roc, main = "Prediction of Smoker by PCs and Scalar Features in Post and WPD")

m1.scalar <- glm(smoker ~ min_constriction.post + AUC.post + slope.post, family = "binomial", data = pt.scores)
# summary(m1.scalar)
pt.scores$pred <- predict(m1.scalar, pt.scores)
pt.scalar.roc <- roc(response = pt.scores$smoker, predictor = pt.scores$pred)
# pt.scalar.roc
post.auc.scalar <- pt.scalar.roc$auc
plot.roc(pt.scalar.roc, main = "", add = T, col = "darkred")

auc.df <- data.frame("Label" = c("Post AUC PCs", "Post AUC Scalar Feat"), 
                     "AUC" = c(post.auc.pc4, post.auc.scalar), 
                     stringsAsFactors = F)

### WPD rocs
m5 <- glm(smoker ~ PC1 + PC2 + PC3 +PC4, family = "binomial", data = pt.wi.scores)
# summary(m5)

pt.wi.scores$pred_sameNPC <- predict(m5, pt.wi.scores)
pt.wi.scores.roc2 <- roc(response = pt.wi.scores$smoker, 
                     predictor = pt.wi.scores$pred_sameNPC)
# pt.wi.scores.roc2
wi.auc.pcs <- pt.wi.scores.roc2$auc
auc.df <- rbind(auc.df, c("W/I Diff AUC PCS", wi.auc.pcs))

plot.roc(pt.wi.scores.roc2, 
         col = "darkblue", 
         add = T)

m5.scalar <- glm(smoker ~ min_constriction_chg + AUC_chg + slope_chg, family = "binomial", data = pt.wi.scores)
# summary(m5.scalar)

pt.wi.scores$pred_wi_scalar <- predict(m5.scalar, pt.wi.scores)
pt.wi.scalar.roc2 <- roc(response = pt.wi.scores$smoker, 
                     predictor = pt.wi.scores$pred_wi_scalar)
# pt.wi.scalar.roc2
wi.auc.scalars <- pt.wi.scalar.roc2$auc
auc.df <- rbind(auc.df, c("W/I Diff AUC Scalar Feat", wi.auc.scalars))
plot.roc(pt.wi.scalar.roc2, 
         col = "darkgreen",
         add = T)
legend(0.5, 0.35, legend = c(paste0("post PCs AUC: ",round(post.auc.pc4, 3)),
                                 paste0("post Scalar Features AUC: ",round(post.auc.scalar, 3)), 
                                 paste0("WPD PCs AUC: ", round(wi.auc.pcs, 3)),
                                 paste0("WPD Scalar Features AUC: ", round(wi.auc.scalars, 3))),
       col = c("black", "darkred", "darkblue", "darkgreen"), 
       lty = rep(1, 4), cex = 0.8, bty="n")

```

WPD = Within Person differences

For this analysis we were comparing the ability to predict smoker vs non-smoker using the first 4 PCs from the fPCA or scalar features in the post and within person difference (WPD) data. For each curve, a separate logistic regression model was fit with either the first 4 PCs from fPCA or the scalar features: minimal constriction, AUC and slope. For the WPD models the scalar feature represented the change in minimal constriction, AUC and slope. Predictions of smoker vs non-smoker were made with the logistic models and then an ROC curve was created to show the sensitivity (true positive rate) vs 1-specificity (1-true negative rate = false positive rate). Comparing the area under the curve (AUC) of the ROC curves shows the predictive ability of the each model. 

From this analysis, we can see that a model of the within person difference (WPD) with the first 4 PCs from the fPCA analysis have the highest predictive ability. 


```{r compare_auc, include = F}
auc.df$AUC <- round(as.numeric(auc.df$AUC), 3)

knitr::kable(auc.df)
```

## Association with Demographic Variables

```{r demogAssoc_prep, echo = F}
pt.scores$male <- ifelse(pt.scores$demo_gender == "Male", 1, 0)
pt.scores$non_user <- ifelse(pt.scores$user_cat == "non-user", 1, 0)
pt.scores$daily <- ifelse(pt.scores$user_cat == "daily", 1, 0)
pt.scores$occasional <- ifelse(pt.scores$user_cat == "occasional", 1, 0)


pt.wi.scores$male <- ifelse(pt.wi.scores$demo_gender == "Male", 1, 0)
pt.wi.scores$non_user <- ifelse(pt.wi.scores$user_cat == "non-user", 1, 0)
pt.wi.scores$daily <- ifelse(pt.wi.scores$user_cat == "daily", 1, 0)
pt.wi.scores$occasional <- ifelse(pt.wi.scores$user_cat == "occasional", 1, 0)

```


```{r corrPC_scalar, echo = F, eval=F}
chart.Correlation(pt.scores[, c("PC1", "PC2", "PC3", "PC4", 
                                "min_constriction.post", "duration.post", 
                                "avg_end_percent.post", "slope.post", "AUC.post")])

```


```{r corrPC_demog, echo = F, eval=F}
chart.Correlation(pt.scores[, c("PC1", "PC2", "PC3", "PC4", 
                                "demo_age","male", "thc.post", "thc_chg", "BMI", 
                                "postConsumpTimeToTest", "smoker", 
                                "non_user", "daily", "occasional")])
```


```{r corrScalar_demog, echo = F, eval=F}
chart.Correlation(pt.scores[, c("min_constriction.post", "duration.post", 
                                "avg_end_percent.post", "slope.post", "AUC.post", 
                                "demo_age","male", "thc.post", "thc_chg", "BMI", 
                                "postConsumpTimeToTest", "smoker", 
                                "non_user", "daily", "occasional")])
```

Demographic Variables:

+ Age
+ Weight
+ Height
+ BMI 
+ Change in THC
+ Time from consumption to Post test
+ Sex

Results: 

Regression models regressed demographic variables on the 4 PCs for the post data. 

+ BMI negatively associated with PC2 adjusting for other PCs (p= 0.03)

Regression models regressed demographic variables on the 6 PCs for the WPD data.

+ Weight negatively associated with PC2 &  positively associated with PC5 adjusting for other PCs (p = 0.04 & 0.009)
+ Height positively associated with PC5 adjusting for other PCs (p = 0.006)
+ BMI positively associated with PC1 adjusting for other PCs (p= 0.049)
+ Male positively associated with PC5 adjusting for other PCs (p= 0.040)


```{r demogAssoc_post, echo = F}
post.age.m <- lm(demo_age ~ PC1 + PC2 + PC3 + PC4, data = pt.scores)
# summary(post.age.m)

post.wt.m <- lm(demo_weight ~ PC1 + PC2 + PC3 + PC4, data = pt.scores)
# summary(post.wt.m)

post.ht.m <- lm(demo_height ~ PC1 + PC2 + PC3 + PC4, data = pt.scores)
# summary(post.ht.m)

post.bmi.m <- lm(BMI ~ PC1 + PC2 + PC3 + PC4, data = pt.scores)
# summary(post.bmi.m)

post.thc.m <- lm(thc_chg ~ PC1 + PC2 + PC3 + PC4, data = pt.scores)
# summary(post.thc.m)

post.consump.m <- lm(postConsumpTimeToTest ~ PC1 + PC2 + PC3 + PC4, data = pt.scores)
# summary(post.consump.m)

post.male.m <- glm(male ~ PC1 + PC2 + PC3 + PC4, family = "binomial", data = pt.scores)
# summary(post.male.m)
```

```{r wi_corrPC_scalar, echo=F, eval = F}
chart.Correlation(pt.wi.scores[, c("PC1", "PC2", "PC3", "PC4", "PC5", "PC6",
                                "min_constriction_chg", "AUC_chg", "duration_chg",
                                "avg_end_percent_chg", "slope_chg")])
```

```{r wi_corrPC_demog, echo=F, eval = F}
chart.Correlation(pt.wi.scores[, c("PC1", "PC2", "PC3", "PC4", "PC5", "PC6",
                                "demo_age","male", "thc.post", "thc_chg", "BMI", 
                                "postConsumpTimeToTest", "smoker", 
                                "non_user", "daily", "occasional")])
```

```{r wi_corrScalar_demog, echo=F, eval = F }
chart.Correlation(pt.wi.scores[, c("min_constriction_chg", "AUC_chg", "duration_chg", 
                                   "avg_end_percent_chg", "slope_chg", 
                                "demo_age","male", "thc.post", "thc_chg", "BMI", 
                                "postConsumpTimeToTest", "smoker", 
                                "non_user", "daily", "occasional")])
```

```{r demogAssoc_wi, echo=F}
wi.age.m <- lm(demo_age ~ PC1 + PC2 + PC3 + PC4 +PC5 + PC6, data = pt.wi.scores)
# summary(wi.age.m)

wi.wt.m <- lm(demo_weight ~ PC1 + PC2 + PC3 + PC4 +PC5 + PC6, data = pt.wi.scores)
# summary(wi.wt.m)

wi.ht.m <- lm(demo_height ~ PC1 + PC2 + PC3 + PC4 +PC5 + PC6, data = pt.wi.scores)
# summary(wi.ht.m)

wi.bmi.m <- lm(BMI ~ PC1 + PC2 + PC3 + PC4 +PC5 + PC6, data = pt.wi.scores)
# summary(wi.bmi.m)

wi.thc.m <- lm(thc_chg ~ PC1 + PC2 + PC3 + PC4 +PC5 + PC6, data = pt.wi.scores)
# summary(wi.thc.m)

wi.consump.m <- lm(postConsumpTimeToTest ~ PC1 + PC2 + PC3 + PC4 +PC5 + PC6, data = pt.wi.scores)
# summary(wi.consump.m)

pt.wi.scores$male <- ifelse(pt.wi.scores$demo_gender == "Male", 1, 0)

wi.male.m <- glm(male ~ PC1 + PC2 + PC3 + PC4 +PC5 + PC6, family = "binomial", data = pt.wi.scores)
# summary(wi.male.m)
```


## Function on Scalar Regression

Function on Scalar Regression (FoSR) is a regression method that regresses the full trajectory of the pupil light reflex (e.g. function) on set of scalar predictor, in this case THC user category and accounts for the between subject variability with a random effect term. This analysis allows us to examine differences in trajectories or parts of the trajectory by THC user group.   

```{r pt_analytic, echo = F}
pt.analytic.df <- pt.df[pt.df$subject_id %in% analytic.N, ]
pt.analytic.df$occasional <- ifelse(pt.analytic.df$user_cat == "occasional", 1, 0)
pt.analytic.df$daily  <- ifelse(pt.analytic.df$user_cat == "daily", 1, 0)


pt.analytic.df <- pt.analytic.df[order(pt.analytic.df$subject_id), ]
```


```{r post_gam, echo = F}
right_0.gam.df <- merge(right_0.post, pt.analytic.df, 
                        by = c("subject_id", "user_cat"))

right_0.gam.df <- right_0.gam.df[order(right_0.gam.df$subject_id, right_0.gam.df$frame), ]
right_0.gam.df$sind <- right_0.gam.df$frame/400


m.post_gam <- mgcv::gam(percent_change ~ s(sind, k=30, bs="cr") + s(sind, by=occasional, k=30, bs = "cr") + s(sind, by=daily, k=30, bs = "cr"), 
                  data = right_0.gam.df, method = "REML")

## Create a matrix of residuals
post_gam.resid <- cbind(right_0.gam.df[!(is.na(right_0.gam.df$percent_change)), c("subject_id", "frame")], m.post_gam$residuals)
names(post_gam.resid) <- c("subject_id", "frame", "resid")
post_gam.resid$frame_char <- str_pad(post_gam.resid$frame, width = 3, side = "left", pad = "0")

resid_mat <- reshape(post_gam.resid[, c("subject_id", "frame_char", "resid")], 
                     timevar = "frame_char", 
                     idvar = "subject_id", 
                     direction = "wide")
rownames(resid_mat) <- resid_mat$subject_id
resid_mat$subject_id <- NULL
resid_names <- names(resid_mat)
resid_names <- sort(resid_names)
resid_mat <- resid_mat[, resid_names]

resid_mat <- as.matrix(resid_mat)

post_gam.fpca <- fpca.face(resid_mat, knots = 15)

#Create data frame of eigen functions and attach to original data
Phi_mat <- as.data.frame(post_gam.fpca$efunctions)
colnames(Phi_mat) <- paste0("Phi", seq(1, post_gam.fpca$npc))
Phi_mat$frame <- as.numeric(rownames(Phi_mat)) -1

right_0.gam.df <- merge(right_0.gam.df, Phi_mat, 
                        by = "frame", 
                        all.x = T)
right_0.gam.df <- right_0.gam.df[order(right_0.gam.df$subject_id, right_0.gam.df$frame), ]
right_0.gam.df$subject_id <- as.factor(right_0.gam.df$subject_id)

post_gam.fri <- mgcv::bam(percent_change ~ 
                            s(sind, k=30, bs="cr") + 
                            s(sind, by=occasional, k=30, bs = "cr") + 
                            s(sind, by=daily, k=30, bs = "cr") +
                            s(subject_id, by = Phi1, bs="re") + s(subject_id, by = Phi2, bs="re")+
                            s(subject_id, by = Phi3, bs="re") + s(subject_id, by = Phi4, bs="re"), 
                          method = "fREML", data = right_0.gam.df, discrete = TRUE)


# summary(post_gam.fri)
```

```{r plot_occ, echo = F, fig.show = 'hide'}
post_gam.coef <- post_gam.fri$coefficients
post_gam.cov <- vcov.gam(post_gam.fri)

df_pred_non <- data.frame("sind" = unique(right_0.gam.df$sind), "occasional" = 0, "daily" = 0, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, 
                          "subject_id" = right_0.gam.df$subject_id[1])

lpmat_non <- predict(post_gam.fri, newdata=df_pred_non, se.fit=TRUE, type = "lpmatrix")


df_pred_occ <- data.frame("sind" = unique(right_0.gam.df$sind), "occasional" = 1, "daily" = 0, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, 
                          "subject_id" = right_0.gam.df$subject_id[1])

lpmat_occ <- predict(post_gam.fri, newdata=df_pred_occ, se.fit=TRUE, type = "lpmatrix")

df_pred_dly <- data.frame("sind" = unique(right_0.gam.df$sind), "occasional" = 0, "daily" = 1, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, 
                          "subject_id" = right_0.gam.df$subject_id[1])

lpmat_dly <- predict(post_gam.fri, newdata=df_pred_dly, se.fit=TRUE, type = "lpmatrix")


pred_df <- data.frame(frame = rep(seq(0, 400), 3),
                      user = c(rep("non-user", 401), rep("occasional", 401),rep("daily", 401)), 
                      mean = c(lpmat_non %*% post_gam.coef, 
                               lpmat_occ %*% post_gam.coef, lpmat_dly %*% post_gam.coef), 
                      se = c(sqrt(diag(lpmat_non %*% post_gam.cov %*% t(lpmat_non))), 
                             sqrt(diag(lpmat_occ %*% post_gam.cov %*% t(lpmat_occ))),
                             sqrt(diag(lpmat_dly %*% post_gam.cov %*% t(lpmat_dly)))), 
                      stringsAsFactors = F)

post_userProfile <- ggplot(data = pred_df, aes(x = frame, y = mean, group = user, col = user))+
                    geom_line()+
                    # geom_line(aes(x=frame, y = mean + 2*se, group = user, col = user), linetype = "longdash")+
                    # geom_line(aes(x=frame, y = mean - 2*se, group = user, col = user), linetype = "longdash")+
                    labs(y = "Percent Change")+
                    theme_bw()

legend_userProfile <- g_legend(post_userProfile)

post_userProfile.se <- ggplot(data = pred_df, aes(x = frame, y = mean, group = user, col = user))+
                    geom_line()+
                    geom_line(aes(x=frame, y = mean + 2*se, group = user, col = user), linetype = "longdash")+
                    geom_line(aes(x=frame, y = mean - 2*se, group = user, col = user), linetype = "longdash")+
                    labs(y = "")+
                    theme_bw()
                    
post_userTraj <- grid.arrange(arrangeGrob(post_userProfile+theme(legend.position = "none"), 
                                          post_userProfile.se+theme(legend.position = "none"), nrow = 1), 
                              legend_userProfile, nrow = 1, 
                              widths = c(30, 6))
```

```{r coef_effect_plots, echo = F, fig.show = 'hide'}
pred_f1 <- predict(post_gam.fri, newdata=df_pred_occ, se.fit=TRUE, type = "terms")
pred_f2 <- predict(post_gam.fri, newdata=df_pred_dly, se.fit=TRUE, type = "terms")

pred_coef_df <- data.frame(frame = seq(0, 400),
                           f0_hat = lpmat_non %*% post_gam.coef, 
                           f0_se = sqrt(diag(lpmat_non %*% post_gam.cov %*% t(lpmat_non))), 
                           f1_hat = pred_f1$fit[, 2], 
                           f1_se = pred_f1$se.fit[, 2], 
                           f2_hat = pred_f2$fit[, 3], 
                           f2_se = pred_f2$se.fit[, 3])

post_non_plt <- ggplot(data = pred_coef_df, aes(x=frame, y = f0_hat))+
                geom_line()+
                geom_line(aes(x = frame, y = f0_hat + 2*f0_se), linetype = "longdash")+
                geom_line(aes(x = frame, y = f0_hat - 2*f0_se), linetype = "longdash")+
                labs(title = "Average Percent Change of a Non-user (Post)", ylab = "Percent Change")+
                theme_bw()

post_occ_plt <- ggplot(data = pred_coef_df, aes(x=frame, y = f1_hat))+
                geom_line()+
                geom_line(aes(x = frame, y = f1_hat + 2*f1_se), linetype = "longdash")+
                geom_line(aes(x = frame, y = f1_hat - 2*f1_se), linetype = "longdash")+
                geom_line(aes(x = frame, y = 0), col = "darkred")+
                labs(title = "Difference in Percent Change: Occasional and Non-user (Post)", 
                     y= "")+
                theme_bw()+
                scale_x_continuous(expand = c(0, 0))+
                theme(rect = element_rect(fill = "transparent"))

post_dly_plt <- ggplot(data = pred_coef_df, aes(x=frame, y = f2_hat))+
                geom_line()+
                geom_line(aes(x = frame, y = f2_hat + 2*f2_se), linetype = "longdash")+
                geom_line(aes(x = frame, y = f2_hat - 2*f2_se), linetype = "longdash")+
                geom_line(aes(x = frame, y = 0), col = "darkred")+
                labs(title = "Difference in Percent Change: Daily and Non-user (Post)", 
                     y = "")+
                theme_bw()+
                scale_x_continuous(expand = c(0, 0))+
                theme(rect = element_rect(fill = "transparent"))

ylab <- textGrob(label = "Difference in Percent Change", rot = 90, 
                 gp = gpar(fontsize = 12))
posval <- textGrob(label = sapply(strwrap("Less Constriction in User", width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))
negval <- textGrob(label = sapply(strwrap("More Constriction in User", width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))

post_occ_coef <- grid.arrange(ylab, posval, negval, post_occ_plt, 
                              ncol = 2, nrow = 2, 
                              layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))

post_dly_coef <- grid.arrange(ylab, posval, negval, post_dly_plt, 
                              ncol = 2, nrow = 2, 
                              layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))
```


```{r diff_dly_occ, echo = F, fig.show= 'hide'}
f2_f1 <- (lpmat_dly - lpmat_occ) %*% post_gam.coef
f2_f1.se <- sqrt(diag((lpmat_dly - lpmat_occ) %*% post_gam.cov %*% t((lpmat_dly - lpmat_occ))))

f2_f1_diff_df <- data.frame(frame = seq(0, 400), 
                            f2f1_diff = f2_f1, 
                            f2f1_se = f2_f1.se)

# ggplot(data = f2_f1_diff_df, aes(x=frame, y = f2f1_diff))+
#   geom_line()+
#   geom_line(aes(x = frame, y = f2f1_diff + 2*f2f1_se), linetype = "longdash")+
#   geom_line(aes(x = frame, y = f2f1_diff - 2*f2f1_se), linetype = "longdash")+
#   labs(title = "Difference between Average Daily vs Occasional User", ylab = "f2_hat - f1_hat")+
#   theme_bw()

post_dlyocc_plt <- ggplot(data = f2_f1_diff_df, aes(x=frame, y = f2f1_diff))+
                   geom_line()+
                   geom_line(aes(x = frame, y = f2f1_diff + 2*f2f1_se), linetype = "longdash")+
                   geom_line(aes(x = frame, y = f2f1_diff - 2*f2f1_se), linetype = "longdash")+
                   geom_line(aes(x = frame, y = 0), col = "darkred")+
                   labs(title = "Difference in Percent Change: Daily vs Occasional User (Post)", 
                        y = "")+
                   theme_bw()+
                   scale_x_continuous(expand = c(0, 0))+
                   theme(rect = element_rect(fill = "transparent"))

ylab <- textGrob(label = "Difference in Percent Change", rot = 90, 
                 gp = gpar(fontsize = 12))
posval <- textGrob(label = sapply(strwrap("Less Constriction in Daily User", width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, just = "bottom", 
                 gp = gpar(fontsize = 8))
negval <- textGrob(label = sapply(strwrap("More Constriction in Daily User", width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))

post_dlyocc_coef <- grid.arrange(ylab, posval, negval, post_dlyocc_plt, 
                                 ncol = 2, nrow = 2, 
                                 layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))
```

```{r smokervnon , echo = F}
smoker.gam.df <- merge(right_0.post, pt.analytic.df, 
                        by = c("subject_id", "user_cat"))
smoker.gam.df$sind <- smoker.gam.df$frame/400
smoker.gam.df$smoker <- ifelse(smoker.gam.df$user_cat == "non-user", 0, 1)

m.post_smoker_gam <- mgcv::gam(percent_change ~ s(sind, k=30, bs="cr") + 
                                 s(sind, by=smoker, k=30, bs = "cr"), 
                  data = smoker.gam.df, method = "REML")

## Create a matrix of residuals
post_smoker_gam.resid <- cbind(smoker.gam.df[!(is.na(smoker.gam.df$percent_change)), c("subject_id", "frame")], m.post_smoker_gam$residuals)
names(post_smoker_gam.resid) <- c("subject_id", "frame", "resid")

post_smoker_gam.resid$frame_char <- str_pad(post_smoker_gam.resid$frame, width = 3, side = "left", pad = "0")

resid_mat <- reshape(post_smoker_gam.resid[, c("subject_id", "frame_char", "resid")], 
                     timevar = "frame_char", 
                     idvar = "subject_id", 
                     direction = "wide")

rownames(resid_mat) <- resid_mat$subject_id
resid_mat$subject_id <- NULL
resid_names <- names(resid_mat)
resid_names <- sort(resid_names)
resid_mat <- resid_mat[, resid_names]

resid_mat <- as.matrix(resid_mat)


post_smoker_gam.fpca <- fpca.face(resid_mat, knots = 15)

#Create data frame of eigen functions and attach to original data
Phi_mat <- as.data.frame(post_smoker_gam.fpca$efunctions)
colnames(Phi_mat) <- paste0("Phi", seq(1, post_smoker_gam.fpca$npc))
Phi_mat$frame <- as.numeric(rownames(Phi_mat)) -1

smoker.gam.df <- merge(smoker.gam.df, Phi_mat, 
                        by = "frame", 
                        all.x = T)
smoker.gam.df <- smoker.gam.df[order(smoker.gam.df$subject_id, smoker.gam.df$frame), ]
smoker.gam.df$subject_id <- as.factor(smoker.gam.df$subject_id)

post_smoker_gam.fri <- mgcv::bam(percent_change ~ 
                            s(sind, k=30, bs="cr") + 
                            s(sind, by=smoker, k=30, bs = "cr") +
                            s(subject_id, by = Phi1, bs="re") + s(subject_id, by = Phi2, bs="re")+
                            s(subject_id, by = Phi3, bs="re") + s(subject_id, by = Phi4, bs="re"), 
                          method = "fREML", data = smoker.gam.df, discrete = TRUE)


# summary(post_smoker_gam.fri)
```

```{r plot_smk, echo = F, fig.show = 'hide'}
post_smoker_gam.coef <- post_smoker_gam.fri$coefficients
post_smoker_gam.cov <- vcov.gam(post_smoker_gam.fri)

df_pred_non <- data.frame("sind" = unique(smoker.gam.df$sind), "smoker" =0, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, 
                          "subject_id" = smoker.gam.df$subject_id[1])

lpmat_non <- predict(post_smoker_gam.fri, newdata=df_pred_non, se.fit=TRUE, type = "lpmatrix")


df_pred_smk <- data.frame("sind" = unique(smoker.gam.df$sind), "smoker" = 1, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, 
                          "subject_id" = smoker.gam.df$subject_id[1])

lpmat_smk <- predict(post_smoker_gam.fri, newdata=df_pred_smk, se.fit=TRUE, type = "lpmatrix")

pred_df <- data.frame(frame = rep(seq(0, 400), 2),
                      user = c(rep("non-user", 401), rep("smoker", 401)), 
                      mean = c(lpmat_non %*% post_smoker_gam.coef, 
                               lpmat_smk %*% post_smoker_gam.coef), 
                      se = c(sqrt(diag(lpmat_non %*% post_smoker_gam.cov %*% t(lpmat_non))), 
                             sqrt(diag(lpmat_smk %*% post_smoker_gam.cov %*% t(lpmat_smk)))), 
                      stringsAsFactors = F)

post_smkProfile <- ggplot(data = pred_df, aes(x = frame, y = mean, group = user, col = user))+
                   geom_line()+
                   scale_y_continuous(limits = c(min(pred_df$mean - 2*pred_df$se),
                                                 max(pred_df$mean+2*pred_df$se)))+
                   labs(y = "Percent Change")+
                   theme_bw()

legend_smkProfile <- g_legend(post_smkProfile)

post_smkProfile.se <- ggplot(data = pred_df, aes(x = frame, y = mean, group = user, col = user))+
                      geom_line()+
                      geom_line(aes(x=frame, y = mean + 2*se, group = user, col = user), linetype = "longdash")+
                      geom_line(aes(x=frame, y = mean - 2*se, group = user, col = user), linetype = "longdash")+
                      scale_y_continuous(limits = c(min(pred_df$mean - 2*pred_df$se),
                                                    max(pred_df$mean+2*pred_df$se)))+
                      labs(y = "")+
                      theme_bw()

post_smk <- grid.arrange(arrangeGrob(post_smkProfile+theme(legend.position = "none"),
                                     post_smkProfile.se+theme(legend.position = "none"), nrow = 1), 
                         legend_smkProfile, nrow = 1, 
                         widths = c(30, 6))
```

```{r smk_coef_effect_plots, echo = F, fig.show = 'hide'}
# pred_f0 <- predict(post_smoker_gam.fri, newdata=df_pred_non, se.fit=TRUE, type = "iterms")
pred_f1 <- predict(post_smoker_gam.fri, newdata=df_pred_smk, se.fit=TRUE, type = "terms")

pred_coef_df <- data.frame(frame = seq(0, 400),
                           f0_hat = lpmat_non %*% post_smoker_gam.coef, 
                           f0_se = sqrt(diag(lpmat_non %*% post_smoker_gam.cov %*% t(lpmat_non))), 
                           f1_hat = pred_f1$fit[, 2], 
                           f1_se = pred_f1$se.fit[, 2])

# ggplot(data = pred_coef_df, aes(x=frame, y = f0_hat))+
#   geom_line()+
#   geom_line(aes(x = frame, y = f0_hat + 2*f0_se), linetype = "longdash")+
#   geom_line(aes(x = frame, y = f0_hat - 2*f0_se), linetype = "longdash")+
#   labs(title = "Average Response of a Non-user", ylab = "f0_hat")+
#   theme_bw()

post_smk_plt <- ggplot(data = pred_coef_df, aes(x=frame, y = f1_hat))+
                geom_line()+
                geom_line(aes(x = frame, y = f1_hat + 2*f1_se), linetype = "longdash")+
                geom_line(aes(x = frame, y = f1_hat - 2*f1_se), linetype = "longdash")+
                geom_line(aes(x = frame, y = 0), col = "darkred")+
                labs(title = "Difference in Percent Change: Smoker and Non-smoker", 
                     y = "")+
                theme_bw()+
                scale_x_continuous(expand = c(0, 0))+
                theme(rect = element_rect(fill = "transparent"))

ylab <- textGrob(label = "Difference in Percent Change", rot = 90, 
                 gp = gpar(fontsize = 12))
posval <- textGrob(label = sapply(strwrap("Less Constriction in Smokers", width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, just = "bottom", 
                 gp = gpar(fontsize = 8))
negval <- textGrob(label = sapply(strwrap("More Constriction in Smokers", width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))

post_smk_coef <- grid.arrange(ylab, posval, negval, post_smk_plt, 
                              ncol = 2, nrow = 2, 
                              layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))
```

```{r wi_fosr_pffr, include = F, eval = F}
right_0.pt.w <- right_0.pt.w[order(right_0.pt.w$subject_id), ]

wi_pffr.df <- data.frame("subject_id" = pt.analytic.df$subject_id,
                          "occ_user" = pt.analytic.df$occasional, 
                          "daily_user" = pt.analytic.df$daily, 
                          "wi_pct_chg" = I(as.matrix(right_0.pt.w[, c(3:403)])))
wi_pffr.df$subject_id <- as.factor(wi_pffr.df$subject_id)

m.wi_pffr <- pffr(wi_pct_chg ~ occ_user + daily_user + s(subject_id, bs="re"),
                  data = wi_pffr.df,
                  algorithm = "bam", 
                  method = "fREML", 
                  discrete = T)

summary(m.wi_pffr)
par(mfrow = c(1,3))
plot(m.wi_pffr)
```


```{r wi_gam, echo = F}
right_0.pt.gam.df <- merge(right_0.pt, pt.analytic.df, 
                        by = c("subject_id", "user_cat"))
right_0.pt.gam.df$sind <- right_0.pt.gam.df$frame/400


m.wi_gam <- mgcv::gam(wiPctChg ~ s(sind, k=30, bs="cr") + s(sind, by=occasional, k=30, bs = "cr") + s(sind, by=daily, k=30, bs = "cr"), 
                  data = right_0.pt.gam.df, method = "REML")


## Create a matrix of residuals
wi_gam.resid <- cbind(right_0.pt.gam.df[!(is.na(right_0.pt.gam.df$wiPctChg)), c("subject_id", "frame")], m.wi_gam$residuals)
names(wi_gam.resid) <- c("subject_id", "frame", "resid")

wi_gam.resid$frame_char <- str_pad(wi_gam.resid$frame, width = 3, side = "left", pad = "0")


resid_mat <- reshape(wi_gam.resid[, c("subject_id", "frame_char", "resid")],
                     timevar = "frame_char",
                     idvar = "subject_id",
                     direction = "wide")
rownames(resid_mat) <- resid_mat$subject_id
resid_mat$subject_id <- NULL
resid_names <- names(resid_mat)
resid_names <- sort(resid_names)
resid_mat <- resid_mat[, resid_names]
resid_mat <- as.matrix(resid_mat)

wi_gam.fpca <- fpca.face(resid_mat, knots = 15)
# wi_gam.fpca$evalues/sum(wi_gam.fpca$evalues)

#Create data frame of eigen functions and attach to original data
Phi_mat <- as.data.frame(wi_gam.fpca$efunctions)
colnames(Phi_mat) <- paste0("Phi", seq(1, wi_gam.fpca$npc))
Phi_mat$frame <- as.numeric(rownames(Phi_mat)) -1

right_0.pt.gam.df <- merge(right_0.pt.gam.df, Phi_mat,
                        by = "frame",
                        all.x = T)
right_0.pt.gam.df <- right_0.pt.gam.df[order(right_0.pt.gam.df$subject_id, right_0.pt.gam.df$frame), ]
right_0.pt.gam.df$subject_id <- as.factor(right_0.pt.gam.df$subject_id)

wi_gam.fri <- mgcv::bam(wiPctChg ~ s(sind, k=30, bs="cr") + 
                          s(sind, by=occasional, k=30, bs = "cr") + 
                          s(sind, by=daily, k=30, bs = "cr")+
                          s(subject_id, by = Phi1, bs="re") + s(subject_id, by = Phi2, bs="re")+
                          s(subject_id, by = Phi3, bs="re") + s(subject_id, by = Phi4, bs="re")+
                          s(subject_id, by = Phi5, bs="re") + s(subject_id, by = Phi6, bs="re"),
                        method = "fREML", data = right_0.pt.gam.df, discrete = TRUE)
# summary(wi_gam.fri)
```

```{r wi.plots, echo = F, fig.show='hide'}
wi_gam.coef <- wi_gam.fri$coefficients
wi_gam.cov <- vcov.gam(wi_gam.fri)

df_pred_non <- data.frame("sind" = unique(right_0.pt.gam.df$sind), "occasional" = 0, "daily" = 0, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, "Phi5" = 0, "Phi6" = 0, 
                          "subject_id" = right_0.pt.gam.df$subject_id[1])

lpmat_non <- predict(wi_gam.fri, newdata=df_pred_non, se.fit=TRUE, type = "lpmatrix")


df_pred_occ <- data.frame("sind" = unique(right_0.pt.gam.df$sind), "occasional" = 1, "daily" = 0, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, "Phi5" = 0, "Phi6" = 0, 
                          "subject_id" = right_0.pt.gam.df$subject_id[1])

lpmat_occ <- predict(wi_gam.fri, newdata=df_pred_occ, se.fit=TRUE, type = "lpmatrix")

df_pred_dly <- data.frame("sind" = unique(right_0.pt.gam.df$sind), "occasional" = 0, "daily" = 1, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, "Phi5" = 0, "Phi6" = 0, 
                          "subject_id" = right_0.pt.gam.df$subject_id[1])

lpmat_dly <- predict(wi_gam.fri, newdata=df_pred_dly, se.fit=TRUE, type = "lpmatrix")


pred_df <- data.frame(frame = rep(seq(0, 400), 3),
                      user = c(rep("non-user", 401), rep("occasional", 401),rep("daily", 401)), 
                      mean = c(lpmat_non %*% wi_gam.coef, 
                               lpmat_occ %*% wi_gam.coef, lpmat_dly %*% wi_gam.coef), 
                      se = c(sqrt(diag(lpmat_non %*% wi_gam.cov %*% t(lpmat_non))), 
                             sqrt(diag(lpmat_occ %*% wi_gam.cov %*% t(lpmat_occ))),
                             sqrt(diag(lpmat_dly %*% wi_gam.cov %*% t(lpmat_dly)))), 
                      stringsAsFactors = F)

# ggplot(data = pred_df, aes(x = frame, y = mean, group = user, col = user))+
#   geom_line()+
#   geom_line(aes(x=frame, y = mean + 2*se, group = user, col = user), linetype = "longdash")+
#   geom_line(aes(x=frame, y = mean - 2*se, group = user, col = user), linetype = "longdash")+
#   theme_bw()

wi_userProfile <- ggplot(data = pred_df, aes(x = frame, y = mean, group = user, col = user))+
                   geom_line()+
                   scale_y_continuous(limits = c(min(pred_df$mean - 2*pred_df$se),
                                                 max(pred_df$mean+2*pred_df$se)))+
                   labs(y = "Within Person Difference in Percent Change")+
                   theme_bw()

legend_userProfile <- g_legend(wi_userProfile)

wi_userProfile.se <- ggplot(data = pred_df, aes(x = frame, y = mean, group = user, col = user))+
                      geom_line()+
                      geom_line(aes(x=frame, y = mean + 2*se, group = user, col = user), linetype = "longdash")+
                      geom_line(aes(x=frame, y = mean - 2*se, group = user, col = user), linetype = "longdash")+
                      scale_y_continuous(limits = c(min(pred_df$mean - 2*pred_df$se),
                                                    max(pred_df$mean+2*pred_df$se)))+
                      labs(y = "")+
                      theme_bw()

wi_userTraj <- grid.arrange(arrangeGrob(wi_userProfile+theme(legend.position = "none"), 
                         wi_userProfile.se+theme(legend.position = "none"), nrow = 1), 
                         legend_userProfile, nrow = 1, 
                         widths = c(30, 6))
```
### Plotting average trajectories of users
```{r wpd_traj, echo = F,  fig.height= 6, fig.width=20}
grid.arrange(post_userTraj, wi_userTraj, ncol = 2)
```

Left plot is visualizing the average trajectory of each user category (left) and then adding the 2*SE intervals for each trajectory (right) for post data, while the right plot shows similar mean and mean +/- 2SE trajectories for within person difference (WPD). The mean and mean +/- 2SE were separated for visual clarity. We can see that the mean trajectories occasional and daily user are more similar than that of non-users in both the post and WPD; however after accounting for the variation between subjects the trajectoreis are not completely separable. 


```{r wicoef_effect_plots, echo = F, fig.show = 'hide'}
pred_f1 <- predict(wi_gam.fri, newdata=df_pred_occ, se.fit=TRUE, type = "terms")
pred_f2 <- predict(wi_gam.fri, newdata=df_pred_dly, se.fit=TRUE, type = "terms")

pred_coef_df <- data.frame(frame = seq(0, 400),
                           f0_hat = lpmat_non %*% wi_gam.coef, 
                           f0_se = sqrt(diag(lpmat_non %*% wi_gam.cov %*% t(lpmat_non))), 
                           f1_hat = pred_f1$fit[, 2], 
                           f1_se = pred_f1$se.fit[, 2], 
                           f2_hat = pred_f2$fit[, 3], 
                           f2_se = pred_f2$se.fit[, 3])

# ggplot(data = pred_coef_df, aes(x=frame, y = f0_hat))+
#   geom_line()+
#   geom_line(aes(x = frame, y = f0_hat + 2*f0_se), linetype = "longdash")+
#   geom_line(aes(x = frame, y = f0_hat - 2*f0_se), linetype = "longdash")+
#   labs(title = "Average Response of a Non-user", ylab = "Within Person Difference in Percent Change")+
#   theme_bw()

wi_occ_plt <-  ggplot(data = pred_coef_df, aes(x=frame, y = f1_hat))+
               geom_line()+
               geom_line(aes(x = frame, y = f1_hat + 2*f1_se), linetype = "longdash")+
               geom_line(aes(x = frame, y = f1_hat - 2*f1_se), linetype = "longdash")+
               geom_line(aes(x = frame, y = 0), col = "darkred")+
               labs(title = "Difference in Within Person Difference (WPD): Occasional and Non-user", 
                    y = "")+
               theme_bw()+
               scale_x_continuous(expand = c(0, 0))+
               theme(rect = element_rect(fill = "transparent"))

wi_dly_plt <- ggplot(data = pred_coef_df, aes(x=frame, y = f2_hat))+
              geom_line()+
              geom_line(aes(x = frame, y = f2_hat + 2*f2_se), linetype = "longdash")+
              geom_line(aes(x = frame, y = f2_hat - 2*f2_se), linetype = "longdash")+
              geom_line(aes(x = frame, y = 0), col = "darkred")+
              labs(title = "Difference in Within Person Difference (WPD): Daily and Non-user", 
                   y = "")+
              theme_bw()+
              scale_x_continuous(expand = c(0, 0))+
              theme(rect = element_rect(fill = "transparent"))

ylab <- textGrob(label = "Difference in WPD in Percent Change", rot = 90, 
                 gp = gpar(fontsize = 12))
posval <- textGrob(label = sapply(strwrap("More WPD Constriction in User", width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))
negval <- textGrob(label = sapply(strwrap("Less WPD Constriction in User", width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))

wi_occ_coef <- grid.arrange(ylab, posval, negval, wi_occ_plt, 
                              ncol = 2, nrow = 2, 
                              layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))

wi_dly_coef <- grid.arrange(ylab, posval, negval, wi_dly_plt, 
                              ncol = 2, nrow = 2, 
                              layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))
```

### Difference between Occasional and Non-user

```{r occ_coef_plt, echo=FALSE, fig.height = 6, fig.width=15}
grid.arrange(post_occ_coef, wi_occ_coef, ncol = 2)
```

This plot compares the difference between occasional and non-users for post and WPD data. In the post data there is significant positive difference in the occasional and non-users from frame 50 - 125 which would indicate that occasional user have less constriction during this time. In the WPD data there is a significant positive difference in the occasional and non-users from frame 10 - 175, indicating a greater difference in the difference between post and pre for the occasional vs non-user. Since the typical response has a positive difference between post and pre during this interval caused by less constriction at post compared to pre, we can say that there is even less constriction in post data of an occasional user compared to his/her pre than in a non-user. 

### Difference between Daily and Non-Users

```{r dly_coef_plt, echo=FALSE, fig.height = 6, fig.width=15}
grid.arrange(post_dly_coef, wi_dly_coef, ncol = 2)
```

These results are similar to the occassional vs non-user but less pronounced maybe indicating more variability in daily and non-users. 

```{r wi_diff_dly_occ, echo = F, fig.show= 'hide'}
f2_f1 <- (lpmat_dly - lpmat_occ) %*% wi_gam.coef
f2_f1.se <- sqrt(diag((lpmat_dly - lpmat_occ) %*% wi_gam.cov %*% t((lpmat_dly - lpmat_occ))))

f2_f1_diff_df <- data.frame(frame = seq(0, 400), 
                            f2f1_diff = f2_f1, 
                            f2f1_se = f2_f1.se)

wi_dlyocc_plt <- ggplot(data = f2_f1_diff_df, aes(x=frame, y = f2f1_diff))+
                   geom_line()+
                   geom_line(aes(x = frame, y = f2f1_diff + 2*f2f1_se), linetype = "longdash")+
                   geom_line(aes(x = frame, y = f2f1_diff - 2*f2f1_se), linetype = "longdash")+
                   geom_line(aes(x = frame, y = 0), col = "darkred")+
                   labs(title = "Difference in WPD in Percent Change: Daily vs Occasional User", 
                        y = "")+
                   theme_bw()+
                   scale_x_continuous(expand = c(0, 0))+
                   theme(rect = element_rect(fill = "transparent"))

ylab <- textGrob(label = "Difference in WPD in Percent Change", rot = 90, 
                 gp = gpar(fontsize = 12))
posval <- textGrob(label = sapply(strwrap("More Constriction in Daily User", width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, just = "bottom", 
                 gp = gpar(fontsize = 8))
negval <- textGrob(label = sapply(strwrap("Less Constriction in Daily User", width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))

wi_dlyocc_coef <- grid.arrange(ylab, posval, negval, wi_dlyocc_plt, 
                                 ncol = 2, nrow = 2, 
                                 layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))
```

### Difference between Daily and Occasional Users

```{r dlyocc_coef_plt, echo = F, fig.height = 6, fig.width=15}
grid.arrange(post_dlyocc_coef, wi_dlyocc_coef, ncol = 2)
```

There is no siginificant difference between occassional and daily users. 

## Difference in Between Smoker vs Non-smokers

```{r wi_smokervnon, echo = F}
wi.smoker.gam.df <- merge(right_0.pt, pt.analytic.df, 
                        by = c("subject_id", "user_cat"))
wi.smoker.gam.df$sind <- wi.smoker.gam.df$frame/400
wi.smoker.gam.df$smoker <- ifelse(wi.smoker.gam.df$user_cat == "non-user", 0, 1)

m.wi_smoker_gam <- mgcv::gam(wiPctChg ~ s(sind, k=15, bs="cr") + 
                                 s(sind, by=smoker, k=15, bs = "cr"), 
                  data = wi.smoker.gam.df, method = "REML")

## Create a matrix of residuals
wi_smoker_gam.resid <- cbind(wi.smoker.gam.df[!(is.na(wi.smoker.gam.df$wiPctChg)), c("subject_id", "frame")], m.wi_smoker_gam$residuals)
names(wi_smoker_gam.resid) <- c("subject_id", "frame", "resid")

wi_smoker_gam.resid$frame_char <- str_pad(wi_smoker_gam.resid$frame, width = 3, side = "left", pad = "0")

resid_mat <- reshape(wi_smoker_gam.resid[, c("subject_id", "frame_char", "resid")], 
                     timevar = "frame_char", 
                     idvar = "subject_id", 
                     direction = "wide")

rownames(resid_mat) <- resid_mat$subject_id
resid_mat$subject_id <- NULL
resid_names <- names(resid_mat)
resid_names <- sort(resid_names)
resid_mat <- resid_mat[, resid_names]

resid_mat <- as.matrix(resid_mat)


wi_smoker_gam.fpca <- fpca.face(resid_mat, knots = 15)

#Create data frame of eigen functions and attach to original data
Phi_mat <- as.data.frame(wi_smoker_gam.fpca$efunctions)
colnames(Phi_mat) <- paste0("Phi", seq(1, wi_smoker_gam.fpca$npc))
Phi_mat$frame <- as.numeric(rownames(Phi_mat)) -1

wi.smoker.gam.df <- merge(wi.smoker.gam.df, Phi_mat, 
                        by = "frame", 
                        all.x = T)
wi.smoker.gam.df <- smoker.gam.df[order(wi.smoker.gam.df$subject_id, wi.smoker.gam.df$frame), ]
wi.smoker.gam.df$subject_id <- as.factor(wi.smoker.gam.df$subject_id)

wi_smoker_gam.fri <- mgcv::bam(percent_change ~ 
                            s(sind, k=15, bs="cr") + 
                            s(sind, by=smoker, k=15, bs = "cr") +
                            s(subject_id, by = Phi1, bs="re") + s(subject_id, by = Phi2, bs="re")+
                            s(subject_id, by = Phi3, bs="re") + s(subject_id, by = Phi4, bs="re"), 
                          method = "fREML", data = wi.smoker.gam.df, discrete = TRUE)


# summary(wi_smoker_gam.fri)
```


```{r wi_plot_smk, echo = F, fig.show = 'hide'}
wi_smoker_gam.coef <- wi_smoker_gam.fri$coefficients
wi_smoker_gam.cov <- vcov.gam(wi_smoker_gam.fri)

df_pred_non <- data.frame("sind" = sort(unique(wi.smoker.gam.df$sind)), "smoker" =0, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, 
                          "subject_id" = wi.smoker.gam.df$subject_id[1])

lpmat_non <- predict(wi_smoker_gam.fri, newdata=df_pred_non, se.fit=TRUE, type = "lpmatrix")


df_pred_smk <- data.frame("sind" = sort(unique(wi.smoker.gam.df$sind)), "smoker" = 1, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, 
                          "subject_id" = wi.smoker.gam.df$subject_id[1])

lpmat_smk <- predict(wi_smoker_gam.fri, newdata=df_pred_smk, se.fit=TRUE, type = "lpmatrix")

pred_df <- data.frame(frame = rep(seq(0, 400), 2),
                      user = c(rep("non-user", 401), rep("smoker", 401)), 
                      mean = c(lpmat_non %*% wi_smoker_gam.coef, 
                               lpmat_smk %*% wi_smoker_gam.coef), 
                      se = c(sqrt(diag(lpmat_non %*% wi_smoker_gam.cov %*% t(lpmat_non))), 
                             sqrt(diag(lpmat_smk %*% wi_smoker_gam.cov %*% t(lpmat_smk)))), 
                      stringsAsFactors = F)

# ggplot(data = pred_df, aes(x = frame, y = mean, group = user, col = user))+
#   geom_line()+
#   geom_line(aes(x=frame, y = mean + 2*se, group = user, col = user), linetype = "longdash")+
#   geom_line(aes(x=frame, y = mean - 2*se, group = user, col = user), linetype = "longdash")+
#   theme_bw()

wi_smkProfile <- ggplot(data = pred_df, aes(x = frame, y = mean, group = user, col = user))+
                   geom_line()+
                   scale_y_continuous(limits = c(min(pred_df$mean - 2*pred_df$se),
                                                 max(pred_df$mean+2*pred_df$se)))+
                   labs(y = "WPD in Percent Change")+
                   theme_bw()

legend_smkProfile <- g_legend(wi_smkProfile)

wi_smkProfile.se <- ggplot(data = pred_df, aes(x = frame, y = mean, group = user, col = user))+
                      geom_line()+
                      geom_line(aes(x=frame, y = mean + 2*se, group = user, col = user), linetype = "longdash")+
                      geom_line(aes(x=frame, y = mean - 2*se, group = user, col = user), linetype = "longdash")+
                      scale_y_continuous(limits = c(min(pred_df$mean - 2*pred_df$se),
                                                    max(pred_df$mean+2*pred_df$se)))+
                      labs(y = "")+
                      theme_bw()

wi_smk <- grid.arrange(arrangeGrob(wi_smkProfile+theme(legend.position = "none"), 
                                   wi_smkProfile.se+theme(legend.position = "none"), nrow = 1), 
                       legend_smkProfile, nrow = 1, 
                       widths = c(30, 6))
```

### Average Trajectory of Smoker vs Non-Smoker
```{r plt_smkTraj,echo = F, fig.height= 8, fig.width= 8}
grid.arrange(post_smk, wi_smk, nrow = 2)
```

Showing mean trajectories for the post and WPD data for smokers vs non-smokers. 

```{r wi_smk_coef_effect_plots, echo= F, fig.show = 'hide'}
# pred_f0 <- predict(post_smoker_gam.fri, newdata=df_pred_non, se.fit=TRUE, type = "iterms")
pred_f1 <- predict(wi_smoker_gam.fri, newdata=df_pred_smk, se.fit=TRUE, type = "terms")

pred_coef_df <- data.frame(frame = seq(0, 400),
                           f0_hat = lpmat_non %*% wi_smoker_gam.coef, 
                           f0_se = sqrt(diag(lpmat_non %*% wi_smoker_gam.cov %*% t(lpmat_non))), 
                           f1_hat = pred_f1$fit[, 2], 
                           f1_se = pred_f1$se.fit[, 2])

# ggplot(data = pred_coef_df, aes(x=frame, y = f0_hat))+
#   geom_line()+
#   geom_line(aes(x = frame, y = f0_hat + 2*f0_se), linetype = "longdash")+
#   geom_line(aes(x = frame, y = f0_hat - 2*f0_se), linetype = "longdash")+
#   labs(title = "Average Within Person Difference in Percent Change of a Non-user", ylab = "f0_hat")+
#   theme_bw()

wi_smk_plt <- ggplot(data = pred_coef_df, aes(x=frame, y = f1_hat))+
              geom_line()+
              geom_line(aes(x = frame, y = f1_hat + 2*f1_se), linetype = "longdash")+
              geom_line(aes(x = frame, y = f1_hat - 2*f1_se), linetype = "longdash")+
              geom_line(aes(x = frame, y = 0), col = "darkred")+
              labs(title = "Difference in Within Person Difference (WPD) in Percent Change \nbetween Smoker and Non-smoker", 
                   y = "")+
              theme_bw()+
              scale_x_continuous(expand = c(0, 0))+
              theme(rect = element_rect(fill = "transparent"))

ylab <- textGrob(label = "Difference in WPD in Percent Change", rot = 90, 
                 gp = gpar(fontsize = 12))
posval <- textGrob(label = sapply(strwrap("More WPD Constriction in User", width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))
negval <- textGrob(label = sapply(strwrap("Less WPD Constriction in User", width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))

wi_smk_coef <- grid.arrange(ylab, posval, negval, wi_smk_plt, 
                            ncol = 2, nrow = 2, 
                            layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))
```

### Smoker vs Non-smoker Effect
```{r smokerEffects, echo = F, fig.height = 4, fig.width=15}
grid.arrange(post_smk_coef , wi_smk_coef, nrow = 1)
```

Similar to the results from the specific user category analysis, in the post data we see a significant positive difference in percent change between smokers and non-smokers at frames 60- 110 with smokers having less constriction. In the WPD data, there's a siginificant positive difference in the within person difference between smokers and non-smokers from frame 10 - 125 indicating a more difference from pre to post in smokers compared to non-smokers. Similar to before with a typical positive difference from pre to post during this interval indicating less constriction at post, this result can be viewed as saying that if we had two individuals (one smoker and one non-smoker) with the same trajectory at pre the smoker would have a less constriction after smoking compared to the non-smoker. 

# Appendix

## Table 1: All Subjects
No Consumption end time recorded for non-users
```{r tab1, echo=FALSE}
# Demographics Table by User Category
table1(~ demo_age + demo_weight+ demo_height+BMI + demo_gender + thc_chg + postConsumpTimeToTest + min_constriction_chg + AUC_chg + duration_chg + slope_chg + avg_end_percent_chg|user_cat, 
       data = pt.df)
```


## Table 1: Analytic Sample
No Consumption end time recorded for non-users
```{r tab1_analyticN, echo = F}
# Demographics Table by User Category
table1(~demo_age + demo_weight+ demo_height+BMI + demo_gender + thc_chg + postConsumpTimeToTest + min_constriction_chg + AUC_chg + duration_chg + slope_chg + avg_end_percent_chg|user_cat, 
       data = pt.df[pt.df$subject_id %in% analytic.N, ])
```

## Backward Stepwise Selection

```{r step_post, echo=F, results='hide', message=FALSE}
post_step.df <- pt.scores[, c("PC1", "PC2", "PC3", "PC4", "min_constriction.post", 
                              "duration.post", "avg_end_percent.post", 
                              "slope.post", "AUC.post", "smoker")]

m.post_step <- glm(smoker ~ PC1 + PC2 + PC3 + PC4, family = "binomial", data = post_step.df)
post_step.res <- step(m.post_step, direction = "backward")
# summary(post_step.res)
# post_step.res$coefficients[-1]

post_step.df$pred_post_step <- predict(post_step.res, pt.scores)

pt.scores.roc3 <- roc(response = post_step.df$smoker, 
                     predictor = post_step.df$pred_post_step)

# pt.scores.roc3
auc.specific <- data.frame("Post AUC PCs Step", pt.scores.roc3$auc)
auc.df <- rbind(auc.df, setNames(auc.specific, names(auc.df)))

plot.roc(pt.scores.roc3, 
         col = "black")

## Scalar
m.post_step.scalar <- glm(smoker ~ min_constriction.post + AUC.post  + 
                            avg_end_percent.post + slope.post, 
                          family = "binomial", data = post_step.df)
post_step.res <- step(m.post_step.scalar, direction = "backward")
# summary(post_step.res)
# post_step.res$coefficients[-1]
post_step.df$pred_post_step.scalar <- predict(post_step.res, pt.scores)

pt.scalar.roc3 <- roc(response = post_step.df$smoker, 
                     predictor = post_step.df$pred_post_step.scalar)

# pt.scalar.roc3
auc.specific <- data.frame("Post AUC Scalar Step", pt.scalar.roc3$auc)
auc.df <- rbind(auc.df, setNames(auc.specific, names(auc.df)))

plot.roc(pt.scalar.roc3, 
         col = "darkred", 
         add = T)

## Within Person differences
wi_step.df <- pt.wi.scores[, c("PC1", "PC2", "PC3", "PC4", "PC5", "PC6", 
                               "min_constriction_chg", "AUC_chg", "duration_chg", 
                               "avg_end_percent_chg", "slope_chg", "smoker")]

m.wi_step <- glm(smoker ~ PC1 + PC2 + PC3 + PC4 +PC5 +PC6, family = "binomial", data = wi_step.df)
wi_step.res <- step(m.wi_step, direction = "backward")
# wi_step.res$coeffcients[-1]
# summary(wi_step.res)

wi_step.df$pred_wi_step <- predict(wi_step.res, pt.wi.scores)
pt.wi.scores.roc4 <- roc(response = wi_step.df$smoker, 
                     predictor = wi_step.df$pred_wi_step)

# pt.wi.scores.roc4
auc.specific <- data.frame("W/I Diff AUC PCs Step", pt.wi.scores.roc4$auc)
auc.df <- rbind(auc.df, setNames(auc.specific, names(auc.df)))

plot.roc(pt.wi.scores.roc4,
         col = "darkblue", 
         add = T)

### Scalar Features
m.wi_step.scalar <- glm(smoker ~ min_constriction_chg + AUC_chg 
                 + avg_end_percent_chg + slope_chg,
                 family = "binomial", data = wi_step.df)

wi_step.res <- step(m.wi_step.scalar, direction = "backward")
# summary(wi_step.res)
# wi_step.res$coefficients[-1]

wi_step.df$pred_wi_step.scalar <- predict(wi_step.res, pt.wi.scores)
pt.wi.scalar.roc4 <- roc(response = wi_step.df$smoker, 
                     predictor = wi_step.df$pred_wi_step.scalar)

# pt.wi.scalar.roc4
auc.specific <- data.frame("W/I Diff AUC Scalar Step", pt.wi.scalar.roc4$auc)
auc.df <- rbind(auc.df, setNames(auc.specific, names(auc.df)))

plot.roc(pt.wi.scalar.roc4, 
         col = "darkgreen", 
         add = T)
legend(0.5, 0.35, legend = c(paste0("post PCs AUC: ",round(pt.scores.roc3$auc, 3)),
                                 paste0("post Scalar Features AUC: ",round(pt.scalar.roc3$auc, 3)), 
                                 paste0("WPD PCs AUC: ", round(pt.wi.scores.roc4$auc, 3)),
                                 paste0("WPD Scalar Features AUC: ", round(pt.wi.scalar.roc4$auc, 3))),
       col = c("black", "darkred", "darkblue", "darkgreen"), 
       lty = rep(1, 4), cex = 0.8, box.lty=0)
```

+ Post PCs Selected: PC3 and PC4
+ Post Scalar Features Selected: Minimal Constriction and AUC
+ WPD PCs Selected: PC1, PC2, PC3, PC5
+ WPD Scalar Features Selected: Change in minimal constriction

## FoSR
$$ 
\begin{aligned}
Y_{ij}(t) &= f_0(t) + f_1(t)*I(user = occasional) + f_2(t)*I(user = daily) + b_i(t) + \epsilon_i(t)\\
& b_i(t) \sim GP(0, \Sigma_b) \\
& \epsilon_i(t) \sim N(0, \sigma_{\epsilon}^2) \\
&= \sum_{k=1}^K \xi_{0k}\phi_{0k}(t_i) + \sum_{k=1}^K \xi_{1k}\phi_{1k}(t_i)*I(user = occasional) + \sum_{k=1}^K \xi_{2k}\phi_{2k}(t_i)*I(user = daily) + \sum_{k=1}^K \xi_{ik}\phi_k(t_i) + \epsilon_i(t)\\
\end{aligned}
$$

### Mean function for non-user
$$
\begin{aligned}
Y_{ij}(t) &= f_0(t)\\
&=\sum_{k=1}^K \xi_{0k}\phi_{0k}(t_i) \\
&= \Phi_0\xi_0
\end{aligned}
$$

### Mean function for occasional user
$$
\begin{aligned}
Y_{ij}(t) &= f_0(t) + f_1(t) \\  
&=\sum_{k=1}^K \xi_{0k}\phi_{0k}(t_i) + \sum_{k=1}^K \xi_{1k}\phi_{1k}(t_i)\\
&= \Phi_0\xi_0 + \Phi_1\xi_1\\ 
&= [ \Phi_0, \Phi_1 ] \xi
\end{aligned}
$$

### Mean function for daily user
$$
\begin{aligned}
Y_{ij}(t) &= f_0(t) + f_2(t) \\  
&=\sum_{k=1}^K \xi_{0k}\phi_{0k}(t_i) + \sum_{k=1}^K \xi_{2k}\phi_{2k}(t_i) \\
&= \Phi_0\xi_0 + \Phi_2\xi_2\\
&= [ \Phi_0, \Phi_2 ] \xi
\end{aligned}
$$
