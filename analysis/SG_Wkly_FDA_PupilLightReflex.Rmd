---
title: "Suni's Weekly FDA Analysis Check-in Progress -- Pupil Light Reflex"
author: "SG"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: true
    theme: lumen
---

# To Do: 
1. Try different number of basis functions start with 15 go to 30
2. Write down mathematical interpretation of the plots.
3. Scalar on Function Regression - Plot
    + Re-run with fpca imputed data
    +  **It might be worth you exploring the intuition behind this a bit more by making spaghetti plots of the functions that are produced by applying the quadrature weights to the original trajectories**
4. Regression using VAS score to define "high" vs "not" in all smokers
    + Scatterplot of VAS vs point of minimal constriction for all smokers 
5. Time from Consumption to test -- WPD add FoSR
    + How to do effect plots?
6. Create a document with results to send to the collaborators

# Questions for Collaborators
1. How much time does it take for the effects of marijuana to reduce?

# Collaborator Meeting Notes
1. Assess optimal threshold from logistic regression analyses (Youdon's J)
2. Significance test for AUC values? Are they really different from each other
3. What's the typical length of pulse for the test? (Varied randomly across participants)
4. What's the average test time? Can we convert frame rate to time (300 frames/sec)
5. ROC analysis -- need reasonably good specificity, maybe tease out some features that lead to good specificity
6. Consider effects of "baseline" pupil size (initial small pupil size will lead to less change over time)
7. Key results: 
  + Ability to differentiate smokers vs non-smokers in POST data
  + No difference between occasional and daily user (e.g. no tolerance)
8. Additional Analysis: 
  + Most individuals smoking in the study did not use a large dose and had smaller cannabis effect than normal
    + Examine if there are difference in user that reported feeling "stoned" vs not (VAS score 0-40)
    + Among occasional user create a ordered categorical by THC amount
      + Occasional user: 5 ng/ml THC
      + Daily user: 25 ng/ml THC

# Task Worked On From Last Week:
1. Post Consumption Time to Test Analysis
  + model 1: run a model that includes non-users, a main effect for smokers, and an interaction between PCTT and smokers 
  + model 2: subset to just the smokers. Run model with intercept and PCTT- consider a nonlinear term for PCTT since model 1 as we have specified it so far does not let the effect of PCTT on pupil size change nonlinearly, and I suspect that that effect may in fact not be linear
  +make plots from model 1 and model 2 of average pupil trajectory at different values of PCTT- at, say, 55 minutes, 60 minutes, 65 minutes post smoking. I attached a plot of roughly what I have in mind.



## Comments for Ben
+ Correcting export error leading to NA in frame numbers
+ Potentially misaligned data
  + 001-109-pre2: Reviewed and corrected in pupil_data_with_demo_20220926.csv file
  + 001-060-post: Prolonged period of closing eyes before and during test -- disregard this ptid-time (BS) 
  + 001-007-pre2: start at 2nd bump? *-- reviewed by Ben*
  + 001-033-pre2: odd pattern *-- reviewed by Ben*
  + 001-038-pre2: odd pattern *-- reviewed by Ben*
  + 001-043-pre2: both look odd; mainly check pre2; maybe review videos -- graph okay to use; cut off at frame 400 (BS)
  + 001-043-post: both look odd; mainly check pre2; maybe review videos --  difficult to define true beginning -- okay to use (BS)
+ Frames removed (outliers)
  + Should be a way to have a value for every frame?
+ Ask for scalar features -- SENT & REC'D
  
## Notes 
1. Send HTML of Rmarkdown to JW & AL by Tuesday night
2. Ask quick questions through email (e.g. components of objects or error messages)
3. Add PURPOSE and INTERPRETATIONS for each plot
4. chart.Correlation fxn
  + '***: p < 0.001
  + '**: p < 0.01
  + '*: p < 0.05
  + '.: p < 0.10
5. Do no use duration variable in scalar feature regressions
6. $R^2$ for pffr vs gam = 95% vs 25% -- shows that gam is misspecified without RE for subject
7. edf in pffr output of 1 = shift in intercept, 2 = non-linear effect 

# Background
Pupil size light reflex to a light test is a potential test to determine a person is under the influence of THC and be able to be use as a field sobriety measures. The goals of the analysis to: 

## Potential Topics
1. Determine the variability of pupil light reflex in a sober population
2. Determine the effectiveness of pupil light reflex to measure sobriety after smoking THC 
    Question - dose response?
3. Jointly model pupil light reflex and blink rate during a light test (another data set)

Pupil size light reflex to light does not habituated to THC use (smoking).

Time for smoking to post test maybe an important variable to model b/c: 

+ effects of THC reduce with time
+ currently time from smoke period to post are all similar so we might not see an effect

There is a circadian pattern to pupil size (https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7445830/). 

## Experimental Design
+ Setting: Office
  + Were the lights ON/OFF during testing (JW)

## Features of Importance
1. Point of maximal constriction -- more dilation after smoking
2. Rebound dilation
+ Ideally the non-user data should have little change from pre to post but there may be some "habituation" to the test?

*Currently this field does not use FDA, so any FDA in topic area may be publishable*

# Data summary
Data on pupil size during light reflex test. Pupil size was extracted at the image level based on image analysis techniques. Each test was performed simultaneously on right and left eye before and after THC use (smoking).

+ USE percent change for analysis
+ Start at frame 0 
+ End of test is not strictly defined (with FoS we shouldn't need to define the end of the test)

# FDA analysis pointers: 
1. Usually only interpret PC1 & PC2, check the percent of variance explained and decide from that if interpreting later PCs is important
2. For prediction models: higher order PCs might be more useful

## Questions: 
1. Can we translate frame into time? Do we need to? -- No need to translate to time dimension, also time drift shouldn't be an issue because duration of test is short

```{r setup, include=FALSE}
library(openxlsx)
library(ggplot2)
library(table1)
library(refund)
library(refund.shiny)
library(pROC)
library(stringr)
library(PerformanceAnalytics)
library(mgcv)
library(grid)
library(gridExtra)
library(haven)
library(Hmisc)
library(ggpmisc)
library(viridis)

knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  fig.width = 9,
  fig.height = 4,
  fig.path = '../figs/'
)

theme_set(theme_bw() + theme(legend.position = "bottom"))

# ps_folder <- "C:/Repositories/Dissertation/PupilSize_img"
# data_folder <- "C:/Users/Suneeta/OneDrive - The University of Colorado Denver/FDA/Data" # Home laptop
data_folder <- "C:/Users/godbolsu/OneDrive - The University of Colorado Denver/FDA/Data" # Work laptop
# data_folder <- "C:/Users/godbolsu/OneDrive - The University of Colorado Denver/FDA/Data"
ps_folder <- "202208_PupilLightReflex"

res_folder <- "C:/Repository/FDA/PupilLightReflex/analysis" # Work Laptop
# res_folder <- "C:/Repositories/FDA/PupilLightReflex/analysis" # Home Laptop
```

# Data Preparation
```{r dataReadIn}
ps <- read.csv(file.path(data_folder, ps_folder, "pupil_data_with_demo_20220926.csv"))

ps$demo_gender <- factor(ps$demo_gender, 
                         levels = c(1,2), 
                         labels = c("Male", "Female"))

ps$user_cat <- NA
ps$user_cat[ps$user_type == "non-user"] <- 0
ps$user_cat[ps$user_type == "occasional"] <- 1
ps$user_cat[ps$user_type == "daily"] <- 2

ps$user_cat <- factor(ps$user_cat, 
                      levels = c(0,1,2), 
                      labels = c("non-user", 
                                 "occasional", 
                                 "daily"))

ps$tp <- NA
ps$tp[ps$time == "pre2"] <- 0
ps$tp[ps$time == "post"] <- 1

ps$tp <- factor(ps$tp, 
                levels = c(0,1), 
                labels = c("pre2", "post"))

# str(ps)
## -- Not needed with Ben's revised file missing frame numbers recorded
# #impute frame number 
# for(i in 2:(nrow(ps)-1)){
#   if(is.na(ps$frame[i]) & is.na(ps$frame[i+1] - ps$frame[i-1])){
#     ps$frame[i] <- ps$frame[i-1]+1
#   }else(if(is.na(ps$frame[i]) & (ps$frame[i+1] - ps$frame[i-1]) == 2){
#     ps$frame[i] <- ps$frame[i-1]+1
#   }else(if(is.na(ps$frame[i]) & (ps$frame[i+1] - ps$frame[i-1]) > 2){
#     if(abs(ps$percent_change[i] - ps$percent_change[i-1]) <
#        abs(ps$percent_change[i+1] - ps$percent_change[i])){
#       ps$frame[i] <- ps$frame[i-1]+1
#     }else(ps$frame[i] <- ps$frame[i+1]-1)
#     }
#     )
#   )
# }
```

```{r pt_summ}
# total number of subjects
# length(unique(ps$subject_id))

# subject level data 
pt.df <- unique(ps[, c("subject_id", "tp", "user_cat", "demo_age", 
                "demo_weight", "demo_height", "demo_gender", "thc")])

# # Demographics Table by User Category
# table1(~ demo_age + demo_weight + demo_height + demo_gender|user_cat, 
#        data = pt.df[pt.df$tp == "pre2", ])

# number of subjects by timepoint (pre/post)
# table(pt.df$tp)
```

There are more subjects in total than by time point. Indicating incomplete data with some subjects missing "pre" and others missing "post" measurement.

Add scalar features for each participant-time point
```{r scalarFeat}
scalar.feat <- read.csv(file.path(data_folder, ps_folder, "scalars_trim.csv"), 
                        header = T, stringsAsFactors = F)

scalar.feat$subject_id <- substr(scalar.feat$timeid, 1, 7)
scalar.feat$tp <- substr(scalar.feat$timeid, 8, 11)

scalar.featR <- scalar.feat[scalar.feat$eye == "Right", ]

pt.df <- merge(pt.df, scalar.featR[, c("subject_id", "tp", "min_constriction", 
                                       "duration", "avg_end_percent", "slope", 
                                       "AUC", "eye")], 
               by = c("subject_id", "tp"))

```

Reshape participant demog data to preserve pre and post THC levels and scalar features
```{r ptdf_reshape}
pt.df.w <- reshape(pt.df, 
                   timevar = "tp", 
                   idvar = c("subject_id", "user_cat", "demo_age", 
                             "demo_weight", "demo_height", "demo_gender", "eye"), 
                   direction = "wide")
pt.df.w$thc.post[pt.df.w$user_cat == "non-user" & is.na(pt.df.w$thc.post)] <- 0
pt.df.w$thc_chg <- pt.df.w$thc.post - pt.df.w$thc.pre2
pt.df.w$BMI <- pt.df.w$demo_weight*703/(pt.df.w$demo_height)^2
pt.df.w$min_constriction_chg <- pt.df.w$min_constriction.post - pt.df.w$min_constriction.pre2
pt.df.w$AUC_chg <- pt.df.w$AUC.post - pt.df.w$AUC.pre2
pt.df.w$duration_chg <- pt.df.w$duration.post - pt.df.w$duration.pre2
pt.df.w$avg_end_percent_chg <- pt.df.w$avg_end_percent.post - pt.df.w$avg_end_percent.pre2
pt.df.w$slope_chg <-  pt.df.w$slope.post - pt.df.w$slope.pre2
```

## Add time from smoking to post test
```{r readIn_testTimes}
## Need to work on; time formatted in Excel file.
testTimes <- read.xlsx(file.path(data_folder, ps_folder, "All SafetyScan Times_23Aug2022_revSG.xlsx"), 
                       sheet = "Raw")

testTimes$pre_safetyscan_date_convert <- as.Date(testTimes$pre_safetyscan_date, 
                                                 origin = "1899-12-30")

testTimes$pre_safetyscan_time_convert <- as.POSIXct(paste0(testTimes$pre_safetyscan_date_convert,
                                                           " ", testTimes$pre_safetyscan_time_hr,
                                                           ":", testTimes$pre_safetyscan_time_min,
                                                           ":", "00"), 
                                                    format = "%Y-%m-%d %H:%M:%S")

testTimes$consump_start_time_convert <- as.POSIXct(paste0(testTimes$pre_safetyscan_date_convert,
                                                          " ", testTimes$consump_start_time_hr, 
                                                          ":", testTimes$consump_start_time_min,
                                                          ":", "00"), 
                                                   format = "%Y-%m-%d %H:%M:%S")

testTimes$consump_end_time_convert <- as.POSIXct(paste0(testTimes$pre_safetyscan_date_convert,
                                                        " ", testTimes$consump_end_time_hr, 
                                                        ":", testTimes$consump_end_time_min, 
                                                        ":", "00"), 
                                                 format = "%Y-%m-%d %H:%M:%S")

testTimes$post_safetyscan_time_convert <- as.POSIXct(paste0(testTimes$pre_safetyscan_date_convert,
                                                            " ", testTimes$post_safetyscan_time_hr,
                                                            ":", testTimes$post_safetyscan_time_min,
                                                            ":", "00"), 
                                                     format = "%Y-%m-%d %H:%M:%S")

testTimes$postConsumpTimeToTest <- as.numeric(difftime(testTimes$post_safetyscan_time_convert,
                                                       testTimes$consump_end_time_convert,
                                                       units = "mins"))

testTimes$Post_PreTime <- as.numeric(difftime(testTimes$post_safetyscan_time_convert,
                                              testTimes$pre_safetyscan_time_convert,
                                              units = "mins"))

testTimes$remove <- ifelse(testTimes$subject_id == "001-056" & is.na(testTimes$postConsumpTimeToTest), 1, 0)
testTimes <- testTimes[testTimes$remove == 0, ]

# ## For subjects without a post Consumption to test time, we're using the time between pre and post test -- DO NOT "impute" this way -- JW 11/11/2022
# testTimes$postConsumpTimeToTest[is.na(testTimes$postConsumpTimeToTest)] <- testTimes$Post_PreTime[is.na(testTimes$postConsumpTimeToTest)]

pt.df <- merge(pt.df.w, testTimes[, c("subject_id", "postConsumpTimeToTest", "Post_PreTime")], 
               by = "subject_id")

by(pt.df$postConsumpTimeToTest, INDICES = list(pt.df$user_cat), summary)

plot(pt.df$Post_PreTime, pt.df$postConsumpTimeToTest)

ps <- merge(ps, testTimes[, c("subject_id", "postConsumpTimeToTest", "Post_PreTime")], 
               by = "subject_id")

non_user.id <- pt.df$subject_id[pt.df$user_cat == "non-user"]
# View(testTimes[testTimes$subject_id %in% non_user.id, ])
```

Add VAS data
```{r vasReadIn, eval = F}
### OLD DATA FILE MODIFIED WITH NEW DATA -- NEXT CHUNK
vs <- read_sas(file.path(data_folder, ps_folder, "urban102.sas7bdat"))

vs <- vs[, c("subject_id", "period", "vas")]

attr(vs$subject_id, "label") <- NULL
attr(vs$subject_id, "format.sas") <- NULL

vas.post <- vs[vs$period == "POST", ]
vas.post$period <- NULL
names(vas.post)[names(vas.post) == "vas"] <- "vas.post"

vas.pre <- vs[vs$period == "PRE", ]
vas.pre$period <- NULL
names(vas.pre)[names(vas.pre) == "vas"] <- "vas.pre"

vas.w <- merge(vas.pre, vas.post, by = "subject_id")

vas.w$diff <- vas.w$vas.post - vas.w$vas.pre
# summary(vas.w$diff)
## no difference between pre and post vas

vas.w <- vas.w[, c("subject_id", "vas.pre")]
names(vas.w)[names(vas.w) == "vas.pre"] <- "vas"

pt.df <- merge(pt.df, vas.w, 
               by = "subject_id", 
               all.x = T)

ps <- merge(ps, vas.w,
            by = "subject_id", 
            all.x = T)
```

```{r vasReadIn2}
vs <- read.xlsx(file.path(data_folder, ps_folder, 
                         "All CDPHE VAS Scores_30Nov2022.xlsx"), 
                sheet = "VAS")
### Data Dictionary
# "subject_id"
# "vas0_high_score" -- vas score for how high you feel at pre
# "vas0_score_dc" -- how confident you feel about driving at pre
# "vas1_high_score" -- vas score for how high you feel at post
# "vas1_score_dc" -- how confident you feel about driving at post

pt.df <- merge (pt.df, vs, 
                by = "subject_id", 
                all.x = T)
pt.df$vas_high_score_chg <- pt.df$vas1_high_score - pt.df$vas0_high_score
pt.df$vas_score_dc_chg <- pt.df$vas1_score_dc - pt.df$vas0_score_dc
```

## Table 1
No Consumption end time recorded for non-users
```{r tab1}
# Demographics Table by User Category
table1(~ demo_age + demo_weight+ demo_height+BMI + demo_gender + thc_chg + postConsumpTimeToTest + Post_PreTime + min_constriction_chg + AUC_chg + duration_chg + slope_chg + avg_end_percent_chg + vas1_high_score + vas_high_score_chg + vas1_score_dc + vas_score_dc_chg|user_cat, 
       data = pt.df)
```


### Find potential mis-aligned data streams
I'm looking for any sharp declines over 10 frames after the 150th frame and then visualizing those trajectories to determine if there might be misalignment of the light test start frame. 

```{r misAligned, eval = F}
ps$lagPctChg <- c(rep(0, 10), diff(ps$percent_change, lag = 10))
ps$lagID <- dplyr::lag(ps$subject_id, 10)
ps$lagtime <- dplyr::lag(ps$time, 10)
ps$lagEye <- dplyr::lag(ps$eye, 10)

ps$lagPctChg <- ifelse(ps$subject_id == ps$lagID & ps$time == ps$lagtime & ps$eye == ps$lagEye, 
                       ps$lagPctChg, 0)

summary(ps$lagPctChg[ps$frame > 150])

hist(ps$lagPctChg[ps$frame > 150], breaks = 1000)

ps.150 <- ps[ps$frame > 150  & ps$eye == "Left", ]

pot.misaligned <- unique(ps.150[ps.150$lagPctChg <= -15,  c("subject_id", "time", "user_type", "eye")])
pot.misaligned <- pot.misaligned[!(is.na(pot.misaligned$subject_id)), ]
pot.misaligned$misaligned  <- 1

misaligned <- merge(ps, pot.misaligned,
                    by= c("subject_id", "time", "user_type", "eye"), 
                    all.y = T)

mis.right <- misaligned[misaligned$eye == "Left", ]

misAlign.id <- unique(misaligned$subject_id)

for(i in misAlign.id){
  print(ggplot(mis.right[mis.right$subject_id == i, ], 
                              aes(x=frame, y = percent_change, 
                                  group = subject_id, color = i))+
                        geom_line()+
                        facet_grid(rows = vars(subject_id), cols = vars(tp))+
                        labs(title = paste0("Potential MisAligned Subject: ", i))+
                        theme_bw())
}


# jpeg(file.path(ps_folder, "Potential_Misaligned_001_109.jpg"), 
#      width = 12, height = 5, units = "in", res = 300)
# ggplot(mis.right[mis.right$subject_id == "001-109", ], 
#        aes(x=frame, y = percent_change, group = subject_id, color = subject_id))+
#   geom_line()+
#   facet_grid(rows = vars(subject_id), cols = vars(tp))+
#   labs(title = "Potential MisAligned ")+
#   theme_bw()
# dev.off()

# jpeg(file.path(ps_folder, "Potential_Misaligned_001_060.jpg"),
#      width = 12, height = 5, units = "in", res = 300)
# ggplot(mis.right[mis.right$subject_id == "001-060", ],
#        aes(x=frame, y = percent_change, group = subject_id, color = subject_id))+
#   geom_line()+
#   facet_grid(rows = vars(subject_id), cols = vars(tp))+
#   labs(title = "Potential MisAligned ")+
#   theme_bw()
# dev.off()

### New alignment view

# jpeg(file.path(ps_folder, "Potential_Misaligned_001_007.jpg"),
#      width = 12, height = 5, units = "in", res = 300)
# ggplot(mis.right[mis.right$subject_id == "001-007", ],
#        aes(x=frame, y = percent_change, group = subject_id, color = subject_id))+
#   geom_line()+
#   facet_grid(rows = vars(subject_id), cols = vars(tp))+
#   labs(title = "Potential MisAligned: start at 2nd bump?")+
#   theme_bw()
# dev.off()
# 
# jpeg(file.path(ps_folder, "Potential_Misaligned_001_033.jpg"),
#      width = 12, height = 5, units = "in", res = 300)
# ggplot(mis.right[mis.right$subject_id == "001-033", ],
#        aes(x=frame, y = percent_change, group = subject_id, color = subject_id))+
#   geom_line()+
#   facet_grid(rows = vars(subject_id), cols = vars(tp))+
#   labs(title = "Potential MisAligned: Odd pattern")+
#   theme_bw()
# dev.off()
# 
# jpeg(file.path(ps_folder, "Potential_Misaligned_001_038.jpg"),
#      width = 12, height = 5, units = "in", res = 300)
# ggplot(mis.right[mis.right$subject_id == "001-038", ],
#        aes(x=frame, y = percent_change, group = subject_id, color = subject_id))+
#   geom_line()+
#   facet_grid(rows = vars(subject_id), cols = vars(tp))+
#   labs(title = "Potential MisAligned: Odd pattern")+
#   theme_bw()
# dev.off()
# 
# jpeg(file.path(ps_folder, "Potential_Misaligned_001_043.jpg"),
#      width = 12, height = 5, units = "in", res = 300)
# ggplot(mis.right[mis.right$subject_id == "001-043", ],
#        aes(x=frame, y = percent_change, group = subject_id, color = subject_id))+
#   geom_line()+
#   facet_grid(rows = vars(subject_id), cols = vars(tp))+
#   labs(title = "Potential MisAligned: Both look odd, but mainly check pre; maybe review video")+
#   theme_bw()
# dev.off()
```

Remove Outliers
```{r outliers}
## Remove known outliers
ps$outliers <- 0
# ps$outliers[ps$subject_id == "001-109" & ps$tp == "pre2"] <- 1 # Ben revised
ps$outliers[ps$subject_id == "001-060" & ps$tp == "post"] <- 1

ps <- ps[ps$outliers == 0, ]
```

## Data Visualization
Plot of Pupil Size and Percent Change for "PRE" data by Eye and User Category
```{r pre_plots}
pre.df <- ps[ps$tp == "pre2", ] 

ggplot(pre.df, aes(x=frame/30, y = pupil_size, group = subject_id))+
  geom_line(alpha = 0.5, show.legend = FALSE)+
  facet_grid(rows = vars(user_cat), cols = vars(eye))+
  labs(title ="Pupil Size by Eye and THC use category", 
       x = "seconds")+
  theme_bw()


ggplot(pre.df, aes(x=frame/30, y = percent_change, group = subject_id))+
  geom_line(alpha = 0.5, show.legend = FALSE)+
  facet_grid(rows = vars(user_cat), cols = vars(eye))+
  labs(title = "Percent Change by Eye and THC use category", 
       x = "seconds")+
  theme_bw()
```

Plot of PRE/POST for Right Eye
```{r rightEye_plots}
right.df <- ps[ps$eye == "Right", ]

# ggplot(right.df, aes(x=frame/30, y = pupil_size, group = subject_id))+
#   geom_line(show.legend = FALSE, alpha = 0.5)+
#   facet_grid(rows = vars(user_cat), cols = vars(tp))+
#   labs(title ="Pupil Size by Pre/Post and THC use category", 
#        x = "seconds")+
#   theme_bw()

# jpeg(file.path(res_folder, "PrePost_Right_PercentChange.jpg"), 
#      height = 6, width = 8, res = 300, units = "in")
ggplot(right.df, aes(x=frame/30, y = percent_change, group = subject_id))+
  geom_line(show.legend = FALSE, alpha = 0.5)+
  facet_grid(rows = vars(user_cat), cols = vars(tp))+
  labs(title = "Percent Change by Pre/Post and THC use category", 
       x = "seconds")+
  theme_bw()
# dev.off()
```

Plots of Left and Right Eye for "POST" data. One pt has negative values for pupil size.
```{r post_plots}
post.df <- ps[ps$tp == "post", ] 

ggplot(post.df, aes(x=frame/30, y = percent_change, group = subject_id))+
  geom_line(show.legend = FALSE, alpha = 0.5)+
  facet_grid(rows = vars(user_cat), cols = vars(eye))+
  labs(title = "Percent Change by Eye and THC use category - Post", 
       x = "seconds")+
  theme_bw()

pre.df <- ps[ps$tp == "pre2", ] 

# jpeg(file.path(res_folder, "LeftRight_Pre_PercentChange.jpg"), 
#      height = 6, width = 8, res = 300, units = "in")
ggplot(pre.df, aes(x=frame/30, y = percent_change, group = subject_id))+
  geom_line(show.legend = FALSE, alpha = 0.5)+
  facet_grid(rows = vars(user_cat), cols = vars(eye))+
  labs(title = "Percent Change by Eye and THC use category - Pre", 
       x = "seconds")+
  theme_bw()
# dev.off()
```

# Exploratory Analysis

## Over all subjects and timepoints

### Mean Function
Plot the Mean and +/- 1 SD functions for the percent change in pupil light reflex data for the pre and post data by THC user category. (Added code to input frame numbers when NA). 

```{r mean_sd_functions}
right_0.df <- right.df[right.df$frame >= 0, c("subject_id", "tp", "user_cat", 
                                              "frame", "percent_change")]

right_0.df <- right_0.df[order(right_0.df$subject_id, right_0.df$tp, right_0.df$frame), ]

right_0.w <- reshape(right_0.df, 
                     timevar = "frame", 
                     idvar = c("subject_id", "tp", "user_cat"), 
                     direction = "wide")

rownames(right_0.w) <- paste0(right_0.w$subject_id, "_", right_0.w$tp)
pct_chg <- names(right_0.w[, 4:602])


mean_fxn <- as.data.frame(aggregate(right_0.w[, 4:602], 
                                    list(right_0.w$tp, 
                                         right_0.w$user_cat),
                                    FUN = function(x) mean(x, na.rm = T)))

mean_fxn.l <- reshape(mean_fxn, 
                      varying = pct_chg, 
                      v.names = "percent_change", 
                      timevar = "frame", 
                      times = pct_chg, 
                      direction = "long")
mean_fxn.l$frame <- as.numeric(gsub("percent_change.", "", mean_fxn.l$frame))
rownames(mean_fxn.l) <- NULL
mean_fxn.l$id <- NULL

names(mean_fxn.l)[names(mean_fxn.l) == "Group.1"] <- "tp"
names(mean_fxn.l)[names(mean_fxn.l) == "Group.2"] <- "user_cat"


mean_fxn.l$grp <- paste0(mean_fxn.l$tp, "_", mean_fxn.l$user_cat)

ggplot(mean_fxn.l, aes(x=frame/30, y = percent_change, group = grp,  
                       color = user_cat))+
  geom_line()+
  facet_grid(rows = vars(tp))+
  labs(title = "Average Percent Change by Pre/Post and THC use category",
       x = "seconds")+
  theme_bw()

sd_fxn <- as.data.frame(aggregate(right_0.w[, 4:602], 
                                    list(right_0.w$tp, 
                                         right_0.w$user_cat),
                                    FUN = function(x) sd(x, na.rm = T)))

```
NA's are when there's no data in for that time point and user category. Min frame value for NA is 480. 

### fPCA all subjects and timepoints

```{r getLegend, echo = F}
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}
```

```{r, pcPlotFxn, echo = F}
pcPlot.fxn <- function(df, errband, labtitle, ymin, ymax){
  colors <- c("Pop.Mean" = "black", "+2SD" = "red", "-2SD" = "blue")
  
  ggplot(data = df, aes(x = seconds, y = mu))+
    geom_line(aes(color = "Pop.Mean"))+
    geom_line(aes(x = seconds, y = mu + {{errband}}, color = "+2SD"))+
    geom_line(aes(x = seconds, y = mu - {{errband}}, color = "-2SD"))+
    labs(x = "seconds", 
         y = "Percent Change", 
         color = "Legend", 
         title = labtitle)+
    scale_color_manual(values = colors)+
    scale_y_continuous(limits = c(ymin, ymax))+
    theme_bw()
}
```

Truncating to frame 400
```{r fPCA_all, fig.height = 8, fig.width = 20}
right_0.fpca <- fpca.face(Y = as.matrix(right_0.w[, 4:404]), pve = 0.95, knots = 30, var = T)
# str(right_0.fpca)

# plot_shiny(right_0.fpca)
right_0.fpca.pve <- round(right_0.fpca$evalues/sum(right_0.fpca$evalues)*100, 2)
# right_0.fpca.pve

mu <- right_0.fpca$mu
right_sd <- sqrt(right_0.fpca$evalues)
right_Phi <- right_0.fpca$efunctions

df_plot <- data.frame(seconds = seq(0, 400, by = 1)/30, 
                      mu = mu, 
                      errband1 = 2*right_Phi[, 1]*right_sd[1], 
                      errband2 = 2*right_Phi[, 2]*right_sd[2], 
                      errband3 = 2*right_Phi[, 3]*right_sd[3], 
                      errband4 = 2*right_Phi[, 4]*right_sd[4],
                      errband5 = 2*right_Phi[, 5]*right_sd[5]
                      )

ylim_max = max(df_plot$mu) + max(df_plot [, c("errband1", "errband2","errband3","errband4","errband5")], na.rm = T)
ylim_min =  min(df_plot$mu) - max(df_plot [, c("errband1", "errband2","errband3","errband4","errband5")], na.rm = T)

colors <- c("Pop.Mean" = "black", "+2SD" = "red", "-2SD" = "blue")

plot_pc1 <- pcPlot.fxn(df = df_plot, errband = errband1, 
                       labtitle = paste("PC1:", "% Var Explained:", 
                                        right_0.fpca.pve[1]), 
                       ymin = ylim_min, ymax = ylim_max)

plot_pc2 <- pcPlot.fxn(df = df_plot, errband = errband2, 
                       labtitle = paste("PC2:", "% Var Explained:", 
                                        right_0.fpca.pve[2]), 
                       ymin = ylim_min, ymax = ylim_max)

plot_pc3 <- pcPlot.fxn(df = df_plot, errband = errband3, 
                       labtitle = paste("PC3:", "% Var Explained:", 
                                        right_0.fpca.pve[3]), 
                       ymin = ylim_min, ymax = ylim_max)

plot_pc4 <- pcPlot.fxn(df = df_plot, errband = errband4, 
                       labtitle = paste("PC4:", "% Var Explained:", 
                                        right_0.fpca.pve[4]), 
                       ymin = ylim_min, ymax = ylim_max)

plot_pc5 <- pcPlot.fxn(df = df_plot, errband = errband5, 
                       labtitle = paste("PC5:", "% Var Explained:", 
                                        right_0.fpca.pve[5]), 
                       ymin = ylim_min, ymax = ylim_max)

legend_postPC <- g_legend(plot_pc1)

blank <- grid.rect(gp=gpar(col="white"))

grid.arrange(plot_pc1+theme(legend.position = "none"),
             plot_pc2+theme(legend.position = "none"),
             plot_pc3+theme(legend.position = "none"),
             plot_pc4+theme(legend.position = "none"),
             plot_pc5+theme(legend.position = "none"),
             blank,
             legend_postPC,
             layout_matrix = rbind(c(1,2,3,7), c(4,5, 6 , 7)),
             widths = c(10, 10, 10, 3),
             nrow = 2, ncol = 4)

# jpeg(file.path(res_folder, "Post_PC4.jpg"), 
#      height = 6, width = 8, res = 300, units = "in")
grid.arrange(plot_pc1+theme(legend.position = "none"),
             plot_pc2+theme(legend.position = "none"),
             plot_pc3+theme(legend.position = "none"),
             plot_pc4+theme(legend.position = "none"),
             legend_postPC,
             layout_matrix = rbind(c(1,2,5), c(3,4,5)),
             widths = c(10, 10, 3),
             nrow = 2, ncol = 3)
# dev.off()

```


*PC1 plot: Individuals with low loading on PC1 (-2SD) have less constriction than the average and individuals with a high loading (+2SD) have more constriction. Rebound effect? *

*PC2 plot: Overall shape of trajectory & pattern of recovery*

Plot individuals with high/low PC2 overall scores. 
```{r plot_highPC2, eval = F}
right_scores <- right_0.fpca$scores
q.95 <- quantile(right_scores[, 2], p = 0.95)

highPC2 <- rownames(right_scores)[right_scores[, 2] > q.95]

highPC2.df <- data.frame(subject_id = substr(highPC2, 1, 7), 
                         tp = substr(highPC2, 9,12))


for(i in 1:nrow(highPC2.df)){
  plot.df <- right_0.df[right_0.df$subject_id == highPC2.df$subject_id[i] & right_0.df$tp == highPC2.df$tp[i], ]
  print(ggplot(plot.df, aes(x=frame, y = percent_change, group = subject_id, color = subject_id))+
          geom_line(show.legend = FALSE)+
          labs(title = paste("Percent Change for high PC2 score --", "Subject:",
                             highPC2.df$subject_id[i], "Timepoint:", highPC2.df$tp[i]), 
               x = "seconds")+
          theme_bw())
}
```

```{r lowPC2Scores, eval = F}
q.05 <- quantile(right_scores[, 2], p = 0.05)

lowPC2 <- rownames(right_scores)[right_scores[, 2] < q.05]

lowPC2.df <- data.frame(subject_id = substr(lowPC2, 1, 7), 
                         tp = substr(lowPC2, 9,12))


for(i in 1:nrow(lowPC2.df)){
  plot.df <- right_0.df[right_0.df$subject_id == lowPC2.df$subject_id[i] & right_0.df$tp == lowPC2.df$tp[i], ]
  print(ggplot(plot.df, aes(x=frame/30, y = percent_change, group = subject_id, color = subject_id))+
          geom_line(show.legend = FALSE)+
          labs(title = paste("Percent Change for low PC2 score --", "Subject:", lowPC2.df$subject_id[i], "Timepoint:",                                      lowPC2.df$tp[i]), 
               x = "seconds")+
          theme_bw())
}

```

## Create Analytic Sample
Make sure datasets have the same participants and are truncated at frame 400

```{r interpolateMissing}
ps <- ps[ps$frame >= 0 & ps$frame <= 400, 
         c("subject_id", "tp", "eye", "frame", "percent_change")]

ps <- ps[order(ps$subject_id, ps$tp, ps$eye, ps$frame), ]
ps$frame_char <- str_pad(ps$frame, width = 3, side = c("left"), pad = "0")
ps$frame <- NULL

ps.w <- reshape(ps[, c("subject_id","tp", "eye", "frame_char", "percent_change")], 
                          timevar = "frame_char", 
                          idvar = c("subject_id", "tp", "eye"), 
                          direction = "wide")
var.names <-  c(names(ps.w)[1:3], sort(names(ps.w)[4:404]))

ps.w <- ps.w[, var.names]

id.names <- paste(ps.w$subject_id, ps.w$tp, ps.w$eye, sep = "_")
rownames(ps.w) <- id.names

missData <- apply(ps.w[, 4:404], MARGIN = 1, FUN = function(x) sum(is.na(x)))

missInterpolate <- function(x){
  z <- zoo(x, order.by = seq(0:400))
  y <- na.approx(z, maxgap = 3, na.rm = FALSE)
  
  return(as.numeric(y))
}

test <- apply(ps.w[, 4:404], 
              MARGIN = 1, 
              FUN = missInterpolate)

ps.w <- data.frame(t(test))

names(ps.w) <- var.names[4:404]

ps.w$subject_id <- substr(rownames(ps.w), 1, 7)
ps.w$tp <- ifelse(grepl("pre2", rownames(ps.w)) == T, "pre2", "post")
ps.w$eye <- ifelse(grepl("Left", rownames(ps.w)) == T, "Left", "Right")

ps.w <- ps.w[, var.names]

pctChg.names <- var.names[4:404]

ps <- reshape(ps.w,
              varying = pctChg.names, 
              v.names = "percent_change",
              timevar = "frame", 
              times = 0:400,
              idvar = c("subject_id", "tp", "eye"),
              direction = "long")

ps <- ps[order(ps$subject_id, ps$tp, ps$eye), ]
```


```{r analyticN}
right_0.post <- ps[ps$tp == "post" & ps$eye == "Right", ]
post.ids <- unique(right_0.post$subject_id)

right_0.post.w <- ps.w[ps.w$tp == "post" & ps.w$eye == "Right", ]

right_0.pt <- reshape(ps[ps$eye == "Right", ], 
                      timevar = "tp", 
                      idvar = c("subject_id", "frame"), 
                      direction = "wide")

right_0.pt$wiPctChg <- right_0.pt$percent_change.post - right_0.pt$percent_change.pre2

right_0.pt <- right_0.pt[, c("subject_id", "frame", "wiPctChg")]

right_0.pt.w <- reshape(right_0.pt[, c("subject_id", "frame", "wiPctChg")], 
                     timevar = "frame", 
                     idvar = "subject_id", 
                     direction = "wide")

# remove rows where all data is missing (e.g. pt didn't have both pre and post)
allMissing <- rowSums(is.na(right_0.pt.w[, 2:402]))
rowsAllMissing <- names(allMissing)[allMissing == 401]

right_0.pt.w <- right_0.pt.w[!(rownames(right_0.pt.w) %in% rowsAllMissing), ]

################################# ----------------------------- Left eye
left_0.post <- ps[ps$tp == "post" & ps$eye == "Left", ]
left.post.ids <- unique(left_0.post$subject_id)

left_0.post.w <- ps.w[ps.w$tp == "post" & ps.w$eye == "Left", ]

left_0.pt <- reshape(ps[ps$eye == "Left", ], 
                      timevar = "tp", 
                      idvar = c("subject_id", "frame"), 
                      direction = "wide")

left_0.pt$wiPctChg <- left_0.pt$percent_change.post - left_0.pt$percent_change.pre2

left_0.pt <- left_0.pt[, c("subject_id", "frame", "wiPctChg")]

left_0.pt.w <- reshape(left_0.pt[, c("subject_id", "frame", "wiPctChg")], 
                     timevar = "frame", 
                     idvar = "subject_id", 
                     direction = "wide")

# remove rows where all data is missing (e.g. pt didn't have both pre and post)
allMissing <- rowSums(is.na(left_0.pt.w[, 2:402]))
rowsAllMissing <- names(allMissing)[allMissing == 401]

left_0.pt.w <- left_0.pt.w[!(rownames(left_0.pt.w) %in% rowsAllMissing), ]

## Find intersection of all participant files across data sets to define the analytic subjects

analytic.N <- intersect(unique(right_0.post$subject_id), unique(right_0.pt$subject_id))
analytic.N <- intersect(analytic.N, unique(right_0.post.w$subject_id))
analytic.N <- intersect(analytic.N, unique(right_0.pt.w$subject_id))

analytic_L.N <- intersect(unique(left_0.post.w$subject_id), unique(left_0.post$subject_id))
analytic_L.N <- intersect(analytic.N, unique(left_0.pt$subject_id))
analytic_L.N <- intersect(analytic.N, unique(left_0.pt.w$subject_id))

analytic_LR.N <- intersect(analytic.N, analytic_L.N)

## Filter all datasets to analytic sample

left_0.post <- left_0.post[left_0.post$subject_id %in% analytic_LR.N, ]
left_0.post$seconds <- left_0.post$frame/30
left_0.post.w <- left_0.post.w[left_0.post.w$subject_id %in% analytic_LR.N ,]
row.names(left_0.post.w) <- left_0.post.w$subject_id

left_0.post <- merge(left_0.post, pt.df[, c("subject_id", "user_cat")], 
                     by = "subject_id", 
                     all.x = T)
left_0.post.w <- merge(left_0.post.w, pt.df[, c("subject_id", "user_cat")], 
                     by = "subject_id", 
                     all.x = T)

rownames(left_0.post.w) <- left_0.post.w$subject_id

left_0.pt <- left_0.pt[left_0.pt$subject_id %in% analytic_LR.N, ]
left_0.pt$seconds <- left_0.pt$frame/30
left_0.pt.w <- left_0.pt.w[left_0.pt.w$subject_id %in% analytic_LR.N, ]
row.names(left_0.pt.w) <- left_0.pt.w$subject_id

left_0.pt <- merge(left_0.pt, pt.df[, c("subject_id", "user_cat")], 
                     by = "subject_id", 
                     all.x = T)
left_0.pt.w <- merge(left_0.pt.w, pt.df[, c("subject_id", "user_cat")], 
                     by = "subject_id", 
                     all.x = T)

rownames(left_0.pt.w) <- left_0.pt.w$subject_id

## Filter all datasets to analytic sample
right_0.post <- right_0.post[right_0.post$subject_id %in% analytic.N, ]
right_0.post$seconds <- right_0.post$frame/30
right_0.post.w <- right_0.post.w[right_0.post.w$subject_id %in% analytic.N ,]
row.names(right_0.post.w) <- right_0.post.w$subject_id

right_0.post <- merge(right_0.post, pt.df[, c("subject_id", "user_cat")], 
                     by = "subject_id", 
                     all.x = T)
right_0.post.w <- merge(right_0.post.w, pt.df[, c("subject_id", "user_cat")], 
                     by = "subject_id", 
                     all.x = T)

rownames(right_0.post.w) <- right_0.post.w$subject_id

right_0.pt <- right_0.pt[right_0.pt$subject_id %in% analytic.N, ]
right_0.pt$seconds <- right_0.pt$frame/30
right_0.pt.w <- right_0.pt.w[right_0.pt.w$subject_id %in% analytic.N, ]

right_0.pt <- merge(right_0.pt, pt.df[, c("subject_id", "user_cat")], 
                     by = "subject_id", 
                     all.x = T)
right_0.pt.w <- merge(right_0.pt.w, pt.df[, c("subject_id", "user_cat")], 
                     by = "subject_id", 
                     all.x = T)

rownames(right_0.pt.w) <- right_0.pt.w$subject_id

pt.analytic.df <- pt.df[pt.df$subject_id %in% analytic.N,]
```

Send Merged dataset to Dr. Wrobel (20221128)
```{r finDF, eval=FALSE}
right_0.post <- merge(right_0.post, pt.df, 
                      by = "subject_id")

right_0.pt <- merge(right_0.pt, pt.df, 
                      by = "subject_id")

saveRDS(right_0.post, file.path(data_folder, ps_folder,
                                "PupilLightReflex_POST_rightEye_20221208.rds"))

saveRDS(right_0.pt, file.path(data_folder, ps_folder,
                                "PupilLightReflex_WPD_rightEye_20221208.rds"))

saveRDS(pt.analytic.df, file.path(data_folder, ps_folder,
                                "PupilLightReflex_PtData_20221208.rds"))

```


No Consumption end time recorded for non-users
```{r tab1_analyticN}
# Demographics Table by User Category
table1(~demo_age + demo_weight+ demo_height+BMI + demo_gender + thc_chg + postConsumpTimeToTest + Post_PreTime + min_constriction_chg + AUC_chg + duration_chg + slope_chg + avg_end_percent_chg +vas1_high_score + vas_high_score_chg + vas1_score_dc + vas_score_dc_chg|user_cat, 
       data = pt.df[pt.df$subject_id %in% analytic.N, ])
```


## Post Data 
```{r postPlot}
post.user <- ggplot(right_0.post, aes(x=seconds, y = percent_change, group = subject_id))+
             geom_line(show.legend = FALSE, alpha = 0.5)+
             facet_grid(rows = vars(user_cat))+
             labs(title ="POST data percent change by THC use category")+
             theme_bw()

post.user
```
## Within Subject 
### Mean function

Calculate the difference (post-pre) within subjects and plot by THC user category

```{r wi_subj_mean, warning=F, fig.height = 8, fig.width = 15}
wi.user <- ggplot(right_0.pt, aes(x=seconds, y = wiPctChg, group = subject_id))+
           geom_line(show.legend = FALSE, alpha = 0.5)+
           facet_grid(rows = vars(user_cat))+
           labs(title ="Within subject difference in percent change by THC use category")+
           theme_bw()

wi.user
# jpeg(file.path(res_folder, "Post_WPD_Trajectories.jpg"), 
#      height = 5, width = 12, res = 300, units = "in")
grid.arrange(post.user, wi.user, nrow = 1)
# dev.off()
```
*Non-user plot seems "centered" around 0 but still showing heterogeneity. Lots of heterogeneity across user-groups, but a mostly positive difference.*

## Plot the mean and +/- 1 SD functions for within subject different in percent change
```{r wi_mean_fxn}
mean_fxn.pt <- as.data.frame(aggregate(right_0.pt.w[, 2:402], 
                                    list(right_0.pt.w$user_cat),
                                    FUN = function(x) mean(x, na.rm = T)))
wiPctChg <- names(right_0.pt.w)[2:402]

mean_fxn.pt.l <- reshape(mean_fxn.pt, 
                      varying = wiPctChg, 
                      v.names = "wi_percent_change", 
                      timevar = "frame", 
                      times = wiPctChg, 
                      direction = "long")

mean_fxn.pt.l$frame <- as.numeric(gsub("wiPctChg.", "", mean_fxn.pt.l$frame))
rownames(mean_fxn.pt.l) <- NULL
mean_fxn.pt.l$id <- NULL

names(mean_fxn.pt.l)[names(mean_fxn.pt.l) == "Group.1"] <- "user_cat"

ggplot(mean_fxn.pt.l, aes(x=frame/30, y = wi_percent_change, group = user_cat, color = user_cat))+
  geom_line()+
  labs(title ="Average Within subject difference in percent change by THC use category", 
       x = "seconds")+
  theme_bw()
```

*Difference in trajectories (post-pre), show a distinct difference between non-user and both user groups (up to frame 200), but the differences might not be significant. Harder to distinguish between the occasional and daily user trajectories.*

```{r wi_sd_fxn}
# Check to make sure there are significant numbers in each user category
table(right_0.pt.w$user_cat)

sd_fxn.pt <- as.data.frame(aggregate(right_0.pt.w[, 2:402], 
                                    list(right_0.pt.w$user_cat),
                                    FUN = function(x) sd(x, na.rm = T)))
wiPctChg <- names(right_0.pt.w)[2:402]

sd_fxn.pt.l <- reshape(sd_fxn.pt, 
                      varying = wiPctChg, 
                      v.names = "wi_percent_change", 
                      timevar = "frame", 
                      times = wiPctChg, 
                      direction = "long")

sd_fxn.pt.l$frame <- as.numeric(gsub("wiPctChg.", "", sd_fxn.pt.l$frame))
rownames(sd_fxn.pt.l) <- NULL
sd_fxn.pt.l$id <- NULL

names(sd_fxn.pt.l)[names(sd_fxn.pt.l) == "Group.1"] <- "user_cat"
sd_fxn.pt.l$wi_percent_change_neg <- -1*sd_fxn.pt.l$wi_percent_change

ggplot(sd_fxn.pt.l, aes(x=frame/30, y = wi_percent_change, group = user_cat, color = user_cat))+
  geom_line()+
  geom_line(aes(x=frame/30, y = wi_percent_change_neg, group = user_cat, color = user_cat), 
            linetype = "dashed")+
  labs(title ="+/- 1 SD Within subject difference in percent change by THC use category", 
       x = "seconds")+
  theme_bw()
```

## Missing Data for Within Subject Differences

```{r missingness_wiSubj}
## number of missing data points in each column
missingnessCol <- apply(right_0.pt.w[, 2:402], 
                        MARGIN = 2, 
                        FUN = function(x) sum(is.na(x)))

sum(missingnessCol == 0) ## 140 columns without any missing data
sum(missingnessCol == 84) ## 109 columns with all missing data
sum(missingnessCol <= 68) ## 438 columns where at least 80% of participants have data
hist(missingnessCol, breaks = 30)

missing.df <- data.frame(frame = seq(0, 400, by =1), 
                            missingness = round(missingnessCol/nrow(right_0.pt.w)*100, 2), 
                            stringsAsFactors = F)

ggplot(missing.df, aes(x=frame/30, y= missingness))+
  geom_line()
```
Truncate within person difference data to frame 400 where missingness reaches 50%. 

Try to visualize missing data in within person data frame
```{r visMissing}

wi_pct_chg <- names(right_0.pt.w)[2:402]

right_0.pt.l <- reshape(right_0.pt.w,
                        varying = wi_pct_chg,
                        v.names = "wi_pct_chg_diff", 
                        timevar = 'frame', 
                        times = wi_pct_chg,
                        direction = "long")
                        
right_0.pt.l$frame <- as.numeric(gsub("wiPctChg.", "", right_0.pt.l$frame))
rownames(right_0.pt.l) <- NULL
right_0.pt.l$id <- NULL


right_0.pt.l$notMissing <- ifelse(is.na(right_0.pt.l$wi_pct_chg_diff), 0, 1)

ggplot(right_0.pt.l, aes(x = as.factor(frame), y = subject_id, fill = as.factor(notMissing)))+
  geom_raster(alpha = 0.8)+
  scale_fill_manual(values = c("black", 'white'), 
                    labels = c("Missing", "Present"))+
  scale_x_discrete(breaks = seq(0, 400, by = 25))+
  geom_vline(xintercept = 350,color = "darkred")+
  geom_vline(xintercept = 375,color = "darkblue")+
  theme(axis.text.x=element_text(angle = 45, vjust = 1, hjust = 1))
```


### fPCA Within Person Differences
```{r fPCA_withinPersonChange, fig.width = 20, fig.height=8}
right_0_wi.fpca <- fpca.face(Y = as.matrix(right_0.pt.w[, 2:402]), pve = 0.95, knots = 30, var = T)
# str(right_0.fpca)

# plot_shiny(right_0.fpca)
right_0_wi.fpca.pve <- round(right_0_wi.fpca$evalues/sum(right_0_wi.fpca$evalues)*100, 2)

mu <- right_0_wi.fpca$mu
right_sd <- sqrt(right_0_wi.fpca$evalues)
right_Phi <- right_0_wi.fpca$efunctions 

wi.df_plot <- data.frame(seconds = seq(0, 400, by = 1)/30, 
                      mu = mu, 
                      errband1 = 2*right_Phi[, 1]*right_sd[1], 
                      errband2 = 2*right_Phi[, 2]*right_sd[2], 
                      errband3 = 2*right_Phi[, 3]*right_sd[3], 
                      errband4 = 2*right_Phi[, 4]*right_sd[4], 
                      errband5 = 2*right_Phi[, 5]*right_sd[5], 
                      errband6 = 2*right_Phi[, 6]*right_sd[6])


wi.ylim_max = max(wi.df_plot$mu) + max(wi.df_plot [, c("errband1", "errband2","errband3","errband4","errband5", "errband6")], na.rm = T)
wi.ylim_min =  min(wi.df_plot$mu) - max(wi.df_plot [, c("errband1", "errband2","errband3","errband4","errband5", "errband6")], na.rm = T)


wi.plot_pc1 <- pcPlot.fxn(df = wi.df_plot, errband = errband1, 
                       labtitle = paste("PC1:", "% Var Explained:", 
                                        right_0_wi.fpca.pve[1]), 
                       ymin = wi.ylim_min, ymax = wi.ylim_max)

wi.plot_pc2 <- pcPlot.fxn(df = wi.df_plot, errband = errband2, 
                       labtitle = paste("PC2:", "% Var Explained:", 
                                        right_0_wi.fpca.pve[2]), 
                       ymin = wi.ylim_min, ymax = wi.ylim_max)

wi.plot_pc3 <- pcPlot.fxn(df = wi.df_plot, errband = errband3, 
                       labtitle = paste("PC3:", "% Var Explained:", 
                                        right_0_wi.fpca.pve[3]), 
                       ymin = wi.ylim_min, ymax = wi.ylim_max)

wi.plot_pc4 <- pcPlot.fxn(df = wi.df_plot, errband = errband4, 
                       labtitle = paste("PC4:", "% Var Explained:", 
                                        right_0_wi.fpca.pve[4]), 
                       ymin = wi.ylim_min, ymax = wi.ylim_max)

wi.plot_pc5 <- pcPlot.fxn(df = wi.df_plot, errband = errband5, 
                       labtitle = paste("PC5:", "% Var Explained:", 
                                        right_0_wi.fpca.pve[5]), 
                       ymin = wi.ylim_min, ymax = wi.ylim_max)

wi.plot_pc6 <- pcPlot.fxn(df = wi.df_plot, errband = errband6, 
                       labtitle = paste("PC6:", "% Var Explained:", 
                                        right_0_wi.fpca.pve[6]), 
                       ymin = wi.ylim_min, ymax = wi.ylim_max)

legend_wiPC <- g_legend(wi.plot_pc1)

grid.arrange(wi.plot_pc1+theme(legend.position = "none"), 
             wi.plot_pc2+theme(legend.position = "none"), 
             wi.plot_pc3+theme(legend.position = "none"), 
             wi.plot_pc4+theme(legend.position = "none"),
             wi.plot_pc5+theme(legend.position = "none"),
             wi.plot_pc6+theme(legend.position = "none"),
             legend_wiPC,
             layout_matrix = rbind(c(1,2,3, 7), c(4, 5, 6, 7)),
             widths = c(10, 10, 10, 3),
             nrow = 2, ncol = 4)

# jpeg(file.path(res_folder, "WPD_PC4.jpg"), 
#      height = 6, width = 8, res = 300, units = "in")
grid.arrange(wi.plot_pc1+theme(legend.position = "none"), 
             wi.plot_pc2+theme(legend.position = "none"), 
             wi.plot_pc3+theme(legend.position = "none"), 
             wi.plot_pc4+theme(legend.position = "none"),
             legend_wiPC,
             layout_matrix = rbind(c(1,2,5), c(3,4,5)),
             widths = c(10, 10, 3),
             nrow = 2, ncol = 3)
# dev.off()

```

PC1: Individuals with high scores on PC1 have a weaker minimal constriction at post compared to pre. Individuals with low scores on PC1 have a stronger minimal constriction at post compared to pre.

PC2: Individuals with high loading on PC2 have a weaker initial constriction at post and a stronger rebound dilation past the 200th frame. Individuals with a low loading on PC2 have a stronger initial constriction at paost and a weaker rebound dilation past the 200th frame.

```{r wi_scores}
wi.scores <- as.data.frame(right_0_wi.fpca$scores)
names(wi.scores) <- c("PC1", "PC2", "PC3", "PC4", "PC5", "PC6")
wi.scores$subject_id <- rownames(wi.scores)

pt.wi.scores <- merge(wi.scores, pt.df, 
                      by = "subject_id", 
                      all.x = T)

pt.wi.scores$smoker <- ifelse(pt.wi.scores$user_cat %in% c("daily", "occasional"),1, 0)
```


```{r explore_PC1, eval = F}
# pc_ind_plots <- function(scores.df, raw.df, pc_plot.df, q, pc= "PC1", id = "subject_id", pc.val = 1, pc_plot.var = "wiPctChg", raw.plot.var = "percent_change"){
#   q.pc <- quantile(scores.df[, pc], probs = q)
#   q.ids <- scores.df[scores.df[, pc] > q.pc, id]
#   
#   q.df <- pc_plot.df[pc_plot.df[, id] %in% q.ids, ]
#   
#   colors <- c("Pop.Mean" = "black", "+2SD" = "red", "-2SD" = "blue")
#   
#   print(ggplot(data = pc_plot.df, aes(x=frame, y = mu))+
#         geom_line(aes(color = "Pop.Mean"))+
#         geom_line(aes(x = frame, y = mu+ pc_plot.df[, 2+pc.val], color = "+2SD"))+
#         geom_line(aes(x = frame, y = mu- pc_plot.df[, 2+pc.val], color = "-2SD"))+
#         labs(x = "frame",
#              y = "Percent Change",
#              color = "Legend",
#              title = paste0("Individuals in the ", q*100,"th Percentile of PC1 scores"))+
#         geom_line(data = q.df, aes(x=frame, y = pc_plot.var, group = id))+
#         #scale_color_manual(values = colors)+
#         theme_bw())
#   
#   for(i in q.ids){
#   print(ggplot(data = raw.df[raw.df[, id] == i, ], 
#                aes(x = frame, y = raw.plot.var, group = tp, color = tp))+
#   geom_line()+
#   labs(title = paste0(i, " Pre/Post: ", q*100 , "th Percentile PC1 scores"))+
#   theme_bw())
#   }
# }

# pc_ind_plots(scores.df = wi.scores, 
#              raw.df = right_0.df, 
#              pc_plot.df = right_0.pt, 
#              q = 0.95, pc = "PC1", id = "subject_id", pc.val = 1, pc_plot.var = "wiPctChg", raw.plot.var = "percent_change")

q.95 <- quantile(wi.scores$PC1, probs = 0.95)

pctile95.wi <- wi.scores$subject_id[wi.scores$PC1 > q.95] 

pctile95.wi.df <- right_0.pt[right_0.pt$subject_id %in% pctile95.wi, ]

ggplot(data = wi.df_plot, aes(x = seconds, y = mu))+
  geom_line(aes(color = "Pop.Mean"))+
  geom_line(aes(x = seconds, y = mu+errband1, color = "+2SD"))+
  geom_line(aes(x = seconds, y = mu-errband1, color = "-2SD"))+
  labs(x = "seconds", 
       y = "Percent Change", 
       color = "Legend", 
       title = "Individuals in the Top 5th Percentile of PC1 scores")+
  geom_line(data = pctile95.wi.df, aes(x=frame/30, y = wiPctChg, group = subject_id, color = subject_id))+
  scale_color_manual(values = colors)+
  theme_bw()

for(i in pctile95.wi){
  print(ggplot(data = right_0.post[right_0.post$subject_id == i, ], 
               aes(x = seconds, y = percent_change, group = tp, color = tp))+
  geom_line()+
  labs(title = paste0(i, " Pre/Post: Top 5th Percentile PC1 scores"))+
  theme_bw())
}

q.05 <- quantile(wi.scores$PC1, probs = 0.05)

pctile05.wi <- wi.scores$subject_id[wi.scores$PC1 < q.05] 

pctile05.wi.df <- right_0.pt[right_0.pt$subject_id %in% pctile05.wi, ]

ggplot(data = wi.df_plot, aes(x = seconds, y = mu))+
  geom_line(aes(color = "Pop.Mean"))+
  geom_line(aes(x = seconds, y = mu+errband1, color = "+2SD"))+
  geom_line(aes(x = seconds, y = mu-errband1, color = "-2SD"))+
  labs(x = "frame", 
       y = "Percent Change", 
       color = "Legend", 
       title = "Individuals in the 5th Percentile of PC1 scores")+
  geom_line(data = pctile05.wi.df, aes(x=frame/30, y = wiPctChg, group = subject_id, color = subject_id))+
  scale_color_manual(values = colors)+
  theme_bw()

for(i in pctile05.wi){
  print(ggplot(data = right_0.post[right_0.post$subject_id == i, ], 
               aes(x = seconds, y = percent_change, group = tp, color = tp))+
  geom_line()+
  labs(title = paste0(i, " Pre/Post: 5th Percentile PC1 scores"))+
  theme_bw())
}

```


```{r explore_PC2, eval = F}

q.95 <- quantile(wi.scores$PC2, probs = 0.95)

pctile95.wi <- wi.scores$subject_id[wi.scores$PC2 > q.95] 

pctile95.wi.df <- right_0.pt[right_0.pt$subject_id %in% pctile95.wi, ]

ggplot(data = wi.df_plot, aes(x = seconds, y = mu))+
  geom_line(aes(color = "Pop.Mean"))+
  geom_line(aes(x = seconds, y = mu+errband2, color = "+2SD"))+
  geom_line(aes(x = seconds, y = mu-errband2, color = "-2SD"))+
  labs(x = "frame", 
       y = "Percent Change", 
       color = "Legend", 
       title = "Individuals in the Top 5th Percentile of PC2 scores")+
  geom_line(data = pctile95.wi.df, aes(x=frame/30, y = wiPctChg, group = subject_id, color = subject_id))+
  scale_color_manual(values = colors)+
  theme_bw()

for(i in pctile95.wi){
  print(ggplot(data = right_0.post[right_0.post$subject_id == i, ], 
               aes(x = seconds, y = percent_change, group = tp, color = tp))+
  geom_line()+
  labs(title = paste0(i, " Pre/Post: Top 5th Percentile PC2 scores"))+
  theme_bw())
}

q.05 <- quantile(wi.scores$PC2, probs = 0.05)

pctile05.wi <- wi.scores$subject_id[wi.scores$PC2 < q.05] 

pctile05.wi.df <- right_0.pt[right_0.pt$subject_id %in% pctile05.wi, ]

ggplot(data = wi.df_plot, aes(x = seconds, y = mu))+
  geom_line(aes(color = "Pop.Mean"))+
  geom_line(aes(x = seconds, y = mu+errband2, color = "+2SD"))+
  geom_line(aes(x = seconds, y = mu-errband2, color = "-2SD"))+
  labs(x = "frame", 
       y = "Percent Change", 
       color = "Legend", 
       title = "Individuals in the 5th Percentile of PC2 scores")+
  geom_line(data = pctile05.wi.df, aes(x=frame/30, y = wiPctChg, group = subject_id, color = subject_id))+
  scale_color_manual(values = colors)+
  theme_bw()

for(i in pctile05.wi){
  print(ggplot(data = right_0.post[right_0.post$subject_id == i, ], 
               aes(x = seconds, y = percent_change, group = tp, color = tp))+
  geom_line()+
  labs(title = paste0(i, " Pre/Post: 5th Percentile PC2 scores"))+
  theme_bw())
}

```

```{r fpca_wi_pc3, eval = F}
q.95 <- quantile(wi.scores$PC3, probs = 0.95)

pctile95.wi <- wi.scores$subject_id[wi.scores$PC3 > q.95] 

pctile95.wi.df <- right_0.pt[right_0.pt$subject_id %in% pctile95.wi, ]

ggplot(data = wi.df_plot, aes(x = seconds, y = mu))+
  geom_line(aes(color = "Pop.Mean"))+
  geom_line(aes(x = seconds, y = mu+errband3, color = "+2SD"))+
  geom_line(aes(x = seconds, y = mu-errband3, color = "-2SD"))+
  labs(x = "frame", 
       y = "Percent Change", 
       color = "Legend", 
       title = "Individuals in the Top 5th Percentile of PC3 scores")+
  geom_line(data = pctile95.wi.df, aes(x=seconds, y = wiPctChg, group = subject_id, color = subject_id))+
  scale_color_manual(values = colors)+
  theme_bw()

for(i in pctile95.wi){
  print(ggplot(data = right_0.post[right_0.post$subject_id == i, ], 
               aes(x = seconds, y = percent_change, group = tp, color = tp))+
  geom_line()+
  labs(title = paste0(i, " Pre/Post: Top 5th Percentile PC3 scores"))+
  theme_bw())
}

q.05 <- quantile(wi.scores$PC3, probs = 0.05)

pctile05.wi <- wi.scores$subject_id[wi.scores$PC3 < q.05] 

pctile05.wi.df <- right_0.pt[right_0.pt$subject_id %in% pctile05.wi, ]

ggplot(data = wi.df_plot, aes(x = seconds, y = mu))+
  geom_line(aes(color = "Pop.Mean"))+
  geom_line(aes(x = seconds, y = mu+errband3, color = "+2SD"))+
  geom_line(aes(x = seconds, y = mu-errband3, color = "-2SD"))+
  labs(x = "frame", 
       y = "Percent Change", 
       color = "Legend", 
       title = "Individuals in the 5th Percentile of PC3 scores")+
  geom_line(data = pctile05.wi.df, aes(x=frame/30, y = wiPctChg, group = subject_id, color = subject_id))+
  scale_color_manual(values = colors)+
  theme_bw()

for(i in pctile05.wi){
  print(ggplot(data = right_0.post[right_0.post$subject_id == i, ], 
               aes(x = seconds, y = percent_change, group = tp, color = tp))+
  geom_line()+
  labs(title = paste0(i, " Pre/Post: 5th Percentile PC3 scores"))+
  theme_bw())
}
```

# Meeting 20220908

```{r bumpy_curves, eval = F}
### INVESTIGATE BUMPS IN MEAN Function

## Pre/Post Across subjects
ggplot(mean_fxn.l, aes(x=frame/30, y = percent_change, group = grp,  
                       color = user_cat))+
  geom_line()+
  xlim(50, 200)+
  facet_grid(rows = vars(tp))+
  labs(title = "Average Percent Change by Pre/Post and THC use category", 
       x = "seconds")+
  theme_bw()

right_0.w[right_0.w$user_cat == "non-user" & right_0.w$tp == "pre2", 103:105]
right_0.w[right_0.w$user_cat == "non-user" & right_0.w$tp == "post", 101:103]


## Within person plots
ggplot(mean_fxn.pt.l, aes(x=frame/30, y = wi_percent_change, group = user_cat, color = user_cat))+
  geom_line()+
  xlim(50, 200)+
  labs(title ="Average Within subject difference in percent change by THC use category", 
       x = "seconds")+
  theme_bw()

## Mean function Spike in Occassional user group
mean_fxn.pt[mean_fxn.pt$Group.1 == "occasional", 113:119]
right_0.pt.w[right_0.pt.w$user_cat == "occasional", 116:119]

## Mean function Spike in Daily user group
mean_fxn.pt[mean_fxn.pt$Group.1 == "daily", 133:149]
right_0.pt.w[right_0.pt.w$user_cat == "daily", 143:146]
```

Jagged changes in the mean function lines seems to stem from missing data at those frames in the data set. The subjects per user-group is between 25 - 30, so missing data for one individual has a noticeable effect on mean function line. 

# Analysis

## POST DATA: Logistic Regression models to predict Smoker vs non-smoker using post data. plot AUC

```{r fpca_post, echo = F}
pctChg_vars <- names(right_0.post.w)[grepl("percent_change", names(right_0.post.w))]
post_right_0.fpca <- fpca.face(Y = as.matrix(right_0.post.w[, pctChg_vars]), 
                               pve = 0.95, knots = 30, var = T)

post_right_0.fpca.pve <- round(post_right_0.fpca$evalues/sum(post_right_0.fpca$evalues)*100, 2)
# post_right_0.fpca.pve

post_right_scores <- as.data.frame(post_right_0.fpca$scores)
names(post_right_scores) <- c("PC1", "PC2", "PC3", "PC4")
post_right_scores$subject_id <- rownames(post_right_scores)

pt.scores <- merge(post_right_scores, pt.df, 
                   by = c("subject_id"), 
                   all.x = T)

pt.scores$smoker <- ifelse(pt.scores$user_cat %in% c("daily", "occasional"),1, 0)
```


```{r auc, echo = F, message = F}
auc_inference <- data.frame(subject_id = pt.scores$subject_id, 
                            smoker = pt.scores$smoker,
                            stringsAsFactors = F)

m1 <- glm(smoker ~ PC1 + PC2 + PC3 +PC4, family = "binomial", data = pt.scores)
# summary(m1)
pt.scores$pred <- predict(m1, pt.scores)
pt.scores.roc <- roc(response = pt.scores$smoker, predictor = pt.scores$pred)
# pt.scores.roc
post.auc.pc4 <- pt.scores.roc$auc

auc_inference$post_PC_aucScores <- pt.scores.roc$original.predictor


plot.roc(pt.scores.roc, main = "Prediction of Smoker by PCs and Scalar Features in Post and WPD")

m1.scalar <- glm(smoker ~ min_constriction.post + AUC.post + slope.post, family = "binomial", data = pt.scores)
# summary(m1.scalar)
pt.scores$pred <- predict(m1.scalar, pt.scores)
pt.scalar.roc <- roc(response = pt.scores$smoker, predictor = pt.scores$pred)
# pt.scalar.roc
post.auc.scalar <- pt.scalar.roc$auc


auc_inference$post_SF_aucScores <- pt.scalar.roc$original.predictor

auc.df <- data.frame("Label" = c("Post AUC PCs", "Post AUC Scalar Feat"), 
                     "AUC" = c(post.auc.pc4, post.auc.scalar), 
                     stringsAsFactors = F)

### WPD rocs
m5 <- glm(smoker ~ PC1 + PC2 + PC3 +PC4, family = "binomial", data = pt.wi.scores)
# summary(m5)

pt.wi.scores$pred_sameNPC <- predict(m5, pt.wi.scores)
pt.wi.scores.roc2 <- roc(response = pt.wi.scores$smoker, 
                     predictor = pt.wi.scores$pred_sameNPC)
# pt.wi.scores.roc2
wi.auc.pcs <- pt.wi.scores.roc2$auc
auc.df <- rbind(auc.df, c("W/I Diff AUC PCS", wi.auc.pcs))

wpd_auc <- pt.wi.scores[, c("subject_id", "smoker")]
wpd_auc$wpd_PC_aucScores <- pt.wi.scores.roc2$original.predictor

m5.scalar <- glm(smoker ~ min_constriction_chg + AUC_chg + slope_chg, family = "binomial", data = pt.wi.scores)
# summary(m5.scalar)

pt.wi.scores$pred_wi_scalar <- predict(m5.scalar, pt.wi.scores)
pt.wi.scalar.roc2 <- roc(response = pt.wi.scores$smoker, 
                     predictor = pt.wi.scores$pred_wi_scalar)
wpd_auc$wpd_SF_aucScores <- pt.wi.scalar.roc2$original.predictor
# pt.wi.scalar.roc2
wi.auc.scalars <- pt.wi.scalar.roc2$auc
auc.df <- rbind(auc.df, c("W/I Diff AUC Scalar Feat", wi.auc.scalars))
auc.df$AUC <- as.numeric(auc.df$AUC)
```


```{r auc_plot_all}
roc.col <- viridis(5)
# jpeg(file.path(res_folder, "AUC_4PC_ScalarFeatures.jpg"), 
#      height = 6, width = 8, res = 300, units = "in")
plot.roc(pt.scores.roc, main = "Prediction of Smoker by PCs and Scalar Features in Post and WPD", 
         col = roc.col[1])
plot.roc(pt.scalar.roc, main = "", add = T, col = roc.col[2])
plot.roc(pt.wi.scores.roc2, 
         col = roc.col[3], 
         add = T)

plot.roc(pt.wi.scalar.roc2, 
         col = roc.col[4],
         add = T)
legend(0.5, 0.35, legend = c(paste0("post PCs AUC: ",round(post.auc.pc4, 3)),
                                 paste0("post Scalar Features AUC: ",round(post.auc.scalar, 3)), 
                                 paste0("WPD PCs AUC: ", round(wi.auc.pcs, 3)),
                                 paste0("WPD Scalar Features AUC: ", round(wi.auc.scalars, 3))),
       col = roc.col[1:4], 
       lty = rep(1, 4), cex = 0.8, bty="n")
# dev.off()

auc_inference <- merge(auc_inference, wpd_auc, 
                       by = c("subject_id", "smoker"))
```

## SoFR for prediction of smoking

Another method that can be used to predict smoking status is a scalar-on-function regression model which uses differences between the whole trajectories to determine smoking status. However, when there are missing values (due to different test durations), all trajectories should be truncated to the shortest or the values should be imputed with fPCA. (See exploration of using SoFR line starting at 3000) 

```{r sofr_fpcaImpute_roc}
sofr_impute_df <- right_0.post.w[, pctChg_vars]
rownames(sofr_impute_df) <- rownames(right_0.post.w)

sofr_fpca <- fpca.face(as.matrix(sofr_impute_df))
sofr_fpca2 <- sofr_fpca$Yhat
names(sofr_fpca2) <- names(sofr_impute_df)

sofr_imputed <- sofr_impute_df
sofr_imputed[is.na(sofr_imputed)] <-  sofr_fpca2[is.na(sofr_imputed)]

ncols = ncol(sofr_imputed)

smk.df <- pt.analytic.df[, c("subject_id", "user_cat")]
smk.df$smoker <- ifelse(pt.analytic.df$user_cat %in% c("daily", "occasional"), 1, 0)

sind <- seq(0, 1, len = ncols)
smat <- matrix(sind, nrow(smk.df), ncols, byrow = T)

# smk.df$Zsm <- I(Zsm)
smk.df$Zraw <- I(as.matrix(sofr_imputed))
smk.df$smat <- I(smat)
smk.df$lmat <- I(matrix(1/ncols, nrow(smk.df), ncols))
smk.df$zlmat <- I(smk.df$lmat * smk.df$Zraw)

smk_fglm_ps2 <- gam(smoker ~ s(smat, by=zlmat, bs = "cr", k = 30), data=smk.df, 
                   method = "REML", family = binomial)
summary(smk_fglm_ps2)

pt.sofr.roc <- roc(smk_fglm_ps2$model$smoker, smk_fglm_ps2$fitted.values)
pt.sofr.roc.auc <- auc(pt.sofr.roc)

auc.df <- rbind(auc.df, c("Post SoFR AUC", pt.sofr.roc.auc))
```


```{r auc_plot_post}
# jpeg(file.path(res_folder, "AUC_4PC_ScalarFeatures.jpg"), 
#      height = 6, width = 8, res = 300, units = "in")
plot.roc(pt.scores.roc, main = "Prediction of Smoker in Post Data with \nPCs, Scalar Features and SoFR Model", 
         col = roc.col[1])
plot.roc(pt.scalar.roc, main = "", add = T, col = roc.col[2])
plot.roc(pt.sofr.roc, main = "", add = T, col = roc.col[5])
legend(0.5, 0.35, legend = c(paste0("post PCs AUC: ",round(post.auc.pc4, 3)),
                             paste0("post Scalar Features AUC: ",round(post.auc.scalar, 3)),
                             paste0("post SoFR AUC: ", round(pt.sofr.roc.auc, 3))),
       col = roc.col[c(1:2,5)], 
       lty = rep(1, 3), cex = 0.8, bty="n")
# dev.off()
```

## Compare AUC across models
```{r compare_auc}
auc.df$AUC <- round(as.numeric(auc.df$AUC), 3)

knitr::kable(auc.df)
```


AUC Inference
```{r auc_sig}

Vr_10 <- function(nN, srpi, srnj){
  Vr_10i <- vector(mode = "numeric", length = length(srpi))
  
  for(i in 1:length(srpi)){
    Vr_10i[i] = (1/nN)*(sum(srpi[i] > srnj)+ 0.5*sum(srpi[i] ==  srnj))
  }
  
  return(Vr_10i)
}

Vr_01 <- function(pN, srpi, srnj){
  Vr_01i <- vector(mode = "numeric", length = length(srnj))
  
  for(i in 1:length(srnj)){
    Vr_01i[i] = (1/pN)*(sum(srnj[i] < srpi)+ 0.5*sum(srnj[i] ==  srpi))
  }
  
  return(Vr_01i)
}

w10 <- function(nP, v10_r, auc_r, v10_s, auc_s){
  diff_r <- vector(mode = "numeric", length = length(v10_r))
  diff_s <- vector(mode = "numeric", length = length(v10_s))
  
  for(i in 1:length(v10_r)){
    diff_r[i] <- v10_r[i] - auc_r
    diff_s[i] <- v10_s[i] - auc_r
  }
  
  res <- (nP-1)^(-1)* sum(diff_r * diff_s)
  
  return(res)
}

w01 <- function(nN, v01_r, auc_r, v01_s, auc_s){
  diff_r <- vector(mode = "numeric", length = length(v01_r))
  diff_s <- vector(mode = "numeric", length = length(v01_s))
  
  for(i in 1:length(v01_r)){
    diff_r[i] <- v01_r[i] - auc_r
    diff_s[i] <- v01_s[i] - auc_r
  }
  res <- (nN-1)^(-1)* sum(diff_r * diff_s)
  return(res)
}

# w10_postPC_postSF <- w10(nP = sum(auc_inference$smoker == 1), 
#                          v10_r = V_postPC_10,
#                          auc_r = auc.df$AUC[auc.df$Label == "Post AUC PCs"], 
#                          v10_s = V_postSF_10,
#                          auc_s = auc.df$AUC[auc.df$Label == "Post AUC Scalar Feat"])
# 
# w01_postPC_postSF <- w01(nN = sum(auc_inference$smoker == 0), 
#                          v01_r = V_postPC_01,
#                          auc_r = auc.df$AUC[auc.df$Label == "Post AUC PCs"], 
#                          v01_s = V_postSF_01,
#                          auc_s = auc.df$AUC[auc.df$Label == "Post AUC Scalar Feat"])
                         

w_rs <- function(nP, nN, srpi_r, srnj_r, srpi_s, srnj_s, auc_r, auc_s){
  v10_r <-  Vr_10(nN, srpi_r, srnj_r)
  v01_r <-  Vr_01(pN=nP, srpi_r, srnj_r)
  
  v10_s <-  Vr_10(nN, srpi_s, srnj_s)
  v01_s <-  Vr_01(pN=nP, srpi_s, srnj_s)
  
  w10_rs <- w10(nP, v10_r, auc_r, v10_s, auc_s)
  w01_rs <- w01(nN, v01_r, auc_r, v01_s, auc_s)
  
  
  res <-  (nP)^(-1)*w10_rs + (nN)^(-1)*w01_rs
  return(res)
}

w_postPC_postPC <- w_rs(nP = sum(auc_inference$smoker == 1),
                        nN = sum(auc_inference$smoker == 0), 
                        srpi_r = auc_inference$post_PC_aucScores[auc_inference$smoker == 1],
                        srnj_r = auc_inference$post_PC_aucScores[auc_inference$smoker == 0],
                        srpi_s = auc_inference$post_PC_aucScores[auc_inference$smoker == 1],
                        srnj_s = auc_inference$post_PC_aucScores[auc_inference$smoker == 0],
                        auc_r = auc.df$AUC[auc.df$Label == "Post AUC PCs"],
                        auc_s = auc.df$AUC[auc.df$Label == "Post AUC PCs"])

w_postSF_postSF <- w_rs(nP = sum(auc_inference$smoker == 1),
                        nN = sum(auc_inference$smoker == 0), 
                        srpi_r = auc_inference$post_SF_aucScores[auc_inference$smoker == 1],
                        srnj_r = auc_inference$post_SF_aucScores[auc_inference$smoker == 0],
                        srpi_s = auc_inference$post_SF_aucScores[auc_inference$smoker == 1],
                        srnj_s = auc_inference$post_SF_aucScores[auc_inference$smoker == 0],
                        auc_r = auc.df$AUC[auc.df$Label == "Post AUC Scalar Feat"],
                        auc_s = auc.df$AUC[auc.df$Label == "Post AUC Scalar Feat"])

w_wpdPC_wpdPC <- w_rs(nP = sum(auc_inference$smoker == 1),
                        nN = sum(auc_inference$smoker == 0), 
                        srpi_r = auc_inference$wpd_PC_aucScores[auc_inference$smoker == 1],
                        srnj_r = auc_inference$wpd_PC_aucScores[auc_inference$smoker == 0],
                        srpi_s = auc_inference$wpd_PC_aucScores[auc_inference$smoker == 1],
                        srnj_s = auc_inference$wpd_PC_aucScores[auc_inference$smoker == 0],
                        auc_r = auc.df$AUC[auc.df$Label == "W/I Diff AUC PCS"],
                        auc_s = auc.df$AUC[auc.df$Label == "W/I Diff AUC PCS"])

w_wpdSF_wpdSF <- w_rs(nP = sum(auc_inference$smoker == 1),
                        nN = sum(auc_inference$smoker == 0), 
                        srpi_r = auc_inference$wpd_SF_aucScores[auc_inference$smoker == 1],
                        srnj_r = auc_inference$wpd_SF_aucScores[auc_inference$smoker == 0],
                        srpi_s = auc_inference$wpd_SF_aucScores[auc_inference$smoker == 1],
                        srnj_s = auc_inference$wpd_SF_aucScores[auc_inference$smoker == 0],
                        auc_r = auc.df$AUC[auc.df$Label == "W/I Diff AUC Scalar Feat"],
                        auc_s = auc.df$AUC[auc.df$Label == "W/I Diff AUC Scalar Feat"])

w_postPC_postSF <- w_rs(nP = sum(auc_inference$smoker == 1),
                        nN = sum(auc_inference$smoker == 0), 
                        srpi_r = auc_inference$post_PC_aucScores[auc_inference$smoker == 1],
                        srnj_r = auc_inference$post_PC_aucScores[auc_inference$smoker == 0],
                        srpi_s = auc_inference$post_SF_aucScores[auc_inference$smoker == 1],
                        srnj_s = auc_inference$post_SF_aucScores[auc_inference$smoker == 0],
                        auc_r = auc.df$AUC[auc.df$Label == "Post AUC PCs"],
                        auc_s = auc.df$AUC[auc.df$Label == "Post AUC Scalar Feat"])

w_postPC_wpdPC <- w_rs(nP = sum(auc_inference$smoker == 1),
                        nN = sum(auc_inference$smoker == 0), 
                        srpi_r = auc_inference$post_PC_aucScores[auc_inference$smoker == 1],
                        srnj_r = auc_inference$post_PC_aucScores[auc_inference$smoker == 0],
                        srpi_s = auc_inference$wpd_PC_aucScores[auc_inference$smoker == 1],
                        srnj_s = auc_inference$wpd_PC_aucScores[auc_inference$smoker == 0],
                        auc_r = auc.df$AUC[auc.df$Label == "Post AUC PCs"],
                        auc_s = auc.df$AUC[auc.df$Label == "W/I Diff AUC PCS"])

w_postPC_wpdSF <- w_rs(nP = sum(auc_inference$smoker == 1),
                        nN = sum(auc_inference$smoker == 0), 
                        srpi_r = auc_inference$post_PC_aucScores[auc_inference$smoker == 1],
                        srnj_r = auc_inference$post_PC_aucScores[auc_inference$smoker == 0],
                        srpi_s = auc_inference$wpd_SF_aucScores[auc_inference$smoker == 1],
                        srnj_s = auc_inference$wpd_SF_aucScores[auc_inference$smoker == 0],
                        auc_r = auc.df$AUC[auc.df$Label == "Post AUC PCs"],
                        auc_s = auc.df$AUC[auc.df$Label == "W/I Diff AUC Scalar Feat"])

w_postSF_wpdPC <- w_rs(nP = sum(auc_inference$smoker == 1),
                        nN = sum(auc_inference$smoker == 0), 
                        srpi_r = auc_inference$post_SF_aucScores[auc_inference$smoker == 1],
                        srnj_r = auc_inference$post_SF_aucScores[auc_inference$smoker == 0],
                        srpi_s = auc_inference$wpd_PC_aucScores[auc_inference$smoker == 1],
                        srnj_s = auc_inference$wpd_PC_aucScores[auc_inference$smoker == 0],
                        auc_r = auc.df$AUC[auc.df$Label == "Post AUC Scalar Feat"],
                        auc_s = auc.df$AUC[auc.df$Label == "W/I Diff AUC PCS"])

w_postSF_wpdSF <- w_rs(nP = sum(auc_inference$smoker == 1),
                        nN = sum(auc_inference$smoker == 0), 
                        srpi_r = auc_inference$post_SF_aucScores[auc_inference$smoker == 1],
                        srnj_r = auc_inference$post_SF_aucScores[auc_inference$smoker == 0],
                        srpi_s = auc_inference$wpd_SF_aucScores[auc_inference$smoker == 1],
                        srnj_s = auc_inference$wpd_SF_aucScores[auc_inference$smoker == 0],
                        auc_r = auc.df$AUC[auc.df$Label == "Post AUC Scalar Feat"],
                        auc_s = auc.df$AUC[auc.df$Label == "W/I Diff AUC Scalar Feat"])

w_wpdPC_wpdSF <- w_rs(nP = sum(auc_inference$smoker == 1),
                        nN = sum(auc_inference$smoker == 0), 
                        srpi_r = auc_inference$wpd_PC_aucScores[auc_inference$smoker == 1],
                        srnj_r = auc_inference$wpd_PC_aucScores[auc_inference$smoker == 0],
                        srpi_s = auc_inference$wpd_SF_aucScores[auc_inference$smoker == 1],
                        srnj_s = auc_inference$wpd_SF_aucScores[auc_inference$smoker == 0],
                        auc_r = auc.df$AUC[auc.df$Label == "W/I Diff AUC PCS"],
                        auc_s = auc.df$AUC[auc.df$Label == "W/I Diff AUC Scalar Feat"])

z_postPC_postSF <- (auc.df$AUC[auc.df$Label == "Post AUC PCs"] - auc.df$AUC[auc.df$Label == "Post AUC Scalar Feat"])/
  (sqrt(w_postPC_postPC +  w_postSF_postSF - w_postPC_postSF))

z_postPC_wpdPC <- (auc.df$AUC[auc.df$Label == "Post AUC PCs"] - auc.df$AUC[auc.df$Label == "W/I Diff AUC PCS"])/
  (sqrt(w_postPC_postPC +  w_wpdPC_wpdPC - w_postPC_wpdPC))

z_postPC_wpdSF <- (auc.df$AUC[auc.df$Label == "Post AUC PCs"] - auc.df$AUC[auc.df$Label == "W/I Diff AUC Scalar Feat"])/
  (sqrt(w_postPC_postPC +  w_wpdSF_wpdSF - w_postPC_wpdSF))

z_postSF_wpdPC <- (auc.df$AUC[auc.df$Label == "Post AUC Scalar Feat"] - auc.df$AUC[auc.df$Label == "W/I Diff AUC PCS"])/
  (sqrt(w_postSF_postSF +  w_wpdPC_wpdPC - w_postSF_wpdPC))

z_postSF_wpdSF <- (auc.df$AUC[auc.df$Label == "Post AUC Scalar Feat"] - auc.df$AUC[auc.df$Label == "W/I Diff AUC Scalar Feat"])/
  (sqrt(w_postSF_postSF +  w_wpdSF_wpdSF - w_postSF_wpdSF))

z_wpdPC_wpdSF <- (auc.df$AUC[auc.df$Label == "W/I Diff AUC PCS"] - auc.df$AUC[auc.df$Label == "W/I Diff AUC Scalar Feat"])/
  (sqrt(w_wpdSF_wpdSF +  w_wpdPC_wpdPC - w_wpdPC_wpdSF))

auc_compare <- data.frame("Test Desciption" = c("AUC-postPC v AUC-postSF", 
                                                "AUC-postPC v AUC-wpdPC", 
                                                "AUC-postPC v AUC-wpdSF", 
                                                "AUC-postSF v AUC-wpdPC",
                                                "AUC-postSF v AUC-wpdPC", 
                                                "AUC-wpdPC v AUC-wpdSF"), 
                          "z" = c(round(z_postPC_postSF, 3), 
                                  round(z_postPC_wpdPC, 3), 
                                  round(z_postPC_wpdSF, 3), 
                                  round(z_postSF_wpdPC, 3), 
                                  round(z_postSF_wpdSF, 3), 
                                  round(z_wpdPC_wpdSF, 3)))

auc_compare$p <- round((1-pnorm(abs(auc_compare$z)))*2, 3)

knitr::kable(auc_compare)
```


## Association with Demog Variables

```{r demogAssoc_prep}
pt.scores$male <- ifelse(pt.scores$demo_gender == "Male", 1, 0)
pt.scores$non_user <- ifelse(pt.scores$user_cat == "non-user", 1, 0)
pt.scores$daily <- ifelse(pt.scores$user_cat == "daily", 1, 0)
pt.scores$occasional <- ifelse(pt.scores$user_cat == "occasional", 1, 0)


pt.wi.scores$male <- ifelse(pt.wi.scores$demo_gender == "Male", 1, 0)
pt.wi.scores$non_user <- ifelse(pt.wi.scores$user_cat == "non-user", 1, 0)
pt.wi.scores$daily <- ifelse(pt.wi.scores$user_cat == "daily", 1, 0)
pt.wi.scores$occasional <- ifelse(pt.wi.scores$user_cat == "occasional", 1, 0)
```

### Post Data

Compare PCs to Scalar Features
```{r corrPC_scalar}
chart.Correlation(pt.scores[, c("PC1", "PC2", "PC3", "PC4", 
                                "min_constriction.post", "duration.post", 
                                "avg_end_percent.post", "slope.post", "AUC.post")])
```

Compare PCs to demog Variables
```{r corrPC_demog}
chart.Correlation(pt.scores[, c("PC1", "PC2", "PC3", "PC4", 
                                "demo_age","male", "thc.post", "thc_chg", "BMI", 
                                "postConsumpTimeToTest", "smoker", 
                                "non_user", "daily", "occasional")])
```

Compare Scalar Features to demog variables
```{r corrScalar_demog}
chart.Correlation(pt.scores[, c("min_constriction.post", "duration.post", 
                                "avg_end_percent.post", "slope.post", "AUC.post", 
                                "demo_age","male", "thc.post", "thc_chg", "BMI", 
                                "postConsumpTimeToTest", "smoker", 
                                "non_user", "daily", "occasional")])
```


```{r demogAssoc_post}
var.int <- c("demo_age", "demo_weight", "demo_height", "thc_chg", "postConsumpTimeToTest", "male")

lm.demog.post.df <- data.frame("est" = numeric(), 
                               "se" = numeric(), 
                               "test.stat" = numeric(), 
                               "pval" = numeric(), 
                               "iv" = character(), 
                               "dv" = character(), 
                               stringsAsFactors = F)

for(i in var.int){
  if(i != "male"){
    m <- lm(as.formula(paste0(i, "~ PC1 + PC2 + PC3 + PC4")), 
                 data = pt.scores)
    res1.df <- as.data.frame(summary(m)$coefficients)
    names(res1.df) <- c("est", "se", "test.stat", "pval")
    res1.df$iv <- rownames(res1.df)
    res1.df$dv <- i
    lm.demog.post.df <- rbind(lm.demog.post.df, res1.df)
  } else(
    if(i == "male"){
      m <- glm(as.formula(paste0(i, "~ PC1 + PC2 + PC3 + PC4")),
              family = "binomial",
              data = pt.scores)
      res1.df <- as.data.frame(summary(m)$coefficients)
      names(res1.df) <- c("est", "se", "test.stat", "pval")
      res1.df$iv <- rownames(res1.df)
      res1.df$dv <- i
      lm.demog.post.df <- rbind(lm.demog.post.df, res1.df)
    }
  )
}
```

### Within Person Difference Data
Compare PCs to Scalar Features
```{r wi_corrPC_scalar}
chart.Correlation(pt.wi.scores[, c("PC1", "PC2", "PC3", "PC4", "PC5", "PC6",
                                "min_constriction_chg", "AUC_chg", "duration_chg",
                                "avg_end_percent_chg", "slope_chg")])
```

Compare PCs to demog Variables
```{r wi_corrPC_demog, warning = F}
chart.Correlation(pt.wi.scores[, c("PC1", "PC2", "PC3", "PC4", "PC5", "PC6",
                                "demo_age","male", "thc.post", "thc_chg", "BMI", 
                                "postConsumpTimeToTest", "smoker", 
                                "non_user", "daily", "occasional")])
```

Compare Scalar Features to demog variables
```{r wi_corrScalar_demog}
chart.Correlation(pt.wi.scores[, c("min_constriction_chg", "AUC_chg", "duration_chg", 
                                   "avg_end_percent_chg", "slope_chg", 
                                "demo_age","male", "thc.post", "thc_chg", "BMI", 
                                "postConsumpTimeToTest", "smoker", 
                                "non_user", "daily", "occasional")])
```

```{r demogAssoc_wi}
var.int <- c("demo_age", "demo_weight", "demo_height", "thc_chg", 
             "postConsumpTimeToTest", "male")

lm.demog.wpd.df <- data.frame("est" = numeric(), 
                               "se" = numeric(), 
                               "test.stat" = numeric(), 
                               "pval" = numeric(), 
                               "iv" = character(), 
                               "dv" = character(), 
                               stringsAsFactors = F)

for(i in var.int){
  if(i != "male"){
    m <- lm(as.formula(paste0(i, "~ PC1 + PC2 + PC3 + PC4")), 
                 data = pt.wi.scores)
    res1.df <- as.data.frame(summary(m)$coefficients)
    names(res1.df) <- c("est", "se", "test.stat", "pval")
    res1.df$iv <- rownames(res1.df)
    res1.df$dv <- i
    lm.demog.wpd.df <- rbind(lm.demog.wpd.df, res1.df)
  } else(
    if(i == "male"){
      m <- glm(as.formula(paste0(i, "~ PC1 + PC2 + PC3 + PC4")),
              family = "binomial",
              data = pt.wi.scores)
      res1.df <- as.data.frame(summary(m)$coefficients)
      names(res1.df) <- c("est", "se", "test.stat", "pval")
      res1.df$iv <- rownames(res1.df)
      res1.df$dv <- i
      lm.demog.wpd.df <- rbind(lm.demog.wpd.df, res1.df)
    }
  )
}
```

Demographic Variables:

+ Age
+ Weight
+ Height
+ BMI 
+ Change in THC
+ Time from consumption to Post test
+ Sex

Results: 

Regression models regressed demographic variables on the 4 PCs for the post data. 

+ BMI negatively associated with PC2 adjusting for other PCs (p= 0.03)

Regression models regressed demographic variables on the 6 PCs for the WPD data.

+ Weight negatively associated with PC2 &  positively associated with PC5 adjusting for other PCs (p = 0.04 & 0.009)
+ Height positively associated with PC5 adjusting for other PCs (p = 0.006)
+ BMI positively associated with PC1 adjusting for other PCs (p= 0.049)
+ Male positively associated with PC5 adjusting for other PCs (p= 0.040)

## Backward stepwise selection

```{r step_post, echo=F, results='hide', message=FALSE}
post_step.df <- pt.scores[, c("PC1", "PC2", "PC3", "PC4", "min_constriction.post", 
                              "duration.post", "avg_end_percent.post", 
                              "slope.post", "AUC.post", "smoker")]

m.post_step <- glm(smoker ~ PC1 + PC2 + PC3 + PC4, family = "binomial", data = post_step.df)
post_step.res <- step(m.post_step, direction = "backward")
# summary(post_step.res)
# post_step.res$coefficients[-1]

post_step.df$pred_post_step <- predict(post_step.res, pt.scores)

pt.scores.roc3 <- roc(response = post_step.df$smoker, 
                     predictor = post_step.df$pred_post_step)

# pt.scores.roc3
auc.specific <- data.frame("Post AUC PCs Step", pt.scores.roc3$auc)
auc.df <- rbind(auc.df, setNames(auc.specific, names(auc.df)))

plot.roc(pt.scores.roc3, 
         col = "black")

## Scalar
m.post_step.scalar <- glm(smoker ~ min_constriction.post + AUC.post  + 
                            avg_end_percent.post + slope.post, 
                          family = "binomial", data = post_step.df)
post_step.res <- step(m.post_step.scalar, direction = "backward")
# summary(post_step.res)
# post_step.res$coefficients[-1]
post_step.df$pred_post_step.scalar <- predict(post_step.res, pt.scores)

pt.scalar.roc3 <- roc(response = post_step.df$smoker, 
                     predictor = post_step.df$pred_post_step.scalar)

# pt.scalar.roc3
auc.specific <- data.frame("Post AUC Scalar Step", pt.scalar.roc3$auc)
auc.df <- rbind(auc.df, setNames(auc.specific, names(auc.df)))

plot.roc(pt.scalar.roc3, 
         col = "darkred", 
         add = T)

## Within Person differences
wi_step.df <- pt.wi.scores[, c("PC1", "PC2", "PC3", "PC4", "PC5", "PC6", 
                               "min_constriction_chg", "AUC_chg", "duration_chg", 
                               "avg_end_percent_chg", "slope_chg", "smoker")]

m.wi_step <- glm(smoker ~ PC1 + PC2 + PC3 + PC4 +PC5 +PC6, family = "binomial", data = wi_step.df)
wi_step.res <- step(m.wi_step, direction = "backward")
# wi_step.res$coeffcients[-1]
# summary(wi_step.res)

wi_step.df$pred_wi_step <- predict(wi_step.res, pt.wi.scores)
pt.wi.scores.roc4 <- roc(response = wi_step.df$smoker, 
                     predictor = wi_step.df$pred_wi_step)

# pt.wi.scores.roc4
auc.specific <- data.frame("W/I Diff AUC PCs Step", pt.wi.scores.roc4$auc)
auc.df <- rbind(auc.df, setNames(auc.specific, names(auc.df)))

plot.roc(pt.wi.scores.roc4,
         col = "darkblue", 
         add = T)

### Scalar Features
m.wi_step.scalar <- glm(smoker ~ min_constriction_chg + AUC_chg 
                 + avg_end_percent_chg + slope_chg,
                 family = "binomial", data = wi_step.df)

wi_step.res <- step(m.wi_step.scalar, direction = "backward")
# summary(wi_step.res)
# wi_step.res$coefficients[-1]

wi_step.df$pred_wi_step.scalar <- predict(wi_step.res, pt.wi.scores)
pt.wi.scalar.roc4 <- roc(response = wi_step.df$smoker, 
                     predictor = wi_step.df$pred_wi_step.scalar)

# pt.wi.scalar.roc4
auc.specific <- data.frame("W/I Diff AUC Scalar Step", pt.wi.scalar.roc4$auc)
auc.df <- rbind(auc.df, setNames(auc.specific, names(auc.df)))

plot.roc(pt.wi.scalar.roc4, 
         col = "darkgreen", 
         add = T)
legend(0.5, 0.35, legend = c(paste0("post PCs AUC: ",round(pt.scores.roc3$auc, 3)),
                                 paste0("post Scalar Features AUC: ",round(pt.scalar.roc3$auc, 3)), 
                                 paste0("WPD PCs AUC: ", round(pt.wi.scores.roc4$auc, 3)),
                                 paste0("WPD Scalar Features AUC: ", round(pt.wi.scalar.roc4$auc, 3))),
       col = c("black", "darkred", "darkblue", "darkgreen"), 
       lty = rep(1, 4), cex = 0.8,  bty="n")
```

## Function on Scalar Regression
### Post
$$ 
\begin{aligned}
Y_{i}(t) &= f_0(t) + f_1(t)*I(user = occasional) + f_2(t)*I(user = daily) + b_i(t) + \epsilon_i(t)\\
& b_i(t) \sim GP(0, \Sigma_b) \\
& \epsilon_i(t) \sim N(0, \sigma_{\epsilon}^2) \\
&= \sum_{k=1}^K \xi_{0k}\phi_{0k}(t_i) + \sum_{k=1}^K \xi_{1k}\phi_{1k}(t_i)*I(user = occasional) + \sum_{k=1}^K \xi_{2k}\phi_{2k}(t_i)*I(user = daily) + \sum_{k=1}^K \xi_{ik}\phi_k(t_i) + \epsilon_i(t)\\
\end{aligned}
$$

### Mean function for non-user
$$
\begin{aligned}
Y_{i}(t) &= f_0(t)\\
&=\sum_{k=1}^K \xi_{0k}\phi_{0k}(t_i) \\
&= \Phi_0\xi_0
\end{aligned}
$$

### Mean function for occasional user
$$
\begin{aligned}
Y_{i}(t) &= f_0(t) + f_1(t) \\  
&=\sum_{k=1}^K \xi_{0k}\phi_{0k}(t_i) + \sum_{k=1}^K \xi_{1k}\phi_{1k}(t_i)\\
&= \Phi_0\xi_0 + \Phi_1\xi_1\\ 
&= [ \Phi_0, \Phi_1 ] \xi
\end{aligned}
$$

### Mean function for daily user
$$
\begin{aligned}
Y_{i}(t) &= f_0(t) + f_2(t) \\  
&=\sum_{k=1}^K \xi_{0k}\phi_{0k}(t_i) + \sum_{k=1}^K \xi_{2k}\phi_{2k}(t_i) \\
&= \Phi_0\xi_0 + \Phi_2\xi_2\\
&= [ \Phi_0, \Phi_2 ] \xi
\end{aligned}
$$


```{r post_pffr, eval = F}
pt.analytic.df <- pt.df[pt.df$subject_id %in% analytic.N, ]
pt.analytic.df$occasional <- ifelse(pt.analytic.df$user_cat == "occasional", 1, 0)
pt.analytic.df$daily  <- ifelse(pt.analytic.df$user_cat == "daily", 1, 0)


pt.analytic.df <- pt.analytic.df[order(pt.analytic.df$subject_id), ]

right_0.post.w <- right_0.post.w[order(right_0.post.w$subject_id), ]

post_pffr.df <- data.frame("subject_id" = as.factor(pt.analytic.df$subject_id),
                          "occ_user" = pt.analytic.df$occasional, 
                          "daily_user" = pt.analytic.df$daily, 
                          "pct_chg" = I(as.matrix(right_0.post.w[, c(4:404)])))

m.post_pffr <- pffr(pct_chg ~ occ_user + daily_user +s(subject_id, bs="re"),
                    data = post_pffr.df, 
                    algorithm = "bam", 
                    method = "fREML", 
                    discrete = T)

summary(m.post_pffr)

par(mfrow = c(1, 3))
plot(m.post_pffr)
```
*What does NA in the output mean?* Did not find NA in either the matrix or other variables

```{r pt_analytic, echo = F}
pt.analytic.df <- pt.df[pt.df$subject_id %in% analytic.N, ]
pt.analytic.df$occasional <- ifelse(pt.analytic.df$user_cat == "occasional", 1, 0)
pt.analytic.df$daily  <- ifelse(pt.analytic.df$user_cat == "daily", 1, 0)


pt.analytic.df <- pt.analytic.df[order(pt.analytic.df$subject_id), ]
```


```{r post_gam}
# head(right_0.df)

right_0.gam.df <- merge(right_0.post, pt.analytic.df, 
                        by = c("subject_id", "user_cat"))

# right_0.gam.df <- right_0.gam.df[order(right_0.gam.df$subject_id, right_0.gam.df$frame), ]
right_0.gam.df$sind <- right_0.gam.df$frame/400

# head(right_0.gam.df)

m.post_gam <- mgcv::gam(percent_change ~ s(sind, k=30, bs="cr") + 
                          s(sind, by=occasional, k=30, bs = "cr") + 
                          s(sind, by=daily, k=30, bs = "cr"), 
                  data = right_0.gam.df, method = "REML")

## Create a matrix of residuals
post_gam.resid <- cbind(right_0.gam.df[!(is.na(right_0.gam.df$percent_change)), 
                                       c("subject_id", "frame")], 
                        m.post_gam$residuals)
names(post_gam.resid) <- c("subject_id", "frame", "resid")
# post_gam.resid$frame_char <- str_pad(post_gam.resid$frame, width = 3, side = "left", pad = "0")

resid_mat <- reshape(post_gam.resid[, c("subject_id", "frame", "resid")], 
                     timevar = "frame", 
                     idvar = "subject_id", 
                     direction = "wide")
rownames(resid_mat) <- resid_mat$subject_id
resid_mat$subject_id <- NULL
# resid_names <- names(resid_mat)
# resid_names <- sort(resid_names)
# resid_mat <- resid_mat[, resid_names]

resid_mat <- as.matrix(resid_mat)

post_gam.fpca <- fpca.face(resid_mat, knots = 15)

#Create data frame of eigen functions and attach to original data
Phi_mat <- as.data.frame(post_gam.fpca$efunctions)
colnames(Phi_mat) <- paste0("Phi", seq(1, post_gam.fpca$npc))
Phi_mat$frame <- as.numeric(rownames(Phi_mat)) -1

right_0.gam.df <- merge(right_0.gam.df, Phi_mat, 
                        by = "frame", 
                        all.x = T)
right_0.gam.df <- right_0.gam.df[order(right_0.gam.df$subject_id, right_0.gam.df$frame), ]
right_0.gam.df$subject_id <- as.factor(right_0.gam.df$subject_id)

post_gam.fri <- mgcv::bam(percent_change ~ 
                            s(sind, k=30, bs="cr") + 
                            s(sind, by=occasional, k=30, bs = "cr") + 
                            s(sind, by=daily, k=30, bs = "cr") +
                            s(subject_id, by = Phi1, bs="re") + s(subject_id, by = Phi2, bs="re")+
                            s(subject_id, by = Phi3, bs="re") + s(subject_id, by = Phi4, bs="re"), 
                          method = "fREML", data = right_0.gam.df, discrete = TRUE)


summary(post_gam.fri)
```

### Plotting trajectory of occasional & daily user
```{r plot_occ}
post_gam.coef <- post_gam.fri$coefficients
post_gam.cov <- vcov.gam(post_gam.fri)

df_pred_non <- data.frame("sind" = unique(right_0.gam.df$sind), "occasional" = 0, "daily" = 0, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, 
                          "subject_id" = right_0.gam.df$subject_id[1])

lpmat_non <- predict(post_gam.fri, newdata=df_pred_non, se.fit=TRUE, type = "lpmatrix")


df_pred_occ <- data.frame("sind" = unique(right_0.gam.df$sind), "occasional" = 1, "daily" = 0, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, 
                          "subject_id" = right_0.gam.df$subject_id[1])

lpmat_occ <- predict(post_gam.fri, newdata=df_pred_occ, se.fit=TRUE, type = "lpmatrix")

df_pred_dly <- data.frame("sind" = unique(right_0.gam.df$sind), "occasional" = 0, "daily" = 1, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, 
                          "subject_id" = right_0.gam.df$subject_id[1])

lpmat_dly <- predict(post_gam.fri, newdata=df_pred_dly, se.fit=TRUE, type = "lpmatrix")


pred_df <- data.frame(seconds = rep(seq(0, 400), 3)/30,
                      user = c(rep("non-user", 401), rep("occasional", 401),rep("daily", 401)), 
                      mean = c(lpmat_non %*% post_gam.coef, 
                               lpmat_occ %*% post_gam.coef, lpmat_dly %*% post_gam.coef), 
                      se = c(sqrt(diag(lpmat_non %*% post_gam.cov %*% t(lpmat_non))), 
                             sqrt(diag(lpmat_occ %*% post_gam.cov %*% t(lpmat_occ))),
                             sqrt(diag(lpmat_dly %*% post_gam.cov %*% t(lpmat_dly)))), 
                      stringsAsFactors = F)

post_userProfile <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                    geom_line()+
                    labs(y = "Percent Change")+
                    theme_bw()

legend_userProfile <- g_legend(post_userProfile)

post_userProfile.se <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                    geom_line()+
                    geom_line(aes(x=seconds, y = mean + 2*se, group = user, col = user),
                              linetype = "longdash")+
                    geom_line(aes(x=seconds, y = mean - 2*se, group = user, col = user),
                              linetype = "longdash")+
                    labs(y = "")+
                    theme_bw()
                    
post_userTraj <- grid.arrange(arrangeGrob(post_userProfile+theme(legend.position = "none"), 
                                          post_userProfile.se+theme(legend.position = "none"), nrow = 1), 
                              legend_userProfile, nrow = 1, 
                              widths = c(30, 6))
```


```{r coef_effect_plots}
pred_f1 <- predict(post_gam.fri, newdata=df_pred_occ, se.fit=TRUE, type = "terms")
pred_f2 <- predict(post_gam.fri, newdata=df_pred_dly, se.fit=TRUE, type = "terms")

pred_coef_df <- data.frame(seconds = seq(0, 400)/30,
                           f0_hat = lpmat_non %*% post_gam.coef, 
                           f0_se = sqrt(diag(lpmat_non %*% post_gam.cov %*% t(lpmat_non))), 
                           f1_hat = pred_f1$fit[, 2], 
                           f1_se = pred_f1$se.fit[, 2], 
                           f2_hat = pred_f2$fit[, 3], 
                           f2_se = pred_f2$se.fit[, 3])

post_non_plt <- ggplot(data = pred_coef_df, aes(x=seconds, y = f0_hat))+
                geom_line()+
                geom_line(aes(x = seconds, y = f0_hat + 2*f0_se), linetype = "longdash")+
                geom_line(aes(x = seconds, y = f0_hat - 2*f0_se), linetype = "longdash")+
                labs(title = "Average Percent Change of a Non-user (Post)", ylab = "Percent Change")+
                theme_bw()

post_occ_plt <- ggplot(data = pred_coef_df, aes(x=seconds, y = f1_hat))+
                geom_line()+
                geom_line(aes(x = seconds, y = f1_hat + 2*f1_se), linetype = "longdash")+
                geom_line(aes(x = seconds, y = f1_hat - 2*f1_se), linetype = "longdash")+
                geom_line(aes(x = seconds, y = 0), col = "darkred")+
                labs(title = "Difference in Percent Change: Occasional and Non-user (Post)", 
                     y= "")+
                theme_bw()+
                scale_x_continuous(expand = c(0, 0))+
                theme(rect = element_rect(fill = "transparent"))

post_dly_plt <- ggplot(data = pred_coef_df, aes(x=seconds, y = f2_hat))+
                geom_line()+
                geom_line(aes(x = seconds, y = f2_hat + 2*f2_se), linetype = "longdash")+
                geom_line(aes(x = seconds, y = f2_hat - 2*f2_se), linetype = "longdash")+
                geom_line(aes(x = seconds, y = 0), col = "darkred")+
                labs(title = "Difference in Percent Change: Daily and Non-user (Post)", 
                     y = "")+
                theme_bw()+
                scale_x_continuous(expand = c(0, 0))+
                theme(rect = element_rect(fill = "transparent"))

ylab <- textGrob(label = "Difference in Percent Change", rot = 90, 
                 gp = gpar(fontsize = 12))
posval <- textGrob(label = sapply(strwrap("Less Constriction in User", width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))
negval <- textGrob(label = sapply(strwrap("More Constriction in User", width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))

post_occ_coef <- grid.arrange(ylab, posval, negval, post_occ_plt, 
                              ncol = 2, nrow = 2, 
                              layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))

post_dly_coef <- grid.arrange(ylab, posval, negval, post_dly_plt, 
                              ncol = 2, nrow = 2, 
                              layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))

```

Plot difference between daily and occasional user

```{r diff_dly_occ}
f2_f1 <- (lpmat_dly - lpmat_occ) %*% post_gam.coef
f2_f1.se <- sqrt(diag((lpmat_dly - lpmat_occ) %*% post_gam.cov %*% t((lpmat_dly - lpmat_occ))))

f2_f1_diff_df <- data.frame(seconds = seq(0, 400)/30, 
                            f2f1_diff = f2_f1, 
                            f2f1_se = f2_f1.se)

ggplot(data = f2_f1_diff_df, aes(x=seconds, y = f2f1_diff))+
  geom_line()+
  geom_line(aes(x = seconds, y = f2f1_diff + 2*f2f1_se), linetype = "longdash")+
  geom_line(aes(x = seconds, y = f2f1_diff - 2*f2f1_se), linetype = "longdash")+
  labs(title = "Difference between Average Daily vs Occasional User", ylab = "f2_hat - f1_hat")+
  theme_bw()

post_dlyocc_plt <- ggplot(data = f2_f1_diff_df, aes(x=seconds, y = f2f1_diff))+
                   geom_line()+
                   geom_line(aes(x = seconds, y = f2f1_diff + 2*f2f1_se), linetype = "longdash")+
                   geom_line(aes(x = seconds, y = f2f1_diff - 2*f2f1_se), linetype = "longdash")+
                   geom_line(aes(x = seconds, y = 0), col = "darkred")+
                   labs(title = "Difference in Percent Change: Daily vs Occasional User", 
                        y = "")+
                   theme_bw()+
                   scale_x_continuous(expand = c(0, 0))+
                   theme(rect = element_rect(fill = "transparent"))

ylab <- textGrob(label = "Difference in Percent Change", rot = 90, 
                 gp = gpar(fontsize = 12))
posval <- textGrob(label = sapply(strwrap("Less Constriction in Daily User", width = 15, 
                                          simplify = F),
                                  paste, collapse = "\n"), rot = 0, just = "bottom", 
                 gp = gpar(fontsize = 8))
negval <- textGrob(label = sapply(strwrap("More Constriction in Daily User", width = 15, 
                                          simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))

post_dlyocc_coef <- grid.arrange(ylab, posval, negval, post_dlyocc_plt, 
                                 ncol = 2, nrow = 2, 
                                 layout_matrix = rbind(c(1, 2, rep(4, 15)), 
                                                       c(1, 3, rep(4, 15))))

post_dlyocc_coef
```

### Check for differences between smoker vs non-smoker

```{r smokervnon}
smoker.gam.df <- merge(right_0.post, pt.analytic.df, 
                        by = c("subject_id", "user_cat"))
smoker.gam.df$sind <- smoker.gam.df$frame/400
smoker.gam.df$smoker <- ifelse(smoker.gam.df$user_cat == "non-user", 0, 1)

m.post_smoker_gam <- mgcv::gam(percent_change ~ s(sind, k=30, bs="cr") + 
                                 s(sind, by=smoker, k=30, bs = "cr"), 
                  data = smoker.gam.df, method = "REML")

## Create a matrix of residuals
post_smoker_gam.resid <- cbind(smoker.gam.df[!(is.na(smoker.gam.df$percent_change)), 
                                             c("subject_id", "frame")], 
                               m.post_smoker_gam$residuals)
names(post_smoker_gam.resid) <- c("subject_id", "frame", "resid")

# post_smoker_gam.resid$frame_char <- str_pad(post_smoker_gam.resid$frame, 
#                                             width = 3, side = "left", pad = "0")

resid_mat <- reshape(post_smoker_gam.resid[, c("subject_id", "frame", "resid")], 
                     timevar = "frame", 
                     idvar = "subject_id", 
                     direction = "wide")

rownames(resid_mat) <- resid_mat$subject_id
resid_mat$subject_id <- NULL
# resid_names <- names(resid_mat)
# resid_names <- sort(resid_names)
# resid_mat <- resid_mat[, resid_names]

resid_mat <- as.matrix(resid_mat)


post_smoker_gam.fpca <- fpca.face(resid_mat, knots = 15)

#Create data frame of eigen functions and attach to original data
Phi_mat <- as.data.frame(post_smoker_gam.fpca$efunctions)
colnames(Phi_mat) <- paste0("Phi", seq(1, post_smoker_gam.fpca$npc))
Phi_mat$frame <- as.numeric(rownames(Phi_mat)) -1

smoker.gam.df <- merge(smoker.gam.df, Phi_mat, 
                        by = "frame", 
                        all.x = T)
smoker.gam.df <- smoker.gam.df[order(smoker.gam.df$subject_id, smoker.gam.df$frame), ]
smoker.gam.df$subject_id <- as.factor(smoker.gam.df$subject_id)

post_smoker_gam.fri <- mgcv::bam(percent_change ~ 
                            s(sind, k=30, bs="cr") + 
                            s(sind, by=smoker, k=30, bs = "cr") +
                            s(subject_id, by = Phi1, bs="re") + s(subject_id, by = Phi2, bs="re")+
                            s(subject_id, by = Phi3, bs="re") + s(subject_id, by = Phi4, bs="re"), 
                          method = "fREML", data = smoker.gam.df, discrete = TRUE)


summary(post_smoker_gam.fri)
```

Plot difference between smoker and non-smoker
```{r plot_smk}
post_smoker_gam.coef <- post_smoker_gam.fri$coefficients
post_smoker_gam.cov <- vcov.gam(post_smoker_gam.fri)

df_pred_non <- data.frame("sind" = unique(smoker.gam.df$sind), "smoker" =0, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, 
                          "subject_id" = smoker.gam.df$subject_id[1])

lpmat_non <- predict(post_smoker_gam.fri, newdata=df_pred_non, se.fit=TRUE, type = "lpmatrix")


df_pred_smk <- data.frame("sind" = unique(smoker.gam.df$sind), "smoker" = 1, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, 
                          "subject_id" = smoker.gam.df$subject_id[1])

lpmat_smk <- predict(post_smoker_gam.fri, newdata=df_pred_smk, se.fit=TRUE, type = "lpmatrix")

pred_df <- data.frame(seconds = rep(seq(0, 400), 2)/30,
                      user = c(rep("non-user", 401), rep("smoker", 401)), 
                      mean = c(lpmat_non %*% post_smoker_gam.coef, 
                               lpmat_smk %*% post_smoker_gam.coef), 
                      se = c(sqrt(diag(lpmat_non %*% post_smoker_gam.cov %*% t(lpmat_non))), 
                             sqrt(diag(lpmat_smk %*% post_smoker_gam.cov %*% t(lpmat_smk)))), 
                      stringsAsFactors = F)

post_smkProfile <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                   geom_line()+
                   scale_y_continuous(limits = c(min(pred_df$mean - 2*pred_df$se),
                                                 max(pred_df$mean+2*pred_df$se)))+
                   labs(y = "Percent Change")+
                   theme_bw()

legend_smkProfile <- g_legend(post_smkProfile)

post_smkProfile.se <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                      geom_line()+
                      geom_line(aes(x=seconds, y = mean + 2*se, group = user, col = user),
                                linetype = "longdash")+
                      geom_line(aes(x=seconds, y = mean - 2*se, group = user, col = user),
                                linetype = "longdash")+
                      scale_y_continuous(limits = c(min(pred_df$mean - 2*pred_df$se),
                                                    max(pred_df$mean+2*pred_df$se)))+
                      labs(y = "")+
                      theme_bw()

post_smk <- grid.arrange(arrangeGrob(post_smkProfile+theme(legend.position = "none"), 
                                     post_smkProfile.se+theme(legend.position = "none"), nrow = 1), 
                         legend_smkProfile, nrow = 1, 
                         widths = c(30, 6))
```


```{r smk_coef_effect_plots}
# pred_f0 <- predict(post_smoker_gam.fri, newdata=df_pred_non, se.fit=TRUE, type = "iterms")
pred_f1 <- predict(post_smoker_gam.fri, newdata=df_pred_smk, se.fit=TRUE, type = "terms")

pred_coef_df <- data.frame(seconds = seq(0, 400)/30,
                           f0_hat = lpmat_non %*% post_smoker_gam.coef, 
                           f0_se = sqrt(diag(lpmat_non %*% post_smoker_gam.cov %*% t(lpmat_non))), 
                           f1_hat = pred_f1$fit[, 2], 
                           f1_se = pred_f1$se.fit[, 2])

post_smk_plt <- ggplot(data = pred_coef_df, aes(x=seconds, y = f1_hat))+
                geom_line()+
                geom_line(aes(x = seconds, y = f1_hat + 2*f1_se), linetype = "longdash")+
                geom_line(aes(x = seconds, y = f1_hat - 2*f1_se), linetype = "longdash")+
                geom_line(aes(x = seconds, y = 0), col = "darkred")+
                labs(title = "Difference in Percent Change: Smoker and Non-smoker", 
                     y = "")+
                theme_bw()+
                scale_x_continuous(expand = c(0, 0))+
                theme(rect = element_rect(fill = "transparent"))

ylab <- textGrob(label = "Difference in Percent Change", rot = 90, 
                 gp = gpar(fontsize = 12))
posval <- textGrob(label = sapply(strwrap("Less Constriction in Smokers", 
                                          width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, just = "bottom",
                   gp = gpar(fontsize = 8))
negval <- textGrob(label = sapply(strwrap("More Constriction in Smokers", 
                                          width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))

post_smk_coef <- grid.arrange(ylab, posval, negval, post_smk_plt, 
                              ncol = 2, nrow = 2, 
                              layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))
```

### Within Subject
```{r wi_fosr_pffr, eval = F}
right_0.pt.w <- right_0.pt.w[order(right_0.pt.w$subject_id), ]

wi_pffr.df <- data.frame("subject_id" = pt.analytic.df$subject_id,
                          "occ_user" = pt.analytic.df$occasional, 
                          "daily_user" = pt.analytic.df$daily, 
                          "wi_pct_chg" = I(as.matrix(right_0.pt.w[, c(3:403)])))
wi_pffr.df$subject_id <- as.factor(wi_pffr.df$subject_id)

m.wi_pffr <- pffr(wi_pct_chg ~ occ_user + daily_user + s(subject_id, bs="re"),
                  data = wi_pffr.df,
                  algorithm = "bam", 
                  method = "fREML", 
                  discrete = T)

summary(m.wi_pffr)
par(mfrow = c(1,3))
plot(m.wi_pffr)
```


```{r wi_gam}
right_0.pt.gam.df <- merge(right_0.pt, pt.analytic.df, 
                        by = c("subject_id", "user_cat"))
right_0.pt.gam.df$sind <- right_0.pt.gam.df$frame/400


m.wi_gam <- mgcv::gam(wiPctChg ~ s(sind, k=30, bs="cr") + 
                        s(sind, by=occasional, k=30, bs = "cr") + 
                        s(sind, by=daily, k=30, bs = "cr"), 
                  data = right_0.pt.gam.df, method = "REML")


## Create a matrix of residuals
wi_gam.resid <- cbind(right_0.pt.gam.df[!(is.na(right_0.pt.gam.df$wiPctChg)), 
                                        c("subject_id", "frame")], 
                      m.wi_gam$residuals)
names(wi_gam.resid) <- c("subject_id", "frame", "resid")

# wi_gam.resid$frame_char <- str_pad(wi_gam.resid$frame, width = 3, side = "left", pad = "0")


resid_mat <- reshape(wi_gam.resid[, c("subject_id", "frame", "resid")],
                     timevar = "frame",
                     idvar = "subject_id",
                     direction = "wide")
rownames(resid_mat) <- resid_mat$subject_id
resid_mat$subject_id <- NULL
# resid_names <- names(resid_mat)
# resid_names <- sort(resid_names)
# resid_mat <- resid_mat[, resid_names]
resid_mat <- as.matrix(resid_mat)

wi_gam.fpca <- fpca.face(resid_mat, knots = 15)
wi_gam.fpca$evalues/sum(wi_gam.fpca$evalues)

#Create data frame of eigen functions and attach to original data
Phi_mat <- as.data.frame(wi_gam.fpca$efunctions)
colnames(Phi_mat) <- paste0("Phi", seq(1, wi_gam.fpca$npc))
Phi_mat$frame <- as.numeric(rownames(Phi_mat)) -1

right_0.pt.gam.df <- merge(right_0.pt.gam.df, Phi_mat,
                        by = "frame",
                        all.x = T)
# right_0.pt.gam.df <- right_0.pt.gam.df[order(right_0.pt.gam.df$subject_id, 
#                                              right_0.pt.gam.df$frame), ]
right_0.pt.gam.df$subject_id <- as.factor(right_0.pt.gam.df$subject_id)

wi_gam.fri <- mgcv::bam(wiPctChg ~ s(sind, k=30, bs="cr") + 
                          s(sind, by=occasional, k=30, bs = "cr") + 
                          s(sind, by=daily, k=30, bs = "cr")+
                          s(subject_id, by = Phi1, bs="re") + s(subject_id, by = Phi2, bs="re")+
                          s(subject_id, by = Phi3, bs="re") + s(subject_id, by = Phi4, bs="re")+
                          s(subject_id, by = Phi5, bs="re") + s(subject_id, by = Phi6, bs="re"),
                        method = "fREML", data = right_0.pt.gam.df, discrete = TRUE)
summary(wi_gam.fri)
```

### Plotting trajectory of occasional user with within person difference data
```{r wi.plots}
wi_gam.coef <- wi_gam.fri$coefficients
wi_gam.cov <- vcov.gam(wi_gam.fri)

df_pred_non <- data.frame("sind" = unique(right_0.pt.gam.df$sind), "occasional" = 0, "daily" = 0, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, "Phi5" = 0, "Phi6" = 0, 
                          "subject_id" = right_0.pt.gam.df$subject_id[1])

lpmat_non <- predict(wi_gam.fri, newdata=df_pred_non, se.fit=TRUE, type = "lpmatrix")


df_pred_occ <- data.frame("sind" = unique(right_0.pt.gam.df$sind), "occasional" = 1, "daily" = 0, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, "Phi5" = 0, "Phi6" = 0, 
                          "subject_id" = right_0.pt.gam.df$subject_id[1])

lpmat_occ <- predict(wi_gam.fri, newdata=df_pred_occ, se.fit=TRUE, type = "lpmatrix")

df_pred_dly <- data.frame("sind" = unique(right_0.pt.gam.df$sind), "occasional" = 0, "daily" = 1, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, "Phi5" = 0, "Phi6" = 0, 
                          "subject_id" = right_0.pt.gam.df$subject_id[1])

lpmat_dly <- predict(wi_gam.fri, newdata=df_pred_dly, se.fit=TRUE, type = "lpmatrix")


pred_df <- data.frame(seconds = rep(seq(0, 400), 3)/30,
                      user = c(rep("non-user", 401), rep("occasional", 401),rep("daily", 401)), 
                      mean = c(lpmat_non %*% wi_gam.coef, 
                               lpmat_occ %*% wi_gam.coef, lpmat_dly %*% wi_gam.coef), 
                      se = c(sqrt(diag(lpmat_non %*% wi_gam.cov %*% t(lpmat_non))), 
                             sqrt(diag(lpmat_occ %*% wi_gam.cov %*% t(lpmat_occ))),
                             sqrt(diag(lpmat_dly %*% wi_gam.cov %*% t(lpmat_dly)))), 
                      stringsAsFactors = F)

# ggplot(data = pred_df, aes(x = frame, y = mean, group = user, col = user))+
#   geom_line()+
#   geom_line(aes(x=frame, y = mean + 2*se, group = user, col = user), linetype = "longdash")+
#   geom_line(aes(x=frame, y = mean - 2*se, group = user, col = user), linetype = "longdash")+
#   theme_bw()

wi_userProfile <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                   geom_line()+
                   scale_y_continuous(limits = c(min(pred_df$mean - 2*pred_df$se),
                                                 max(pred_df$mean+2*pred_df$se)))+
                   labs(y = "Within Person Difference in Percent Change")+
                   theme_bw()

legend_userProfile <- g_legend(wi_userProfile)

wi_userProfile.se <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                      geom_line()+
                      geom_line(aes(x=seconds, y = mean + 2*se, group = user, col = user),
                                linetype = "longdash")+
                      geom_line(aes(x=seconds, y = mean - 2*se, group = user, col = user),
                                linetype = "longdash")+
                      scale_y_continuous(limits = c(min(pred_df$mean - 2*pred_df$se),
                                                    max(pred_df$mean+2*pred_df$se)))+
                      labs(y = "")+
                      theme_bw()

wi_userTraj <- grid.arrange(arrangeGrob(wi_userProfile+theme(legend.position = "none"), 
                                        wi_userProfile.se+theme(legend.position = "none"), nrow = 1), 
                                        legend_userProfile, nrow = 1, 
                                        widths = c(30, 6))
```

### Plotting average trajectories of users
```{r wpd_traj, echo = F,  fig.height= 6, fig.width=20}
# jpeg(file.path(res_folder, "FoSR_Mean_Trajectories_post_WPD.jpg"), 
#      height = 6, width = 20, res = 300, units = "in")
grid.arrange(post_userTraj, wi_userTraj, ncol = 2)
# dev.off()
```


```{r wicoef_effect_plots}
pred_f1 <- predict(wi_gam.fri, newdata=df_pred_occ, se.fit=TRUE, type = "terms")
pred_f2 <- predict(wi_gam.fri, newdata=df_pred_dly, se.fit=TRUE, type = "terms")

pred_coef_df <- data.frame(seconds = seq(0, 400)/30,
                           f0_hat = lpmat_non %*% wi_gam.coef, 
                           f0_se = sqrt(diag(lpmat_non %*% wi_gam.cov %*% t(lpmat_non))), 
                           f1_hat = pred_f1$fit[, 2], 
                           f1_se = pred_f1$se.fit[, 2], 
                           f2_hat = pred_f2$fit[, 3], 
                           f2_se = pred_f2$se.fit[, 3])

# ggplot(data = pred_coef_df, aes(x=frame, y = f0_hat))+
#   geom_line()+
#   geom_line(aes(x = frame, y = f0_hat + 2*f0_se), linetype = "longdash")+
#   geom_line(aes(x = frame, y = f0_hat - 2*f0_se), linetype = "longdash")+
#   labs(title = "Average Response of a Non-user", ylab = "Within Person Difference in Percent Change")+
#   theme_bw()

wi_occ_plt <-  ggplot(data = pred_coef_df, aes(x=seconds, y = f1_hat))+
               geom_line()+
               geom_line(aes(x = seconds, y = f1_hat + 2*f1_se), linetype = "longdash")+
               geom_line(aes(x = seconds, y = f1_hat - 2*f1_se), linetype = "longdash")+
               geom_line(aes(x = seconds, y = 0), col = "darkred")+
               labs(title = "Difference in Within Person Difference (WPD): Occasional and Non-user", 
                    y = "")+
               theme_bw()+
               scale_x_continuous(expand = c(0, 0))+
               theme(rect = element_rect(fill = "transparent"))

wi_dly_plt <- ggplot(data = pred_coef_df, aes(x=seconds, y = f2_hat))+
              geom_line()+
              geom_line(aes(x = seconds, y = f2_hat + 2*f2_se), linetype = "longdash")+
              geom_line(aes(x = seconds, y = f2_hat - 2*f2_se), linetype = "longdash")+
              geom_line(aes(x = seconds, y = 0), col = "darkred")+
              labs(title = "Difference in Within Person Difference (WPD): Daily and Non-user", 
                   y = "")+
              theme_bw()+
              scale_x_continuous(expand = c(0, 0))+
              theme(rect = element_rect(fill = "transparent"))

ylab <- textGrob(label = "Difference in WPD in Percent Change", rot = 90, 
                 gp = gpar(fontsize = 12))
posval <- textGrob(label = sapply(strwrap("More WPD Constriction in User", 
                                          width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))
negval <- textGrob(label = sapply(strwrap("Less WPD Constriction in User", 
                                          width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))

wi_occ_coef <- grid.arrange(ylab, posval, negval, wi_occ_plt, 
                            ncol = 2, nrow = 2, 
                            layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))

wi_dly_coef <- grid.arrange(ylab, posval, negval, wi_dly_plt, 
                            ncol = 2, nrow = 2, 
                            layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))
```

### Difference between Occasional and Non-user

```{r occ_coef_plt, echo=FALSE, fig.height = 6, fig.width=15}
# jpeg(file.path(res_folder, "FoSR_Diff_Occ_NU_Trajectories_post_WPD.jpg"), 
#      height = 6, width = 15, res = 300, units = "in")
grid.arrange(post_occ_coef, wi_occ_coef, ncol = 2)
# dev.off()
```

This plot compares the difference between occasional and non-users for post and WPD data. In the post data there is significant positive difference in the occasional and non-users from frame 50 - 125 which would indicate that occasional user have less constriction during this time. In the WPD data there is a significant positive difference in the occasional and non-users from frame 10 - 175, indicating a greater difference in the difference between post and pre for the occasional vs non-user. Since the typical response has a positive difference between post and pre during this interval caused by less constriction at post compared to pre, we can say that there is even less constriction in post data of an occasional user compared to his/her pre than in a non-user. 

### Difference between Daily and Non-Users

```{r dly_coef_plt, echo=FALSE, fig.height = 6, fig.width=15}
# jpeg(file.path(res_folder, "FoSR_Diff_Dly_NU_Trajectories_post_WPD.jpg"), 
#     height = 6, width = 15, res = 300, units = "in")
grid.arrange(post_dly_coef, wi_dly_coef, ncol = 2)
# dev.off()
```

These results are similar to the occassional vs non-user but less pronounced maybe indicating more variability in daily and non-users. 

Differences in Within Person Difference between Daily and Occassional Users

```{r wi_diff_dly_occ, echo = F, fig.show= 'hide'}
f2_f1 <- (lpmat_dly - lpmat_occ) %*% wi_gam.coef
f2_f1.se <- sqrt(diag((lpmat_dly - lpmat_occ) %*% wi_gam.cov %*% t((lpmat_dly - lpmat_occ))))

f2_f1_diff_df <- data.frame(seconds = seq(0, 400)/30, 
                            f2f1_diff = f2_f1, 
                            f2f1_se = f2_f1.se)

wi_dlyocc_plt <- ggplot(data = f2_f1_diff_df, aes(x=seconds, y = f2f1_diff))+
                   geom_line()+
                   geom_line(aes(x = seconds, y = f2f1_diff + 2*f2f1_se), linetype = "longdash")+
                   geom_line(aes(x = seconds, y = f2f1_diff - 2*f2f1_se), linetype = "longdash")+
                   geom_line(aes(x = seconds, y = 0), col = "darkred")+
                   labs(title = "Difference in WPD in Percent Change: Daily vs Occasional User", 
                        y = "")+
                   theme_bw()+
                   scale_x_continuous(expand = c(0, 0))+
                   theme(rect = element_rect(fill = "transparent"))

ylab <- textGrob(label = "Difference in WPD in Percent Change", rot = 90, 
                 gp = gpar(fontsize = 12))
posval <- textGrob(label = sapply(strwrap("More Constriction in Daily User", 
                                          width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, just = "bottom", 
                 gp = gpar(fontsize = 8))
negval <- textGrob(label = sapply(strwrap("Less Constriction in Daily User", 
                                          width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))

wi_dlyocc_coef <- grid.arrange(ylab, posval, negval, wi_dlyocc_plt, 
                                 ncol = 2, nrow = 2, 
                                 layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))
```
### Difference between Daily and Occasional Users

```{r dlyocc_coef_plt, echo = F, fig.height = 6, fig.width=15}
# jpeg(file.path(res_folder, "FoSR_Diff_Dly_Occ_Trajectories_post_WPD.jpg"), 
#      height = 6, width = 15, res = 300, units = "in")
grid.arrange(post_dlyocc_coef, wi_dlyocc_coef, ncol = 2)
# dev.off()
```


Difference in Within Person Difference Smoker vs Non-smokers

```{r wi_smokervnon}
wi.smoker.gam.df <- merge(right_0.pt, pt.analytic.df, 
                        by = c("subject_id", "user_cat"))
wi.smoker.gam.df$sind <- wi.smoker.gam.df$frame/400
wi.smoker.gam.df$smoker <- ifelse(wi.smoker.gam.df$user_cat == "non-user", 0, 1)

m.wi_smoker_gam <- mgcv::gam(wiPctChg ~ s(sind, k=15, bs="cr") + 
                                 s(sind, by=smoker, k=15, bs = "cr"), 
                  data = wi.smoker.gam.df, method = "REML")

## Create a matrix of residuals
wi_smoker_gam.resid <- cbind(wi.smoker.gam.df[!(is.na(wi.smoker.gam.df$wiPctChg)), 
                                              c("subject_id", "frame")], 
                             m.wi_smoker_gam$residuals)
names(wi_smoker_gam.resid) <- c("subject_id", "frame", "resid")

# wi_smoker_gam.resid$frame_char <- str_pad(wi_smoker_gam.resid$frame, 
#                                           width = 3, side = "left", pad = "0")

resid_mat <- reshape(wi_smoker_gam.resid[, c("subject_id", "frame", "resid")], 
                     timevar = "frame", 
                     idvar = "subject_id", 
                     direction = "wide")

rownames(resid_mat) <- resid_mat$subject_id
resid_mat$subject_id <- NULL
# resid_names <- names(resid_mat)
# resid_names <- sort(resid_names)
# resid_mat <- resid_mat[, resid_names]

resid_mat <- as.matrix(resid_mat)


wi_smoker_gam.fpca <- fpca.face(resid_mat, knots = 15)

#Create data frame of eigen functions and attach to original data
Phi_mat <- as.data.frame(wi_smoker_gam.fpca$efunctions)
colnames(Phi_mat) <- paste0("Phi", seq(1, wi_smoker_gam.fpca$npc))
Phi_mat$frame <- as.numeric(rownames(Phi_mat)) -1

wi.smoker.gam.df <- merge(wi.smoker.gam.df, Phi_mat, 
                        by = "frame", 
                        all.x = T)
wi.smoker.gam.df <- smoker.gam.df[order(wi.smoker.gam.df$subject_id, wi.smoker.gam.df$frame), ]
wi.smoker.gam.df$subject_id <- as.factor(wi.smoker.gam.df$subject_id)

wi_smoker_gam.fri <- mgcv::bam(percent_change ~ 
                            s(sind, k=15, bs="cr") + 
                            s(sind, by=smoker, k=15, bs = "cr") +
                            s(subject_id, by = Phi1, bs="re") + s(subject_id, by = Phi2, bs="re")+
                            s(subject_id, by = Phi3, bs="re") + s(subject_id, by = Phi4, bs="re"), 
                          method = "fREML", data = wi.smoker.gam.df, discrete = TRUE)


summary(wi_smoker_gam.fri)
```


Plot difference between smoker and non-smoker
```{r wi_plot_smk}
wi_smoker_gam.coef <- wi_smoker_gam.fri$coefficients
wi_smoker_gam.cov <- vcov.gam(wi_smoker_gam.fri)

df_pred_non <- data.frame("sind" = sort(unique(wi.smoker.gam.df$sind)), "smoker" =0, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, 
                          "subject_id" = wi.smoker.gam.df$subject_id[1])

lpmat_non <- predict(wi_smoker_gam.fri, newdata=df_pred_non, se.fit=TRUE, type = "lpmatrix")


df_pred_smk <- data.frame("sind" = sort(unique(wi.smoker.gam.df$sind)), "smoker" = 1, 
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, 
                          "subject_id" = wi.smoker.gam.df$subject_id[1])

lpmat_smk <- predict(wi_smoker_gam.fri, newdata=df_pred_smk, se.fit=TRUE, type = "lpmatrix")

pred_df <- data.frame(seconds = rep(seq(0, 400), 2)/30,
                      user = c(rep("non-user", 401), rep("smoker", 401)), 
                      mean = c(lpmat_non %*% wi_smoker_gam.coef, 
                               lpmat_smk %*% wi_smoker_gam.coef), 
                      se = c(sqrt(diag(lpmat_non %*% wi_smoker_gam.cov %*% t(lpmat_non))), 
                             sqrt(diag(lpmat_smk %*% wi_smoker_gam.cov %*% t(lpmat_smk)))), 
                      stringsAsFactors = F)

# ggplot(data = pred_df, aes(x = frame, y = mean, group = user, col = user))+
#   geom_line()+
#   geom_line(aes(x=frame, y = mean + 2*se, group = user, col = user), linetype = "longdash")+
#   geom_line(aes(x=frame, y = mean - 2*se, group = user, col = user), linetype = "longdash")+
#   theme_bw()

wi_smkProfile <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                   geom_line()+
                   scale_y_continuous(limits = c(min(pred_df$mean - 2*pred_df$se),
                                                 max(pred_df$mean+2*pred_df$se)))+
                   labs(y = "Within Person Difference in Percent Change")+
                   theme_bw()

legend_smkProfile <- g_legend(wi_smkProfile)

wi_smkProfile.se <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                      geom_line()+
                      geom_line(aes(x=seconds, y = mean + 2*se, group = user, col = user),
                                linetype = "longdash")+
                      geom_line(aes(x=seconds, y = mean - 2*se, group = user, col = user),
                                linetype = "longdash")+
                      scale_y_continuous(limits = c(min(pred_df$mean - 2*pred_df$se),
                                                    max(pred_df$mean+2*pred_df$se)))+
                      labs(y = "")+
                      theme_bw()

wi_smk <- grid.arrange(arrangeGrob(wi_smkProfile+theme(legend.position = "none"), 
                                   wi_smkProfile.se+theme(legend.position = "none"), nrow = 1), 
                       legend_smkProfile, nrow = 1, 
                       widths = c(30, 6))
```

### Average Trajectory of Smoker vs Non-Smoker
```{r plt_smkTraj,echo = F, fig.height= 8, fig.width= 8}
# jpeg(file.path(res_folder, "FoSR_Smk_Mean_Trajectories_post_WPD.jpg"), 
#      height = 8, width = 15, res = 300, units = "in")
grid.arrange(post_smk, wi_smk, nrow = 2)
# dev.off()
```

```{r wi_smk_coef_effect_plots}
# pred_f0 <- predict(post_smoker_gam.fri, newdata=df_pred_non, se.fit=TRUE, type = "iterms")
pred_f1 <- predict(wi_smoker_gam.fri, newdata=df_pred_smk, se.fit=TRUE, type = "terms")

pred_coef_df <- data.frame(seconds = seq(0, 400)/30,
                           f0_hat = lpmat_non %*% wi_smoker_gam.coef, 
                           f0_se = sqrt(diag(lpmat_non %*% wi_smoker_gam.cov %*% t(lpmat_non))), 
                           f1_hat = pred_f1$fit[, 2], 
                           f1_se = pred_f1$se.fit[, 2])

# ggplot(data = pred_coef_df, aes(x=frame, y = f0_hat))+
#   geom_line()+
#   geom_line(aes(x = frame, y = f0_hat + 2*f0_se), linetype = "longdash")+
#   geom_line(aes(x = frame, y = f0_hat - 2*f0_se), linetype = "longdash")+
#   labs(title = "Average Within Person Difference in Percent Change of a Non-user", ylab = "f0_hat")+
#   theme_bw()

wi_smk_plt <- ggplot(data = pred_coef_df, aes(x=seconds, y = f1_hat))+
              geom_line()+
              geom_line(aes(x = seconds, y = f1_hat + 2*f1_se), linetype = "longdash")+
              geom_line(aes(x = seconds, y = f1_hat - 2*f1_se), linetype = "longdash")+
              geom_line(aes(x = seconds, y = 0), col = "darkred")+
              labs(title = "Difference in Within Person Difference (WPD) in Percent Change \nbetween Smoker and Non-smoker", 
                   y = "")+
              theme_bw()+
              scale_x_continuous(expand = c(0, 0))+
              theme(rect = element_rect(fill = "transparent"))

ylab <- textGrob(label = "Difference in WPD in Percent Change", rot = 90, 
                 gp = gpar(fontsize = 12))
posval <- textGrob(label = sapply(strwrap("More WPD Constriction in User", 
                                          width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))
negval <- textGrob(label = sapply(strwrap("Less WPD Constriction in User", 
                                          width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))

wi_smk_coef <- grid.arrange(ylab, posval, negval, wi_smk_plt, 
                            ncol = 2, nrow = 2, 
                            layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))

```

### Smoker vs Non-smoker Effect
```{r smokerEffects, echo = F, fig.height = 4, fig.width=15}
# jpeg(file.path(res_folder, "FoSR_Diff_Smk_Trajectories_post_WPD.jpg"), 
#      height = 6, width = 15, res = 300, units = "in")
grid.arrange(post_smk_coef , wi_smk_coef, nrow = 1)
# dev.off()
```

## SoFR - prediction of smoker vs non-smoker
```{r smk_right}
smk.df <- pt.analytic.df[, c("subject_id", "user_cat")]
smk.df$smoker <- ifelse(pt.analytic.df$user_cat %in% c("daily", "occasional"), 1, 0)

# Zsm <- post_right_0.fpca$Yhat

pctChg_names <- names(right_0.post.w)[grepl("percent_change", names(right_0.post.w)) == T]

### Truncate to 350 frames
frame_max = 350
pctChg_names_350 <- pctChg_names[as.numeric(substr(pctChg_names, 16, 18)) <= frame_max]
sofr_right_post <-  right_0.post.w[, pctChg_names_350]

ncols = length(pctChg_names_350)
sind <- seq(0, 1, len = ncols)
smat <- matrix(sind, nrow(smk.df), ncols, byrow = T)

# smk.df$Zsm <- I(Zsm)
smk.df$Zraw <- I(as.matrix(sofr_right_post))
smk.df$smat <- I(smat)
smk.df$lmat <- I(matrix(1/ncols, nrow(smk.df), ncols))
smk.df$zlmat <- I(smk.df$lmat * smk.df$Zraw)

smk_fglm_ps <- gam(smoker ~ s(smat, by=zlmat, bs = "cr", k = 30), data=smk.df, 
                   method = "REML", family = binomial)
summary(smk_fglm_ps)

roc_in_sample <- roc(smk_fglm_ps$model$smoker, smk_fglm_ps$fitted.values)
auc(roc_in_sample)
```


```{r plotSoFR_350, eval = F}
df_sofr <- data.frame("smat" = sind, "zlmat" = 1)

sofr_pred <- predict(smk_fglm_ps, newdata = df_sofr, , se.fit = TRUE, type = "iterms")

plot.sofr <- data.frame("frame" = 0:(ncols -1),
                            "f0" = sofr_pred$fit[, 1],
                            'f0.se' = sofr_pred$se.fit[, 1])

ggplot(data = plot.sofr, aes(x=frame, y = exp(f0)))+
  geom_line()+
  geom_line(aes(x=frame, y = exp(f0-2*f0.se)), linetype = 'longdash')+
  geom_line(aes(x=frame, y = exp(f0+2*f0.se)), linetype = 'longdash')+
  geom_hline(yintercept = 1, color = "red", linetype = 3)+ 
  labs(title = "Odd Ratio of being a smoker vs non-smoker over the test duration", 
       x = "frame")+
  theme_bw()

ggplot(data = plot.sofr, aes(x=frame/300, y = f0))+
  geom_line()+
  geom_line(aes(x=frame/300, y = f0-2*f0.se), linetype = 'longdash')+
  geom_line(aes(x=frame/300, y = f0+2*f0.se), linetype = 'longdash')+
  geom_hline(yintercept = 1, color = "red", linetype = 3)+
  labs(title = "Odd Ratio of being a smoker vs non-smoker over the test duration", 
       x = "seconds")+
  theme_bw()

```

### SOFR with fPCA imputed data -- all participants
```{r sofr_fpcaImpute}
sofr_impute_df <- right_0.post.w[, pctChg_names]
rownames(right_0.post.w$subject_id)

sofr_fpca <- fpca.face(as.matrix(sofr_impute_df))
sofr_fpca2 <- sofr_fpca$Yhat
names(sofr_fpca2) <- names(sofr_impute_df)

sofr_imputed <- sofr_impute_df
sofr_imputed[is.na(sofr_imputed)] <-  sofr_fpca2[is.na(sofr_imputed)]

ncols = ncol(sofr_imputed)

sind <- seq(0, 1, len = ncols)
smat <- matrix(sind, nrow(smk.df), ncols, byrow = T)

# smk.df$Zsm <- I(Zsm)
smk.df$Zraw <- I(as.matrix(sofr_imputed))
smk.df$smat <- I(smat)
smk.df$lmat <- I(matrix(1/ncols, nrow(smk.df), ncols))
smk.df$zlmat <- I(smk.df$lmat * smk.df$Zraw)

smk_fglm_ps2 <- gam(smoker ~ s(smat, by=zlmat, bs = "cr", k = 30), data=smk.df, 
                   method = "REML", family = binomial)
summary(smk_fglm_ps2)

roc_in_sample2 <- roc(smk_fglm_ps2$model$smoker, smk_fglm_ps2$fitted.values)
auc(roc_in_sample2)
```


## VAS based "high" vs "not in occasional smokers
```{r vas_explore}
hist(pt.analytic.df$vas1_high_score[pt.analytic.df$user_cat == "daily"], breaks = 15)
hist(pt.analytic.df$vas1_high_score[pt.analytic.df$user_cat == "occasional"], breaks = 15)
boxplot(vas1_high_score ~ user_cat, data = pt.analytic.df)
summary(pt.analytic.df$vas1_high_score[pt.analytic.df$user_cat == "daily"])
summary(pt.analytic.df$vas1_high_score[pt.analytic.df$user_cat == "occasional"])

by(pt.analytic.df$vas1_high_score, INDICES = pt.analytic.df$user_cat, FUN = summary)
sum(pt.analytic.df$vas1_high_score[pt.analytic.df$user_cat == "occasional"] >= 46, na.rm = T)
sum(pt.analytic.df$vas1_high_score[pt.analytic.df$user_cat == "occasional"] < 46, na.rm = T)

pt.analytic.df$vas_high <- NA
pt.analytic.df$vas_high[pt.analytic.df$vas1_high_score >= 46 &
                          pt.analytic.df$user_cat == "occasional"] <- 1
pt.analytic.df$vas_high[pt.analytic.df$vas1_high_score < 46 &
                          pt.analytic.df$user_cat == "occasional"] <- 0
```

### VAS scatterplot of pt of min constriction and VAS
```{r plot_VAS_minConstrict, fig.width=15, fig.height = 6}
AllSmokers <- pt.analytic.df[pt.analytic.df$user_cat != "non-user", ]
preAllSmokers <- lm(min_constriction.pre2 ~ vas1_high_score, data = AllSmokers)
postAllSmokers <- lm(min_constriction.post ~ vas1_high_score, data = AllSmokers)
chgAllSmokers <- lm(min_constriction_chg ~ vas1_high_score, data = AllSmokers)


pre_vas_minConstrict <- ggplot(data = AllSmokers, 
                               aes(x = vas1_high_score, 
                                   y = min_constriction.pre2, col = user_cat))+
                             geom_point()+
                             scale_y_continuous(limits = c(-55, 0))+
                             geom_vline(xintercept = 46,color = "darkred")+
                             labs(title = "POST VAS Feel High Score vs PRE minimal Constriction")+
                             geom_smooth(aes(col = NULL), method = "lm", se=FALSE, 
                                         color="black", formula = y ~ x)+
                             geom_label(label = paste(expression("beta == "),
                                                  round(summary(preAllSmokers)$coefficients[2, 1], 2)),
                                        x = 3,
                                        y = 0,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                            geom_label(label = paste(expression("p =="),
                                                     round(summary(preAllSmokers)$coefficients[2, 4], 2)),
                                        x = 3,
                                        y = -3,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                             geom_label(label = paste(expression("rho == "),
                                                  round(cor(AllSmokers$min_constriction.pre2, 
                                                            AllSmokers$vas1_high_score), 3)),
                                        x = 3,
                                        y = -6,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
  
                             theme_bw()


post_vas_minConstrict <- ggplot(data = AllSmokers, 
                                aes(x = vas1_high_score, y = min_constriction.post, col = user_cat))+
                             geom_point()+
                             scale_y_continuous(limits = c(-55, 0))+
                             geom_vline(xintercept = 46,color = "darkred")+
                             labs(title = "POST VAS Feel High Score vs POST minimal Constriction")+
                             geom_smooth(aes(col = NULL), method = "lm", se=FALSE, 
                                         color="black", formula = y ~ x)+
                             geom_label(label = paste(expression("beta == "),
                                                  round(summary(postAllSmokers)$coefficients[2, 1], 2)),
                                        x = 3,
                                        y = 0,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                            geom_label(label = paste(expression("p =="),
                                                     round(summary(postAllSmokers)$coefficients[2, 4], 2)),
                                        x = 3,
                                        y = -3,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                             geom_label(label = paste(expression("rho == "),
                                                  round(cor(AllSmokers$min_constriction.post, 
                                                            AllSmokers$vas1_high_score), 3)),
                                        x = 3,
                                        y = -6,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
  
                             theme_bw()

chg_vas_minConstrict <- ggplot(data = AllSmokers, 
                               aes(x = vas1_high_score, y = min_constriction_chg, col = user_cat))+
                            geom_point()+
                            scale_y_continuous(limits = c(-20, 40))+
                            geom_vline(xintercept = 46,color = "darkred")+
                            labs(title = "POST VAS Feel High Score vs Change in minimal Constriction (post-pre)")+
                            geom_smooth(aes(col = NULL), method = "lm", se=FALSE, 
                                         color="black", formula = y ~ x)+
                             geom_label(label = paste(expression("beta == "),
                                                  round(summary(chgAllSmokers)$coefficients[2, 1], 2)),
                                        x = 3,
                                        y = -15,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                            geom_label(label = paste(expression("p =="),
                                                     round(summary(chgAllSmokers)$coefficients[2, 4], 2)),
                                        x = 3,
                                        y = -18,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                             geom_label(label = paste(expression("rho == "),
                                                  round(cor(AllSmokers$min_constriction_chg, 
                                                            AllSmokers$vas1_high_score), 3)),
                                        x = 3,
                                        y = -21,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
  
                             theme_bw()
# jpeg(file.path(res_folder, "Scatterplot_VAS_MinConstriction_AllSmokers.jpg"),
#      height = 6, width = 23, res = 300, units = "in")
grid.arrange(pre_vas_minConstrict, post_vas_minConstrict , chg_vas_minConstrict, nrow = 1)
# dev.off()

### Occasional Users
OccSmokers <- AllSmokers[AllSmokers$user_cat == "occasional", ]
preOccSmokers <- lm(min_constriction.pre2 ~ vas1_high_score, data = OccSmokers)
postOccSmokers <- lm(min_constriction.post ~ vas1_high_score, data = OccSmokers)
chgOccSmokers <- lm(min_constriction_chg ~ vas1_high_score, data = OccSmokers)


pre_vas_minConstrict_occ <- ggplot(data = OccSmokers, 
                               aes(x = vas1_high_score, 
                                   y = min_constriction.pre2))+
                             geom_point()+
                             scale_y_continuous(limits = c(-55, 0))+
                             geom_vline(xintercept = 46,color = "darkred")+
                             labs(title = "POST VAS Feel High Score vs PRE minimal Constriction \nOccasional Smokers")+
                             geom_smooth(aes(col = NULL), method = "lm", se=FALSE, 
                                         color="black", formula = y ~ x)+
                             geom_label(label = paste(expression("beta == "),
                                                  round(summary(preOccSmokers)$coefficients[2, 1], 2)),
                                        x = 3,
                                        y = 0,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                            geom_label(label = paste(expression("p =="),
                                                     round(summary(preOccSmokers)$coefficients[2, 4], 2)),
                                        x = 3,
                                        y = -3,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                             geom_label(label = paste(expression("rho == "),
                                                  round(cor(OccSmokers$min_constriction.pre2, 
                                                            OccSmokers$vas1_high_score), 3)),
                                        x = 3,
                                        y = -6,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
  
                             theme_bw()


post_vas_minConstrict_occ <- ggplot(data = OccSmokers, 
                                aes(x = vas1_high_score, y = min_constriction.post))+
                             geom_point()+
                             scale_y_continuous(limits = c(-55, 0))+
                             geom_vline(xintercept = 46,color = "darkred")+
                             labs(title = "POST VAS Feel High Score vs POST minimal Constriction \nOccasional Smokers")+
                             geom_smooth(aes(col = NULL), method = "lm", se=FALSE, 
                                         color="black", formula = y ~ x)+
                             geom_label(label = paste(expression("beta == "),
                                                  round(summary(postOccSmokers)$coefficients[2, 1], 2)),
                                        x = 3,
                                        y = 0,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                            geom_label(label = paste(expression("p =="),
                                                     round(summary(postOccSmokers)$coefficients[2, 4], 2)),
                                        x = 3,
                                        y = -3,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                             geom_label(label = paste(expression("rho == "),
                                                  round(cor(OccSmokers$min_constriction.post, 
                                                            OccSmokers$vas1_high_score), 3)),
                                        x = 3,
                                        y = -6,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
  
                             theme_bw()

chg_vas_minConstrict_occ <- ggplot(data = OccSmokers, 
                               aes(x = vas1_high_score, y = min_constriction_chg))+
                            geom_point()+
                            scale_y_continuous(limits = c(-20, 40))+
                            geom_vline(xintercept = 46,color = "darkred")+
                            labs(title = "POST VAS Feel High Score vs Change in minimal Constriction (post-pre) \nOccasional Smokers")+
                            geom_smooth(aes(col = NULL), method = "lm", se=FALSE, 
                                         color="black", formula = y ~ x)+
                             geom_label(label = paste(expression("beta == "),
                                                  round(summary(chgOccSmokers)$coefficients[2, 1], 2)),
                                        x = 3,
                                        y = -15,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                            geom_label(label = paste(expression("p =="),
                                                     round(summary(chgOccSmokers)$coefficients[2, 4], 2)),
                                        x = 3,
                                        y = -18,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                             geom_label(label = paste(expression("rho == "),
                                                  round(cor(OccSmokers$min_constriction_chg, 
                                                            OccSmokers$vas1_high_score), 3)),
                                        x = 3,
                                        y = -21,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
  
                             theme_bw()

# jpeg(file.path(res_folder, "Scatterplot_VAS_MinConstriction_Occ.jpg"),
#      height = 6, width = 23, res = 300, units = "in")
grid.arrange(pre_vas_minConstrict_occ, post_vas_minConstrict_occ , chg_vas_minConstrict_occ, nrow = 1)
# dev.off()

### Daily Users
DlySmokers <- AllSmokers[AllSmokers$user_cat == "daily", ]
preDlySmokers <- lm(min_constriction.pre2 ~ vas1_high_score, data = DlySmokers)
postDlySmokers <- lm(min_constriction.post ~ vas1_high_score, data = DlySmokers)
chgDlySmokers <- lm(min_constriction_chg ~ vas1_high_score, data = DlySmokers)


pre_vas_minConstrict_dly <- ggplot(data = DlySmokers, 
                               aes(x = vas1_high_score, 
                                   y = min_constriction.pre2))+
                             geom_point()+
                             scale_y_continuous(limits = c(-55, 0))+
                             geom_vline(xintercept = 46,color = "darkred")+
                             labs(title = "POST VAS Feel High Score vs PRE minimal Constriction \nDaily Smokers")+
                             geom_smooth(aes(col = NULL), method = "lm", se=FALSE, 
                                         color="black", formula = y ~ x)+
                             geom_label(label = paste(expression("beta == "),
                                                  round(summary(preDlySmokers)$coefficients[2, 1], 2)),
                                        x = 13,
                                        y = 0,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                            geom_label(label = paste(expression("p =="),
                                                     round(summary(preDlySmokers)$coefficients[2, 4], 2)),
                                        x = 13,
                                        y = -3,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                             geom_label(label = paste(expression("rho == "),
                                                  round(cor(DlySmokers$min_constriction.pre2, 
                                                            DlySmokers$vas1_high_score), 3)),
                                        x = 13,
                                        y = -6,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
  
                             theme_bw()


post_vas_minConstrict_dly <- ggplot(data = DlySmokers, 
                                aes(x = vas1_high_score, y = min_constriction.post))+
                             geom_point()+
                             scale_y_continuous(limits = c(-55, 0))+
                             geom_vline(xintercept = 46,color = "darkred")+
                             labs(title = "POST VAS Feel High Score vs POST minimal Constriction \nDaily Smokers")+
                             geom_smooth(aes(col = NULL), method = "lm", se=FALSE, 
                                         color="black", formula = y ~ x)+
                             geom_label(label = paste(expression("beta == "),
                                                  round(summary(postDlySmokers)$coefficients[2, 1], 2)),
                                        x = 13,
                                        y = 0,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                            geom_label(label = paste(expression("p =="),
                                                     round(summary(postDlySmokers)$coefficients[2, 4], 2)),
                                        x = 13,
                                        y = -3,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                             geom_label(label = paste(expression("rho == "),
                                                  round(cor(DlySmokers$min_constriction.post, 
                                                            DlySmokers$vas1_high_score), 3)),
                                        x = 13,
                                        y = -6,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
  
                             theme_bw()

chg_vas_minConstrict_dly <- ggplot(data = DlySmokers, 
                               aes(x = vas1_high_score, y = min_constriction_chg))+
                            geom_point()+
                            scale_y_continuous(limits = c(-20, 40))+
                            geom_vline(xintercept = 46,color = "darkred")+
                            labs(title = "POST VAS Feel High Score vs Change in minimal Constriction (post-pre) \nDaily Smokers")+
                            geom_smooth(aes(col = NULL), method = "lm", se=FALSE, 
                                         color="black", formula = y ~ x)+
                             geom_label(label = paste(expression("beta == "),
                                                  round(summary(chgDlySmokers)$coefficients[2, 1], 2)),
                                        x = 13,
                                        y = -15,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                            geom_label(label = paste(expression("p =="),
                                                     round(summary(chgDlySmokers)$coefficients[2, 4], 2)),
                                        x = 13,
                                        y = -18,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
                             geom_label(label = paste(expression("rho == "),
                                                  round(cor(DlySmokers$min_constriction_chg, 
                                                            DlySmokers$vas1_high_score), 3)),
                                        x = 13,
                                        y = -21,
                                        color = "black",
                                        label.size = NA, 
                                        parse = T, 
                                        hjust = 0)+
  
                             theme_bw()

# jpeg(file.path(res_folder, "Scatterplot_VAS_MinConstriction_DLY.jpg"),
#      height = 6, width = 23, res = 300, units = "in")
grid.arrange(pre_vas_minConstrict_dly, post_vas_minConstrict_dly , chg_vas_minConstrict_dly, nrow = 1)
# dev.off()
```

### VAS FoSR
```{r vas_fosr}
right_0.vas.df <- merge(right_0.post, pt.analytic.df[!(is.na(pt.analytic.df$vas_high)), ], 
                        by = c("subject_id", "user_cat"))

right_0.vas.df <- right_0.vas.df[order(right_0.vas.df$subject_id, right_0.vas.df$frame), ]
right_0.vas.df$sind <- right_0.vas.df$frame/400

m.post_vas <- mgcv::gam(percent_change ~ s(sind, k=30, bs="cr") + 
                          s(sind, by=vas_high, k=30, bs = "cr"), 
                  data = right_0.vas.df, method = "REML")

## Create a matrix of residuals
post_vas.resid <- cbind(right_0.vas.df[!(is.na(right_0.vas.df$percent_change)), 
                                       c("subject_id", "frame")], 
                        m.post_vas$residuals)
names(post_vas.resid) <- c("subject_id", "frame", "resid")
post_vas.resid$frame_char <- str_pad(post_vas.resid$frame, width = 3, side = "left", pad = "0")

resid_mat <- reshape(post_vas.resid[, c("subject_id", "frame_char", "resid")], 
                     timevar = "frame_char", 
                     idvar = "subject_id", 
                     direction = "wide")

rownames(resid_mat) <- resid_mat$subject_id
resid_mat$subject_id <- NULL
resid_names <- names(resid_mat)
resid_names <- sort(resid_names)
resid_mat <- resid_mat[, resid_names]

resid_mat <- as.matrix(resid_mat)

post_vas.fpca <- fpca.face(resid_mat, knots = 15)

#Create data frame of eigen functions and attach to original data
Phi_mat <- as.data.frame(post_vas.fpca$efunctions)
colnames(Phi_mat) <- paste0("Phi", seq(1, post_vas.fpca$npc))
Phi_mat$frame <- as.numeric(rownames(Phi_mat)) -1

right_0.vas.df <- merge(right_0.vas.df, Phi_mat, 
                        by = "frame", 
                        all.x = T)
right_0.vas.df <- right_0.vas.df[order(right_0.vas.df$subject_id, right_0.vas.df$frame), ]
right_0.vas.df$subject_id <- as.factor(right_0.vas.df$subject_id)

post_vas.fri <- mgcv::bam(percent_change ~ 
                            s(sind, k=30, bs="cr") + 
                            s(sind, by=vas_high, k=30, bs = "cr") + 
                            s(subject_id, by = Phi1, bs="re") + s(subject_id, by = Phi2, bs="re")+
                            s(subject_id, by = Phi3, bs="re") + s(subject_id, by = Phi4, bs="re"), 
                          method = "fREML", data = right_0.vas.df, discrete = TRUE)


summary(post_vas.fri)
```

### Plotting trajectory of occasional & daily user
```{r plot_vas}
post_vas.coef <- post_vas.fri$coefficients
post_vas.cov <- vcov.gam(post_vas.fri)

df_pred_non <- data.frame("sind" = unique(right_0.vas.df$sind), "vas_high" = 0,
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, 
                          "subject_id" = right_0.vas.df$subject_id[1])

lpmat_non <- predict(post_vas.fri, newdata=df_pred_non, se.fit=TRUE, type = "lpmatrix")


df_pred_high <- data.frame("sind" = unique(right_0.vas.df$sind), "vas_high" = 1,  
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
                            "Phi4" = 0, 
                          "subject_id" = right_0.vas.df$subject_id[1])

lpmat_high <- predict(post_vas.fri, newdata=df_pred_high, se.fit=TRUE, type = "lpmatrix")


pred_df <- data.frame(seconds = rep(seq(0, 400), 2)/30,
                      user = c(rep(0, 401), rep(1, 401)), 
                      mean = c(lpmat_non %*% post_vas.coef, 
                               lpmat_high %*% post_vas.coef), 
                      se = c(sqrt(diag(lpmat_non %*% post_vas.cov %*% t(lpmat_non))), 
                             sqrt(diag(lpmat_high %*% post_vas.cov %*% t(lpmat_high)))), 
                      stringsAsFactors = F)
pred_df$user <- factor(pred_df$user, 
                       levels = c(0, 1), 
                       labels = c("not high", "high"))

post_vasProfile <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                    geom_line()+
                    labs(y = "Percent Change")+
                    theme_bw()

legend_vasProfile <- g_legend(post_vasProfile)

post_vasProfile.se <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                    geom_line()+
                    geom_line(aes(x=seconds, y = mean + 2*se, group = user, col = user),
                              linetype = "longdash")+
                    geom_line(aes(x=seconds, y = mean - 2*se, group = user, col = user),
                              linetype = "longdash")+
                    labs(y = "")+
                    theme_bw()
                    
post_vasTraj <- grid.arrange(arrangeGrob(post_vasProfile+theme(legend.position = "none"), 
                                          post_vasProfile.se+theme(legend.position = "none"), 
                                         nrow = 1), 
                              legend_vasProfile, nrow = 1, 
                              widths = c(30, 6))
```

### Plot vas high vs not occassional users
```{r vas_dataplot}

right_0.vas.df$vas_high <- factor(right_0.vas.df$vas_high, 
                                  levels = c(0,1), 
                                  labels = c("not high", "high"))

ggplot(right_0.vas.df, aes(x=seconds, y = percent_change, group = subject_id, 
                           col = vas_high))+
  geom_line()+
  geom_line(data = pred_df[pred_df$user == "not high",], 
            aes(x=seconds, y = mean, group = user), color = "darkred", size = 1.2)+
    geom_line(data = pred_df[pred_df$user == "high",], 
            aes(x=seconds, y = mean, group = user), color = "darkblue", size = 1.2)+
  theme_bw()
```

### Effect for VAS "high" vs "not"
```{r vas_coef_effect_plots, fig.width = 10, fig.height=6}
pred_f1 <- predict(post_vas.fri, newdata=df_pred_high, se.fit=TRUE, type = "terms")

pred_coef_df <- data.frame(seconds = seq(0, 400)/30,
                           f1_hat = pred_f1$fit[, 2], 
                           f1_se = pred_f1$se.fit[, 2]) 

post_high_plt <- ggplot(data = pred_coef_df, aes(x=seconds, y = f1_hat))+
                geom_line()+
                geom_line(aes(x = seconds, y = f1_hat + 2*f1_se), linetype = "longdash")+
                geom_line(aes(x = seconds, y = f1_hat - 2*f1_se), linetype = "longdash")+
                geom_line(aes(x = seconds, y = 0), col = "darkred")+
                labs(title = "Difference in Percent Change: VAS high vs not (Post)", ylab = "Percent Change")+
                theme_bw()

ylab <- textGrob(label = "Difference in Percent Change", rot = 90, 
                 gp = gpar(fontsize = 12))
posval <- textGrob(label = sapply(strwrap("Less Constriction in User", width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))
negval <- textGrob(label = sapply(strwrap("More Constriction in User", width = 15, simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))

post_high_coef <- grid.arrange(ylab, posval, negval, post_high_plt, 
                              ncol = 2, nrow = 2, 
                              layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))

post_high_coef
```

## Correlation between left and & right eyes - post
```{r eyeCorr}
right_0.post.w2 <- right_0.post.w
right.names <- names(right_0.post.w2)
right.names <- c(right.names[1:3], paste0("R_", right.names[4:(length(right.names)-1)]), right.names[length(right.names)])
names(right_0.post.w2) <- right.names

left_0.post.w2 <- left_0.post.w
left.names <- names(left_0.post.w2)
left.names <- c(left.names[1:3], paste0("L_", left.names[4:(length(left.names)-1)]), left.names[length(left.names)]) 
names(left_0.post.w2) <- left.names


botheyes <- merge(right_0.post.w2, left_0.post.w2, 
                  by = c("subject_id", "tp", "user_cat"))

right.corr.names <- right.names[4:(length(right.names)-1)]
left.corr.names <- left.names[4:(length(left.names)-1)]

botheye.corr <- round(cor(botheyes[, right.corr.names[-1]], 
                          botheyes[, left.corr.names[-1]], use = "pairwise.complete.obs"), 3)


corr_df <- data.frame(frame = seq(1, 400, by = 1), 
                      btwEyeCor = diag(botheye.corr))

# get_upper_tri <- function(cormat){
#     cormat[lower.tri(cormat)]<- NA
#     return(cormat)
# }
# 
# upper_tri <- get_upper_tri(botheye.corr)

# library(reshape2)
# 
# melted_cor_mat <- melt(botheye.corr)
# names(melted_cor_mat) <- c("RightEye", "LeftEye", "value")
# 
# jpeg(file.path(res_folder, "Corr_Left_Right_Eyes.jpg"),
#      height = 6, width = 15, res = 300, units = "in")
# ggplot(data = melted_cor_mat, aes(RightEye, LeftEye, fill = value))+
#  geom_tile()+
#  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
#    midpoint = 0, limit = c(-0.2,1), space = "Lab", 
#    name="Pearson\nCorrelation") +
#   theme_bw()+ 
#  theme(axis.text.x = element_blank(),
#        axis.text.y = element_blank())+
#  coord_fixed()
# dev.off()

ggplot(data = corr_df, aes(frame, btwEyeCor))+
  geom_point()+
  scale_y_continuous(limits = c(0,1))+
  labs(title = "Correlation between eyes -- POST")+
  theme_bw()
```

## Correlation between left and & right eyes - wpd
```{r wi_eyeCorr}
right_0.pt.w2 <- right_0.pt.w
right.names <- names(right_0.pt.w2)
right.names <- c(right.names[1:2], paste0("R_", right.names[3:(length(right.names)-1)]), right.names[length(right.names)])
names(right_0.pt.w2) <- right.names

left_0.pt.w2 <- left_0.pt.w
left.names <- names(left_0.pt.w2)
left.names <- c(left.names[1:2], paste0("L_", left.names[3:(length(left.names)-1)]), left.names[length(left.names)])
names(left_0.pt.w2) <- left.names


wpd_botheyes <- merge(right_0.pt.w2, left_0.pt.w2, 
                  by = c("subject_id", "user_cat"))

right.corr.names <- right.names[3:(length(right.names)-1)]
left.corr.names <- left.names[3:(length(left.names)-1)]

wpd_botheye.corr <- round(cor(wpd_botheyes[, right.corr.names],
                              wpd_botheyes[, left.corr.names], 
                              use = "pairwise.complete.obs"), 3)


wpd_corr_df <- data.frame(frame = seq(1, 400, by = 1), 
                      btwEyeCor = diag(wpd_botheye.corr))

ggplot(data = wpd_corr_df, aes(frame, btwEyeCor))+
  geom_point()+
  scale_y_continuous(limits = c(0,1))+
  labs(title = "Correlation between eyes -- WPD")+
  theme_bw()
```

## Time from consumption to post test
```{r timepostconsump}
wi.consump.m <- lm(postConsumpTimeToTest ~ PC1 + PC2 + PC3 + PC4 + PC5 + PC6, data = pt.wi.scores)
summary(wi.consump.m)

post.consump.m <- lm(postConsumpTimeToTest ~ PC1 + PC2 + PC3 + PC4, data = pt.scores)
summary(post.consump.m)

pt.analytic.df <-  merge(pt.analytic.df, pt.wi.scores[, c("subject_id", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6")], 
                         by = "subject_id")
names(pt.analytic.df)[names(pt.analytic.df) == "PC1"] <- "wpd.PC1"
names(pt.analytic.df)[names(pt.analytic.df) == "PC2"] <- "wpd.PC2"
names(pt.analytic.df)[names(pt.analytic.df) == "PC3"] <- "wpd.PC3"
names(pt.analytic.df)[names(pt.analytic.df) == "PC4"] <- "wpd.PC4"
names(pt.analytic.df)[names(pt.analytic.df) == "PC5"] <- "wpd.PC5"
names(pt.analytic.df)[names(pt.analytic.df) == "PC6"] <- "wpd.PC6"

pt.analytic.df <-  merge(pt.analytic.df, pt.scores[, c("subject_id", "PC1", "PC2", "PC3", "PC4")], 
                         by = "subject_id")
names(pt.analytic.df)[names(pt.analytic.df) == "PC1"] <- "post.PC1"
names(pt.analytic.df)[names(pt.analytic.df) == "PC2"] <- "post.PC2"
names(pt.analytic.df)[names(pt.analytic.df) == "PC3"] <- "post.PC3"
names(pt.analytic.df)[names(pt.analytic.df) == "PC4"] <- "post.PC4"


table1(~ postConsumpTimeToTest + Post_PreTime|user_cat, 
       data = pt.analytic.df)

by(pt.analytic.df$postConsumpTimeToTest, INDICES = list(pt.analytic.df$user_cat), summary)

postConsump.cor <- cor(pt.analytic.df$postConsumpTimeToTest, 
                       pt.analytic.df[, c("demo_age", "demo_weight", "demo_height", "BMI",
                                          "thc.post", "min_constriction.post", "slope.post",
                                          "AUC.post", "thc_chg", "min_constriction_chg",
                                          "AUC_chg", "wpd.PC1", "wpd.PC2", "wpd.PC3",
                                          "wpd.PC4", "wpd.PC5", "wpd.PC6", 
                                          "post.PC1", "post.PC2", "post.PC3", "post.PC4",
                                          "vas1_high_score", "vas_high_score_chg", 
                                          "vas1_score_dc", "vas_score_dc_chg",
                                          "Post_PreTime")], 
                       use = "pairwise.complete.obs")

postConsump.rcorr <- rcorr(as.matrix(pt.analytic.df[, c("postConsumpTimeToTest",
                                                        "demo_age", "demo_weight",
                                                        "demo_height", "BMI",
                                                        "thc.post", "min_constriction.post",
                                                        "slope.post", "AUC.post",
                                                        "thc_chg", "min_constriction_chg",
                                                        "AUC_chg",
                                                        "wpd.PC1", "wpd.PC2", "wpd.PC3",
                                                        "wpd.PC4", "wpd.PC5", "wpd.PC6",
                                                        "post.PC1", "post.PC2", 
                                                        "post.PC3", "post.PC4",
                                                        "vas1_high_score", 
                                                        "vas_high_score_chg",
                                                        "vas1_score_dc", 
                                                        "vas_score_dc_chg", 
                                                        "Post_PreTime")]))

postConsump.cor.df <- data.frame(postConsump_rho = postConsump.rcorr$r[, 1], 
                                 postConsump_p = postConsump.rcorr$P[, 1], 
                                 postConsump_n = postConsump.rcorr$n[, 1])
postConsump.cor.df <- postConsump.cor.df[order(-1*abs(postConsump.cor.df$postConsump_rho)), ]
postConsump.cor.df <- postConsump.cor.df[-1, ]
rm(postConsump.rcorr)

knitr::kable(postConsump.cor.df)

ggplot(data = pt.analytic.df[pt.analytic.df$user_cat != "non-user", ], aes(x = user_cat, y = postConsumpTimeToTest, col = user_cat))+
  geom_boxplot()+
  theme_bw()

ggplot(data = pt.analytic.df[pt.analytic.df$user_cat != "non-user", ], aes(x = demo_gender, y = postConsumpTimeToTest, col = demo_gender))+
  geom_boxplot()+
  theme_bw()

ggplot(data = pt.analytic.df[pt.analytic.df$user_cat != "non-user", ], aes(x = postConsumpTimeToTest, y = Post_PreTime, col = user_cat))+
  geom_point()+
  theme_bw()

ggplot(data = pt.analytic.df[pt.analytic.df$user_cat != "non-user", ], aes(x = postConsumpTimeToTest, y = min_constriction.post, col = user_cat))+
  geom_point()+
  theme_bw()

ggplot(data = pt.analytic.df[pt.analytic.df$user_cat != "non-user", ], aes(x = postConsumpTimeToTest, y = post.PC2, col = user_cat))+
  geom_point()+
  theme_bw()

ggplot(data = pt.analytic.df[pt.analytic.df$user_cat != "non-user", ], aes(x = postConsumpTimeToTest, y = wpd.PC3, col = user_cat))+
  geom_point()+
  theme_bw()
```


### FoSR Post -- Interaction with Post Consumption Time to Test (PCTT)
$$ 
\begin{aligned}
Y_{i}(t) &= f_0(t) + f_1(t)*I(user = occasional) + f_2(t)*I(user = daily) +f_3(t)*I(user = occasional)*PCTT + f_4(t)*I(user = daily)*PCTT + b_i(t) + \epsilon_i(t)\\
& b_i(t) \sim GP(0, \Sigma_b) \\
& \epsilon_i(t) \sim N(0, \sigma_{\epsilon}^2) \\
&= \sum_{k=1}^K \xi_{0k}\phi_{0k}(t_i) + \sum_{k=1}^K \xi_{1k}\phi_{1k}(t_i)*I(user = occasional) + \sum_{k=1}^K \xi_{2k}\phi_{2k}(t_i)*I(user = daily)\\ &+ \sum_{k=1}^K \xi_{3k}\phi_{3k}(t_i)*I(user = occasional)*PCTT + \sum_{k=1}^K \xi_{4k}\phi_{4k}(t_i)*I(user = daily)*PCTT + \sum_{k=1}^K \xi_{ik}\phi_k(t_i) + \epsilon_i(t)\\
\end{aligned}
$$


```{r post_gam_intPCTT}
pt.analytic.df$postConsumpTimeToTest_c <- pt.analytic.df$postConsumpTimeToTest- round(mean(pt.analytic.df$postConsumpTimeToTest, na.rm = T), 3)

summary(pt.analytic.df$postConsumpTimeToTest_c)
by(data = pt.analytic.df$postConsumpTimeToTest_c, INDICES = pt.analytic.df$user_cat, FUN = summary)

pt.analytic.df$occ_PCTT <- pt.analytic.df$occasional*pt.analytic.df$postConsumpTimeToTest_c
pt.analytic.df$dly_PCTT <- pt.analytic.df$daily*pt.analytic.df$postConsumpTimeToTest_c
pt.analytic.df$occ_PCTT[pt.analytic.df$user == "non-user"] <- 0
pt.analytic.df$dly_PCTT[pt.analytic.df$user == "non-user"] <- 0

post_intPCTT.gam.df <- merge(right_0.post, pt.analytic.df,
                             by = c("subject_id", "user_cat"))

# right_0.gam.df <- right_0.gam.df[order(right_0.gam.df$subject_id, right_0.gam.df$frame), ]
post_intPCTT.gam.df$sind <- post_intPCTT.gam.df$frame/400

# head(right_0.gam.df)

m.post_intPCTT_gam <- mgcv::bam(percent_change ~ s(sind, k=30, bs="cr") +
                                  s(sind, by=occasional, k=30, bs = "cr") +
                                  s(sind, by=daily, k=30, bs = "cr") +
                                  s(sind, by=occ_PCTT, k=30, bs = "cr") + 
                                  s(sind, by=dly_PCTT, k=30, bs = "cr"), 
                                data = post_intPCTT.gam.df, method = "REML")
summary(m.post_intPCTT_gam)
## Create a matrix of residuals
post_intPCTT_gam.resid <- cbind(post_intPCTT.gam.df[!(is.na(post_intPCTT.gam.df$percent_change)), 
                                       c("subject_id", "frame")],
                                m.post_intPCTT_gam$residuals)
names(post_intPCTT_gam.resid) <- c("subject_id", "frame", "resid")
# post_gam.resid$frame_char <- str_pad(post_gam.resid$frame, width = 3, side = "left", pad = "0")

resid_mat <- reshape(post_intPCTT_gam.resid[, c("subject_id", "frame", "resid")], 
                     timevar = "frame", 
                     idvar = "subject_id", 
                     direction = "wide")
rownames(resid_mat) <- resid_mat$subject_id
resid_mat$subject_id <- NULL
# resid_names <- names(resid_mat)
# resid_names <- sort(resid_names)
# resid_mat <- resid_mat[, resid_names]

resid_mat <- as.matrix(resid_mat)

post_intPCTT_gam.fpca <- fpca.face(resid_mat, knots = 15)

#Create data frame of eigen functions and attach to original data
Phi_mat <- as.data.frame(post_gam.fpca$efunctions)
colnames(Phi_mat) <- paste0("Phi", seq(1, post_gam.fpca$npc))
Phi_mat$frame <- as.numeric(rownames(Phi_mat)) -1

post_intPCTT.gam.df <- merge(post_intPCTT.gam.df, Phi_mat, 
                        by = "frame", 
                        all.x = T)
post_intPCTT.gam.df <- post_intPCTT.gam.df[order(post_intPCTT.gam.df$subject_id, post_intPCTT.gam.df$frame), ]
post_intPCTT.gam.df$subject_id <- as.factor(post_intPCTT.gam.df$subject_id)

post_intPCTT_gam.fri <- mgcv::bam(percent_change ~ 
                            s(sind, k=30, bs="cr") +
                            s(sind, by=occasional, k=30, bs = "cr") +
                            s(sind, by=daily, k=30, bs = "cr") +
                            s(sind, by=occ_PCTT, k=30, bs = "cr") + 
                            s(sind, by=dly_PCTT, k=30, bs = "cr")+
                            s(subject_id, by = Phi1, bs="re") + s(subject_id, by = Phi2, bs="re")+
                            s(subject_id, by = Phi3, bs="re") + s(subject_id, by = Phi4, bs="re"), 
                          method = "fREML", data = post_intPCTT.gam.df, discrete = TRUE)


summary(post_intPCTT_gam.fri)
```

### Plotting trajectory of occasional & daily user
```{r plot_occ_intPCTT}
post_intPCTT_gam.coef <- post_intPCTT_gam.fri$coefficients
post_intPCTT_gam.cov <- vcov.gam(post_intPCTT_gam.fri)

df_pred_non <- data.frame("sind" = unique(post_intPCTT.gam.df$sind), "occasional" = 0, "daily" = 0, "occ_PCTT" = 0, "dly_PCTT" = 0,
                          "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, "Phi4" = 0, 
                          "subject_id" = post_intPCTT.gam.df$subject_id[1])

lpmat_non <- predict(post_intPCTT_gam.fri, newdata=df_pred_non, se.fit=TRUE, type = "lpmatrix")


df_pred_occ <- data.frame("sind" = unique(post_intPCTT.gam.df$sind), "occasional" = 1, "daily" = 0, "occ_PCTT" = 0, "dly_PCTT" = 0,
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, "Phi4" = 0, 
                          "subject_id" = post_intPCTT.gam.df$subject_id[1])

lpmat_occ <- predict(post_intPCTT_gam.fri, newdata=df_pred_occ, se.fit=TRUE, type = "lpmatrix")

df_pred_occP10 <- data.frame("sind" = unique(post_intPCTT.gam.df$sind), "occasional" = 1, "daily" = 0, "occ_PCTT" = 10, "dly_PCTT" = 0,
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, "Phi4" = 0, 
                          "subject_id" = post_intPCTT.gam.df$subject_id[1])

lpmat_occP10 <- predict(post_intPCTT_gam.fri, newdata=df_pred_occP10, se.fit=TRUE, type = "lpmatrix")

df_pred_occM10 <- data.frame("sind" = unique(post_intPCTT.gam.df$sind), "occasional" = 1, "daily" = 0, "occ_PCTT" = -10, "dly_PCTT" = 0,
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, "Phi4" = 0, 
                          "subject_id" = post_intPCTT.gam.df$subject_id[1])

lpmat_occM10 <- predict(post_intPCTT_gam.fri, newdata=df_pred_occM10, se.fit=TRUE, type = "lpmatrix")


# df_pred_dly <- data.frame("sind" = unique(right_0.gam.df$sind), "occasional" = 0, "daily" = 1, 
#                             "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
#                             "Phi4" = 0, 
#                           "subject_id" = right_0.gam.df$subject_id[1])
# 
# lpmat_dly <- predict(post_gam.fri, newdata=df_pred_dly, se.fit=TRUE, type = "lpmatrix")


pred_df <- data.frame(seconds = rep(seq(0, 400), 4)/30,
                      user = c(rep("non-user", 401), rep("occasional", 401), rep("occ+10", 401), rep("occ-10", 401)
                               # rep("daily", 401)
                               ), 
                      mean = c(lpmat_non %*% post_intPCTT_gam.coef, 
                               lpmat_occ %*% post_intPCTT_gam.coef,
                               lpmat_occP10 %*% post_intPCTT_gam.coef, 
                               lpmat_occM10 %*% post_intPCTT_gam.coef
                               # lpmat_dly %*% post_gam.coef
                               ), 
                      se = c(sqrt(diag(lpmat_non %*% post_intPCTT_gam.cov %*% t(lpmat_non))), 
                             sqrt(diag(lpmat_occ %*% post_intPCTT_gam.cov %*% t(lpmat_occ))),
                             sqrt(diag(lpmat_occP10 %*% post_intPCTT_gam.cov %*% t(lpmat_occP10))), 
                             sqrt(diag(lpmat_occM10 %*% post_intPCTT_gam.cov %*% t(lpmat_occM10)))
                             
                             # sqrt(diag(lpmat_dly %*% post_gam.cov %*% t(lpmat_dly)))
                             ), 
                      stringsAsFactors = F)

post_userProfile <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                    geom_line()+
                    labs(y = "Percent Change")+
                    theme_bw()

legend_userProfile <- g_legend(post_userProfile)

post_userProfile.se <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                    geom_line()+
                    geom_line(aes(x=seconds, y = mean + 2*se, group = user, col = user),
                              linetype = "longdash")+
                    geom_line(aes(x=seconds, y = mean - 2*se, group = user, col = user),
                              linetype = "longdash")+
                    labs(y = "")+
                    theme_bw()
                    
post_userTraj <- grid.arrange(arrangeGrob(post_userProfile+theme(legend.position = "none"), 
                                          post_userProfile.se+theme(legend.position = "none"), nrow = 1), 
                              legend_userProfile, nrow = 1, 
                              widths = c(30, 6))
```

```{r plot_dly_intPCTT}
# post_intPCTT_gam.coef <- post_intPCTT_gam.fri$coefficients
# post_intPCTT_gam.cov <- vcov.gam(post_intPCTT_gam.fri)
# 
# df_pred_non <- data.frame("sind" = unique(post_intPCTT.gam.df$sind), "occasional" = 0, "daily" = 0, "occ_PCTT" = 0, "dly_PCTT" = 0,
#                           "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, "Phi4" = 0, 
#                           "subject_id" = post_intPCTT.gam.df$subject_id[1])
# 
# lpmat_non <- predict(post_intPCTT_gam.fri, newdata=df_pred_non, se.fit=TRUE, type = "lpmatrix")


df_pred_dly <- data.frame("sind" = unique(post_intPCTT.gam.df$sind), "occasional" = 0, "daily" = 1, "occ_PCTT" = 0, "dly_PCTT" = 0,
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, "Phi4" = 0, 
                          "subject_id" = post_intPCTT.gam.df$subject_id[1])

lpmat_dly <- predict(post_intPCTT_gam.fri, newdata=df_pred_dly, se.fit=TRUE, type = "lpmatrix")

df_pred_dlyP10 <- data.frame("sind" = unique(post_intPCTT.gam.df$sind), "occasional" = 0, "daily" = 1, "occ_PCTT" = 0, "dly_PCTT" = 10,
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, "Phi4" = 0, 
                          "subject_id" = post_intPCTT.gam.df$subject_id[1])

lpmat_dlyP10 <- predict(post_intPCTT_gam.fri, newdata=df_pred_dlyP10, se.fit=TRUE, type = "lpmatrix")

df_pred_dlyM10 <- data.frame("sind" = unique(post_intPCTT.gam.df$sind), "occasional" = 0, "daily" = 1, "occ_PCTT" = 0, "dly_PCTT" = -10,
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, "Phi4" = 0, 
                          "subject_id" = post_intPCTT.gam.df$subject_id[1])

lpmat_dlyM10 <- predict(post_intPCTT_gam.fri, newdata=df_pred_dlyM10, se.fit=TRUE, type = "lpmatrix")


# df_pred_dly <- data.frame("sind" = unique(right_0.gam.df$sind), "occasional" = 0, "daily" = 1, 
#                             "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, 
#                             "Phi4" = 0, 
#                           "subject_id" = right_0.gam.df$subject_id[1])
# 
# lpmat_dly <- predict(post_gam.fri, newdata=df_pred_dly, se.fit=TRUE, type = "lpmatrix")


pred_df <- data.frame(seconds = rep(seq(0, 400), 4)/30,
                      user = c(rep("non-user", 401), rep("daily", 401), rep("dly+10", 401), rep("dly-10", 401)
                               # rep("daily", 401)
                               ), 
                      mean = c(lpmat_non %*% post_intPCTT_gam.coef, 
                               lpmat_dly %*% post_intPCTT_gam.coef,
                               lpmat_dlyP10 %*% post_intPCTT_gam.coef, 
                               lpmat_dlyM10 %*% post_intPCTT_gam.coef
                               # lpmat_dly %*% post_gam.coef
                               ), 
                      se = c(sqrt(diag(lpmat_non %*% post_intPCTT_gam.cov %*% t(lpmat_non))), 
                             sqrt(diag(lpmat_dly %*% post_intPCTT_gam.cov %*% t(lpmat_dly))),
                             sqrt(diag(lpmat_dlyP10 %*% post_intPCTT_gam.cov %*% t(lpmat_dlyP10))), 
                             sqrt(diag(lpmat_dlyM10 %*% post_intPCTT_gam.cov %*% t(lpmat_dlyM10)))
                             
                             # sqrt(diag(lpmat_dly %*% post_gam.cov %*% t(lpmat_dly)))
                             ), 
                      stringsAsFactors = F)

post_userProfile <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                    geom_line()+
                    labs(y = "Percent Change")+
                    theme_bw()

legend_userProfile <- g_legend(post_userProfile)

post_userProfile.se <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                    geom_line()+
                    geom_line(aes(x=seconds, y = mean + 2*se, group = user, col = user),
                              linetype = "longdash")+
                    geom_line(aes(x=seconds, y = mean - 2*se, group = user, col = user),
                              linetype = "longdash")+
                    labs(y = "")+
                    theme_bw()
                    
post_userTraj <- grid.arrange(arrangeGrob(post_userProfile+theme(legend.position = "none"), 
                                          post_userProfile.se+theme(legend.position = "none"), nrow = 1), 
                              legend_userProfile, nrow = 1, 
                              widths = c(30, 6))
```


```{r coef_effect_plots_intPCTT}
df_pred_occInt <- data.frame("sind" = unique(post_intPCTT.gam.df$sind), 
                             "occasional" = 0, "daily" = 0, 
                             "occ_PCTT" = 10, "dly_PCTT" = 0,
                            "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, "Phi4" = 0, 
                          "subject_id" = post_intPCTT.gam.df$subject_id[1])

# lpmat_occInt <- predict(post_intPCTT_gam.fri, newdata=df_pred_occInt, se.fit=TRUE, type = "lpmatrix")

pred_f1 <- predict(post_intPCTT_gam.fri, newdata=df_pred_occInt, se.fit=TRUE, type = "terms")
# pred_f2 <- predict(post_intPCTT_gam.fri, newdata=df_pred_dly, se.fit=TRUE, type = "terms")

pred_coef_df <- data.frame(seconds = seq(0, 400)/30,
                           # f0_hat = lpmat_non %*% post_gam.coef, 
                           # f0_se = sqrt(diag(lpmat_non %*% post_gam.cov %*% t(lpmat_non))), 
                           f1_hat = pred_f1$fit[, 4], 
                           f1_se = pred_f1$se.fit[, 4]
                           # ,
                           # f2_hat = pred_f2$fit[, 3],
                           # f2_se = pred_f2$se.fit[, 3]
                           )

# post_non_plt <- ggplot(data = pred_coef_df, aes(x=seconds, y = f0_hat))+
#                 geom_line()+
#                 geom_line(aes(x = seconds, y = f0_hat + 2*f0_se), linetype = "longdash")+
#                 geom_line(aes(x = seconds, y = f0_hat - 2*f0_se), linetype = "longdash")+
#                 labs(title = "Average Percent Change of a Non-user (Post)", ylab = "Percent Change")+
#                 theme_bw()

post_occ_plt <- ggplot(data = pred_coef_df, aes(x=seconds, y = f1_hat))+
                geom_line()+
                geom_line(aes(x = seconds, y = f1_hat + 2*f1_se), linetype = "longdash")+
                geom_line(aes(x = seconds, y = f1_hat - 2*f1_se), linetype = "longdash")+
                geom_line(aes(x = seconds, y = 0), col = "darkred")+
                labs(title = "Difference in Percent Change: Occasional Interaction (Post)", 
                     y= "")+
                theme_bw()+
                scale_x_continuous(expand = c(0, 0))+
                theme(rect = element_rect(fill = "transparent"))

# post_dly_plt <- ggplot(data = pred_coef_df, aes(x=seconds, y = f2_hat))+
#                 geom_line()+
#                 geom_line(aes(x = seconds, y = f2_hat + 2*f2_se), linetype = "longdash")+
#                 geom_line(aes(x = seconds, y = f2_hat - 2*f2_se), linetype = "longdash")+
#                 geom_line(aes(x = seconds, y = 0), col = "darkred")+
#                 labs(title = "Difference in Percent Change: Daily and Non-user (Post)", 
#                      y = "")+
#                 theme_bw()+
#                 scale_x_continuous(expand = c(0, 0))+
#                 theme(rect = element_rect(fill = "transparent"))

# ylab <- textGrob(label = "Difference in Percent Change", rot = 90, 
#                  gp = gpar(fontsize = 12))
# posval <- textGrob(label = sapply(strwrap("Less Constriction in User", width = 15, simplify = F),
#                                   paste, collapse = "\n"), rot = 0, 
#                  gp = gpar(fontsize = 8))
# negval <- textGrob(label = sapply(strwrap("More Constriction in User", width = 15, simplify = F),
#                                   paste, collapse = "\n"), rot = 0, 
#                  gp = gpar(fontsize = 8))
# 
# post_occ_coef <- grid.arrange(ylab, posval, negval, post_occ_plt, 
#                               ncol = 2, nrow = 2, 
#                               layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))
# 
# post_dly_coef <- grid.arrange(ylab, posval, negval, post_dly_plt, 
#                               ncol = 2, nrow = 2, 
#                               layout_matrix = rbind(c(1, 2, rep(4, 15)), c(1, 3, rep(4, 15))))
post_occ_plt
```

Plot difference between daily and occasional user

```{r diff_dly_occ_intPCTT, eval=F}
f2_f1 <- (lpmat_dly - lpmat_occ) %*% post_gam.coef
f2_f1.se <- sqrt(diag((lpmat_dly - lpmat_occ) %*% post_gam.cov %*% t((lpmat_dly - lpmat_occ))))

f2_f1_diff_df <- data.frame(seconds = seq(0, 400)/30, 
                            f2f1_diff = f2_f1, 
                            f2f1_se = f2_f1.se)

ggplot(data = f2_f1_diff_df, aes(x=seconds, y = f2f1_diff))+
  geom_line()+
  geom_line(aes(x = seconds, y = f2f1_diff + 2*f2f1_se), linetype = "longdash")+
  geom_line(aes(x = seconds, y = f2f1_diff - 2*f2f1_se), linetype = "longdash")+
  labs(title = "Difference between Average Daily vs Occasional User", ylab = "f2_hat - f1_hat")+
  theme_bw()

post_dlyocc_plt <- ggplot(data = f2_f1_diff_df, aes(x=seconds, y = f2f1_diff))+
                   geom_line()+
                   geom_line(aes(x = seconds, y = f2f1_diff + 2*f2f1_se), linetype = "longdash")+
                   geom_line(aes(x = seconds, y = f2f1_diff - 2*f2f1_se), linetype = "longdash")+
                   geom_line(aes(x = seconds, y = 0), col = "darkred")+
                   labs(title = "Difference in Percent Change: Daily vs Occasional User", 
                        y = "")+
                   theme_bw()+
                   scale_x_continuous(expand = c(0, 0))+
                   theme(rect = element_rect(fill = "transparent"))

ylab <- textGrob(label = "Difference in Percent Change", rot = 90, 
                 gp = gpar(fontsize = 12))
posval <- textGrob(label = sapply(strwrap("Less Constriction in Daily User", width = 15, 
                                          simplify = F),
                                  paste, collapse = "\n"), rot = 0, just = "bottom", 
                 gp = gpar(fontsize = 8))
negval <- textGrob(label = sapply(strwrap("More Constriction in Daily User", width = 15, 
                                          simplify = F),
                                  paste, collapse = "\n"), rot = 0, 
                 gp = gpar(fontsize = 8))

post_dlyocc_coef <- grid.arrange(ylab, posval, negval, post_dlyocc_plt, 
                                 ncol = 2, nrow = 2, 
                                 layout_matrix = rbind(c(1, 2, rep(4, 15)), 
                                                       c(1, 3, rep(4, 15))))

post_dlyocc_coef
```

```{r post_gam_intPCTT_smokers}
pt.analytic.df$smoker <- ifelse(pt.analytic.df$user_cat == "non-user", 0, 1)

pt.analytic.df$smoke_PCTT <- pt.analytic.df$smoker*pt.analytic.df$postConsumpTimeToTest_c
pt.analytic.df$smoke_PCTT[pt.analytic.df$user == "non-user"] <- 0


by(data = pt.analytic.df$postConsumpTimeToTest_c, INDICES = pt.analytic.df$smoker, FUN = summary)


post_intPCTT_smoke.gam.df <- merge(right_0.post, pt.analytic.df,
                             by = c("subject_id", "user_cat", "eye"))

# right_0.gam.df <- right_0.gam.df[order(right_0.gam.df$subject_id, right_0.gam.df$frame), ]
post_intPCTT_smoke.gam.df$sind <- post_intPCTT_smoke.gam.df$frame/400

# head(right_0.gam.df)

m.post_intPCTT_smoke_gam <- mgcv::bam(percent_change ~ s(sind, k=30, bs="cr") +
                                  s(sind, by=smoker, k=30, bs = "cr") +
                                  s(sind, by=smoke_PCTT, k=30, bs = "cr"), 
                                data = post_intPCTT_smoke.gam.df, method = "REML")
summary(m.post_intPCTT_smoke_gam)

## Create a matrix of residuals
post_intPCTT_smoke_gam.resid <- cbind(post_intPCTT_smoke.gam.df[!(is.na(post_intPCTT_smoke.gam.df$percent_change)), 
                                       c("subject_id", "frame")],
                                m.post_intPCTT_smoke_gam$residuals)
names(post_intPCTT_smoke_gam.resid) <- c("subject_id", "frame", "resid")
# post_gam.resid$frame_char <- str_pad(post_gam.resid$frame, width = 3, side = "left", pad = "0")

resid_mat <- reshape(post_intPCTT_smoke_gam.resid[, c("subject_id", "frame", "resid")], 
                     timevar = "frame", 
                     idvar = "subject_id", 
                     direction = "wide")
rownames(resid_mat) <- resid_mat$subject_id
resid_mat$subject_id <- NULL
# resid_names <- names(resid_mat)
# resid_names <- sort(resid_names)
# resid_mat <- resid_mat[, resid_names]

resid_mat <- as.matrix(resid_mat)

post_intPCTT_smoke_gam.fpca <- fpca.face(resid_mat, knots = 15)

#Create data frame of eigen functions and attach to original data
Phi_mat <- as.data.frame(post_intPCTT_smoke_gam.fpca$efunctions)
colnames(Phi_mat) <- paste0("Phi", seq(1, post_intPCTT_smoke_gam.fpca$npc))
Phi_mat$frame <- as.numeric(rownames(Phi_mat)) -1

post_intPCTT_smoke.gam.df <- merge(post_intPCTT_smoke.gam.df, Phi_mat, 
                        by = "frame", 
                        all.x = T)

post_intPCTT_smoke.gam.df <- post_intPCTT_smoke.gam.df[order(post_intPCTT_smoke.gam.df$subject_id,
                                                             post_intPCTT_smoke.gam.df$frame), ]
post_intPCTT_smoke.gam.df$subject_id <- as.factor(post_intPCTT_smoke.gam.df$subject_id)

post_intPCTT_smoke.gam.fri <- mgcv::bam(percent_change ~ 
                            s(sind, k=30, bs="cr") +
                            s(sind, by=smoker, k=30, bs = "cr") +
                            s(sind, by=smoke_PCTT, k=30, bs = "cr") +
                            s(subject_id, by = Phi1, bs="re") + s(subject_id, by = Phi2, bs="re")+
                            s(subject_id, by = Phi3, bs="re") + s(subject_id, by = Phi4, bs="re"), 
                          method = "fREML", data = post_intPCTT_smoke.gam.df, discrete = TRUE)


summary(post_intPCTT_smoke.gam.fri)
```

## Trajectories for smokers with different PCTT and non-smokers 
```{r post_smoke_PCTT_traj}
# create plot categories based on the 25th, 50th and 75th percentile
plot_cat <- c(59, 62, 65) - round(mean(pt.analytic.df$postConsumpTimeToTest, na.rm = T), 3) 

post_intPCTT_smoke_gam.coef <- post_intPCTT_smoke.gam.fri$coefficients
post_intPCTT_smoke_gam.cov <- vcov.gam(post_intPCTT_smoke.gam.fri)

### -- Non-smoker
df_pred_non <- data.frame("sind" = unique(post_intPCTT_smoke.gam.df$sind), 
                          "smoker" = 0, 
                          "smoke_PCTT" = 0, 
                          "dly_PCTT" = 0,
                          "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, "Phi4" = 0, 
                          "subject_id" = post_intPCTT_smoke.gam.df$subject_id[1])

lpmat_non <- predict(post_intPCTT_smoke.gam.fri, newdata=df_pred_non, se.fit=TRUE, type = "lpmatrix")

### -- Smoker with median PCTT
df_pred_smoke50 <- data.frame("sind" = unique(post_intPCTT_smoke.gam.df$sind), 
                          "smoker" = 1, 
                          "smoke_PCTT" = plot_cat[2], 
                          "dly_PCTT" = 0,
                          "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, "Phi4" = 0, 
                          "subject_id" = post_intPCTT_smoke.gam.df$subject_id[1])

lpmat_smoke50 <- predict(post_intPCTT_smoke.gam.fri, newdata=df_pred_smoke50, se.fit=TRUE, type = "lpmatrix")

### -- Smoker with 25th%-ile PCTT
df_pred_smoke25 <- data.frame("sind" = unique(post_intPCTT_smoke.gam.df$sind), 
                          "smoker" = 1, 
                          "smoke_PCTT" = plot_cat[1], 
                          "dly_PCTT" = 0,
                          "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, "Phi4" = 0, 
                          "subject_id" = post_intPCTT_smoke.gam.df$subject_id[1])

lpmat_smoke25 <- predict(post_intPCTT_smoke.gam.fri, newdata=df_pred_smoke25, se.fit=TRUE, type = "lpmatrix")


### -- Smoker with 75th%-ile PCTT
df_pred_smoke75 <- data.frame("sind" = unique(post_intPCTT_smoke.gam.df$sind), 
                          "smoker" = 1, 
                          "smoke_PCTT" = plot_cat[3], 
                          "dly_PCTT" = 0,
                          "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, "Phi4" = 0, 
                          "subject_id" = post_intPCTT_smoke.gam.df$subject_id[1])

lpmat_smoke75 <- predict(post_intPCTT_smoke.gam.fri, newdata=df_pred_smoke75, se.fit=TRUE, type = "lpmatrix")


pred_df <- data.frame(seconds = rep(seq(0, 400), 4)/30,
                      user = c(rep("non-smoker", 401), 
                               rep("smoker-62", 401), 
                               rep("smoker-59", 401), 
                               rep("smoker-65", 401)
                               ), 
                      mean = c(lpmat_non %*% post_intPCTT_smoke_gam.coef, 
                               lpmat_smoke50 %*% post_intPCTT_smoke_gam.coef, 
                               lpmat_smoke25 %*% post_intPCTT_smoke_gam.coef,
                               lpmat_smoke75 %*% post_intPCTT_smoke_gam.coef
                               ), 
                      se = c(sqrt(diag(lpmat_non %*% post_intPCTT_smoke_gam.cov %*% t(lpmat_non))), 
                             sqrt(diag(lpmat_smoke50 %*% post_intPCTT_smoke_gam.cov %*% t(lpmat_smoke50))), 
                             sqrt(diag(lpmat_smoke25 %*% post_intPCTT_smoke_gam.cov %*% t(lpmat_smoke25))), 
                             sqrt(diag(lpmat_smoke75 %*% post_intPCTT_smoke_gam.cov %*% t(lpmat_smoke75)))
                             ), 
                      stringsAsFactors = F)

post_smokerProfile <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                    geom_line()+
                    labs(y = "Percent Change")+
                    theme_bw()

legend_smokerProfile <- g_legend(post_smokerProfile)

post_smokerProfile.se <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                    geom_line()+
                    geom_line(aes(x=seconds, y = mean + 2*se, group = user, col = user),
                              linetype = "longdash")+
                    geom_line(aes(x=seconds, y = mean - 2*se, group = user, col = user),
                              linetype = "longdash")+
                    labs(y = "")+
                    theme_bw()

# jpeg(file.path(res_folder, "RightEye_AverageTrajectories_SmokersPostConsumptionTimetoTest.jpg"),
#      height = 6, width = 23, res = 300, units = "in")
          
post_smokerTraj <- grid.arrange(arrangeGrob(post_smokerProfile+theme(legend.position = "none"), 
                                          post_smokerProfile.se+theme(legend.position = "none"), nrow = 1), 
                              legend_smokerProfile, nrow = 1, 
                              widths = c(30, 6))

# dev.off()
post_smokerTraj
```

### ONLY smokers
```{r post_gam_intPCTT_ONLYsmokers}
### Subset to only smokers and remove previously calculated "Phi" values
post_intPCTT_smoke.gam.df <- post_intPCTT_smoke.gam.df[post_intPCTT_smoke.gam.df$smoker == 1, ] 
keep.vars <- names(post_intPCTT_smoke.gam.df)[grepl("Phi", names(post_intPCTT_smoke.gam.df)) == FALSE]
post_intPCTT_smoke.gam.df <- post_intPCTT_smoke.gam.df[, keep.vars]

post_intPCTT_smoke.gam.df <- post_intPCTT_smoke.gam.df[!(is.na(post_intPCTT_smoke.gam.df$sind)), ]

# head(right_0.gam.df)

m.post_intPCTT_smoke_gam <- mgcv::bam(percent_change ~ s(sind, k=30, bs="cr") +
                                  s(sind, by=postConsumpTimeToTest_c, k=30, bs = "cr"), 
                                data = post_intPCTT_smoke.gam.df, method = "REML")
summary(m.post_intPCTT_smoke_gam)

## Create a matrix of residuals
post_intPCTT_smoke_gam.resid <- cbind(post_intPCTT_smoke.gam.df[!(is.na(post_intPCTT_smoke.gam.df$percent_change)), 
                                       c("subject_id", "frame")],
                                m.post_intPCTT_smoke_gam$residuals)
names(post_intPCTT_smoke_gam.resid) <- c("subject_id", "frame", "resid")
# post_gam.resid$frame_char <- str_pad(post_gam.resid$frame, width = 3, side = "left", pad = "0")

resid_mat <- reshape(post_intPCTT_smoke_gam.resid[, c("subject_id", "frame", "resid")], 
                     timevar = "frame", 
                     idvar = "subject_id", 
                     direction = "wide")
rownames(resid_mat) <- resid_mat$subject_id
resid_mat$subject_id <- NULL
# resid_names <- names(resid_mat)
# resid_names <- sort(resid_names)
# resid_mat <- resid_mat[, resid_names]

resid_mat <- as.matrix(resid_mat)

post_intPCTT_smoke_gam.fpca <- fpca.face(resid_mat, knots = 15)

#Create data frame of eigen functions and attach to original data
Phi_mat <- as.data.frame(post_intPCTT_smoke_gam.fpca$efunctions)
colnames(Phi_mat) <- paste0("Phi", seq(1, post_intPCTT_smoke_gam.fpca$npc))
Phi_mat$frame <- as.numeric(rownames(Phi_mat)) -1

post_intPCTT_smoke.gam.df <- merge(post_intPCTT_smoke.gam.df, Phi_mat, 
                        by = "frame", 
                        all.x = T)

post_intPCTT_smoke.gam.df <- post_intPCTT_smoke.gam.df[order(post_intPCTT_smoke.gam.df$subject_id,
                                                             post_intPCTT_smoke.gam.df$frame), ]
post_intPCTT_smoke.gam.df$subject_id <- as.factor(post_intPCTT_smoke.gam.df$subject_id)

post_intPCTT_smoke.gam.fri <- mgcv::bam(percent_change ~ 
                            s(sind, k=30, bs="cr") +
                            s(sind, by=postConsumpTimeToTest_c, k=30, bs = "cr") +
                            s(subject_id, by = Phi1, bs="re") + s(subject_id, by = Phi2, bs="re")+
                            s(subject_id, by = Phi3, bs="re") + s(subject_id, by = Phi4, bs="re"), 
                          method = "fREML", data = post_intPCTT_smoke.gam.df, discrete = TRUE)


summary(post_intPCTT_smoke.gam.fri)
```

## Trajectories for smokers with different PCTT and non-smokers 
```{r post_OnlySmoke_PCTT_traj}
# create plot categories based on the 25th, 50th and 75th percentile
post_intPCTT_smoke_gam.coef <- post_intPCTT_smoke.gam.fri$coefficients
post_intPCTT_smoke_gam.cov <- vcov.gam(post_intPCTT_smoke.gam.fri)

### -- Smoker with median PCTT
df_pred_smoke50 <- data.frame("sind" = unique(post_intPCTT_smoke.gam.df$sind), 
                          "postConsumpTimeToTest_c" = plot_cat[2], 
                          "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, "Phi4" = 0, 
                          "subject_id" = post_intPCTT_smoke.gam.df$subject_id[1])

lpmat_smoke50 <- predict(post_intPCTT_smoke.gam.fri, newdata=df_pred_smoke50, se.fit=TRUE, type = "lpmatrix")

### -- Smoker with 25th%-ile PCTT
df_pred_smoke25 <- data.frame("sind" = unique(post_intPCTT_smoke.gam.df$sind), 
                          "postConsumpTimeToTest_c" = plot_cat[1], 
                          "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, "Phi4" = 0, 
                          "subject_id" = post_intPCTT_smoke.gam.df$subject_id[1])

lpmat_smoke25 <- predict(post_intPCTT_smoke.gam.fri, newdata=df_pred_smoke25, se.fit=TRUE, type = "lpmatrix")


### -- Smoker with 75th%-ile PCTT
df_pred_smoke75 <- data.frame("sind" = unique(post_intPCTT_smoke.gam.df$sind), 
                          "postConsumpTimeToTest_c" = plot_cat[3], 
                          "Phi1" = 0, "Phi2" = 0, "Phi3" = 0, "Phi4" = 0, 
                          "subject_id" = post_intPCTT_smoke.gam.df$subject_id[1])

lpmat_smoke75 <- predict(post_intPCTT_smoke.gam.fri, newdata=df_pred_smoke75, se.fit=TRUE, type = "lpmatrix")


pred_df <- data.frame(seconds = rep(seq(0, 400), 3)/30,
                      user = c(rep("smoker-62", 401), 
                               rep("smoker-59", 401), 
                               rep("smoker-65", 401)
                               ), 
                      mean = c(lpmat_smoke50 %*% post_intPCTT_smoke_gam.coef, 
                               lpmat_smoke25 %*% post_intPCTT_smoke_gam.coef,
                               lpmat_smoke75 %*% post_intPCTT_smoke_gam.coef
                               ), 
                      se = c(sqrt(diag(lpmat_smoke50 %*% post_intPCTT_smoke_gam.cov %*% t(lpmat_smoke50))), 
                             sqrt(diag(lpmat_smoke25 %*% post_intPCTT_smoke_gam.cov %*% t(lpmat_smoke25))), 
                             sqrt(diag(lpmat_smoke75 %*% post_intPCTT_smoke_gam.cov %*% t(lpmat_smoke75)))
                             ), 
                      stringsAsFactors = F)

post_smokerProfile <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                    geom_line()+
                    labs(y = "Percent Change")+
                    theme_bw()

legend_smokerProfile <- g_legend(post_smokerProfile)

post_smokerProfile.se <- ggplot(data = pred_df, aes(x = seconds, y = mean, group = user, col = user))+
                    geom_line()+
                    geom_line(aes(x=seconds, y = mean + 2*se, group = user, col = user),
                              linetype = "longdash")+
                    geom_line(aes(x=seconds, y = mean - 2*se, group = user, col = user),
                              linetype = "longdash")+
                    labs(y = "")+
                    theme_bw()
                    
post_OnlysmokerTraj <- grid.arrange(arrangeGrob(post_smokerProfile+theme(legend.position = "none"), 
                                          post_smokerProfile.se+theme(legend.position = "none"), nrow = 1), 
                              legend_smokerProfile, nrow = 1, 
                              widths = c(30, 6))
```
